<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <title>veDOLO Holders — Berachain Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* ===== DESIGN TOKENS (Dolomite-inspired) ===== */
        :root {
            --bg-base: #090910;
            --bg-surface: #111119;
            --bg-card: #15151f;
            --bg-card-alt: #1a1a26;
            --bg-hover: #1e1e2c;
            --bg-input: #12121c;

            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(99, 102, 241, 0.5);

            --text-primary: #f0f0f6;
            --text-secondary: #8b8fa3;
            --text-muted: #555770;

            --accent-indigo: #6366f1;
            --accent-blue: #3b82f6;
            --accent-cyan: #22d3ee;
            --accent-green: #34d399;
            --accent-amber: #fbbf24;
            --accent-rose: #fb7185;
            --accent-orange: #fb923c;

            --gradient-brand: linear-gradient(135deg, #6366f1 0%, #22d3ee 100%);
            --gradient-warm: linear-gradient(135deg, #fbbf24 0%, #fb7185 100%);
            --gradient-success: linear-gradient(135deg, #34d399 0%, #22d3ee 100%);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;

            --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--border-subtle);
            --shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.4);

            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== RESET ===== */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
        }

        /* ===== LAYOUT ===== */
        .page-wrapper {
            max-width: 1320px;
            margin: 0 auto;
            padding: 32px 24px 64px;
        }

        /* ===== HEADER ===== */
        .site-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 28px 0 0;
            margin-bottom: 32px;
        }

        .header-top-logo {
            margin-bottom: 20px;
        }

        .header-top-logo img {
            height: 80px;
            width: auto;
            object-fit: contain;
        }

        .header-nav-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(12px);
        }

        .nav-tabs {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            padding: 3px;
        }

        .nav-tab {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 8px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            text-decoration: none;
            transition: all var(--transition);
            cursor: pointer;
            border: none;
            background: transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--accent-cyan);
            background: rgba(51, 65, 85, 0.4);
            font-size: 15px;
        }

        .nav-tab:hover img {
            transform: scale(1.25);
        }

        .nav-tab.active {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.15);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.1);
        }

        #tab-earn.active {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.15) 0%, rgba(34, 211, 238, 0.15) 100%);
            color: #34d399;
            box-shadow: 0 0 12px rgba(52, 211, 153, 0.15);
        }

        .nav-tab img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            transition: transform 0.2s;
        }

        .nav-tab svg {
            width: 16px;
            height: 16px;
        }

        .nav-tab-icon {
            padding: 8px 10px;
            gap: 0;
        }

        .nav-divider {
            width: 1px;
            height: 24px;
            background: var(--border-subtle);
            margin: 0 6px;
            flex-shrink: 0;
        }

        .nav-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-subtle);
            white-space: nowrap;
        }

        .nav-badge .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: livePulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes livePulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.4);
            }

            50% {
                opacity: 0.7;
                box-shadow: 0 0 0 4px rgba(52, 211, 153, 0);
            }
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            text-decoration: none;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .nav-link svg {
            width: 12px;
            height: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 16px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            border: none;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
        }

        .btn-ghost:hover {
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.15);
            background: var(--bg-hover);
        }

        .btn-primary {
            background: var(--accent-indigo);
            color: white;
        }

        .btn-primary:hover {
            background: #5558e6;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.25);
        }

        .btn svg {
            width: 14px;
            height: 14px;
        }

        /* ===== METRIC STRIP ===== */
        .metrics-strip {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: 28px;
            position: relative;
        }

        /* veDOLO view has 4 metrics → 2×2 grid */
        #view-vedolo .metrics-strip {
            grid-template-columns: repeat(2, 1fr);
        }

        .metric-cell {
            background: var(--bg-card);
            padding: 22px 24px;
            transition: background var(--transition);
            position: relative;
            overflow: visible;
        }

        .metric-cell:hover {
            background: var(--bg-hover);
        }

        /* Round corners on edge cells — works for any row count in a 3-col grid */
        .metric-cell:first-child {
            border-radius: var(--radius-lg) 0 0 0;
        }

        .metric-cell:nth-child(3) {
            border-radius: 0 var(--radius-lg) 0 0;
        }

        /* Bottom-left: first cell in the last row (every 3n+1 that's within the last 3) */
        .metric-cell:nth-child(3n+1):nth-last-child(-n+3) {
            border-radius: 0 0 0 var(--radius-lg);
        }

        /* Bottom-right: last child if it completes row, or last in last row */
        .metric-cell:last-child {
            border-radius: 0 0 var(--radius-lg) 0;
        }

        /* If first-child is also last row, merge both bottom corners */
        .metric-cell:first-child:nth-last-child(-n+3) {
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        }

        /* veDOLO 2×2 grid: proper corner rounding */
        #view-vedolo .metric-cell:first-child {
            border-radius: var(--radius-lg) 0 0 0;
        }

        #view-vedolo .metric-cell:nth-child(2) {
            border-radius: 0 var(--radius-lg) 0 0;
        }

        #view-vedolo .metric-cell:nth-child(3) {
            border-radius: 0 0 0 var(--radius-lg);
        }

        #view-vedolo .metric-cell:nth-child(4) {
            border-radius: 0 0 var(--radius-lg) 0;
        }

        /* ===== EARLY EXIT CARD ===== */
        .early-exit-card {
            background: var(--bg-card);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius-lg);
            margin-bottom: 28px;
            overflow: visible;
            position: relative;
        }

        .early-exit-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-bottom: 1px solid rgba(239, 68, 68, 0.15);
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.10) 0%, rgba(239, 68, 68, 0.03) 100%);
        }

        .early-exit-header h3 {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1.2px;
            color: #fca5a5;
            text-transform: uppercase;
            margin: 0;
        }

        .early-exit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: rgba(239, 68, 68, 0.08);
        }

        .early-exit-cell {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.06) 0%, rgba(239, 68, 68, 0.02) 100%);
            padding: 22px 24px;
            display: flex;
            flex-direction: column;
            transition: background var(--transition);
            position: relative;
            overflow: visible;
        }

        .early-exit-cell:hover {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.14) 0%, rgba(239, 68, 68, 0.06) 100%);
        }

        .early-exit-cell .metric-value {
            margin-bottom: 4px;
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1.1;
            transition: transform 0.2s ease, text-shadow 0.25s ease;
            display: inline-block;
            cursor: default;
            transform-origin: left center;
        }

        .early-exit-cell:hover .metric-value {
            transform: scale(1.15);
            transform-origin: left center;
        }

        .early-exit-cell:hover .metric-value[style*="color:#ef4444"] {
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .early-exit-cell:hover .metric-value[style*="color:#f97316"] {
            text-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
        }

        /* Push the bar section to the bottom of the cell */
        .exit-bar-section {
            margin-top: auto;
        }

        .exit-bar-track {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 3px;
            overflow: hidden;
        }

        .exit-bar-sub {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        @media (max-width: 550px) {
            .early-exit-grid {
                grid-template-columns: 1fr 1fr;
            }

            .early-exit-cell:last-child {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 480px) {
            .early-exit-grid {
                grid-template-columns: 1fr;
            }

            .early-exit-cell:last-child {
                grid-column: auto;
            }

            .early-exit-cell .metric-value {
                font-size: 18px;
            }
        }

        /* Penalty breakdown bar */
        .penalty-bar {
            display: flex;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            gap: 2px;
        }

        .penalty-bar-burn {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            border-radius: 3px 0 0 3px;
            transition: width 1s ease-out;
        }

        .penalty-bar-recoup {
            background: linear-gradient(90deg, #f97316, #ea580c);
            border-radius: 0 3px 3px 0;
            transition: width 1s ease-out;
        }

        .penalty-bar-legend {
            display: flex;
            gap: 12px;
            margin-top: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .penalty-bar-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .penalty-bar-legend .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .dot-burn {
            background: #ef4444;
        }

        .dot-recoup {
            background: #f97316;
        }

        /* Exit ratio fill */
        .exit-ratio-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f97316);
            border-radius: 3px;
            transition: width 1s ease-out;
        }

        /* Avg penalty gauge fill */
        .penalty-gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #f97316, #ef4444);
            border-radius: 3px;
            transition: width 1s ease-out;
        }

        .metric-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1.1;
            transition: transform 0.2s ease, text-shadow 0.25s ease;
            display: inline-block;
            cursor: default;
        }

        .metric-cell:hover .metric-value {
            transform: scale(1.15);
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .metric-icon {
            width: 22px;
            height: 22px;
            vertical-align: middle;
            margin: -3px 4px 0 4px;
            display: inline-block;
        }

        .metric-cell:hover .metric-value.accent-green {
            text-shadow: 0 0 20px rgba(52, 211, 153, 0.4);
        }

        .metric-cell:hover .metric-value[style*="color:#f59e0b"],
        .metric-cell:hover .metric-value.accent-amber {
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        /* oDOLO metric color classes */
        .metric-value.amber {
            color: var(--accent-amber);
        }

        .metric-value.green {
            color: var(--accent-green);
        }

        .metric-value.indigo {
            color: var(--accent-indigo);
        }

        .metric-value.rose {
            color: var(--accent-rose);
        }

        .metric-value.cyan {
            color: var(--accent-cyan);
        }

        .metric-value.orange {
            color: var(--accent-orange);
        }

        .metric-cell:hover .metric-value.amber {
            text-shadow: 0 0 20px rgba(255, 164, 6, 0.4);
        }

        .metric-cell:hover .metric-value.green {
            text-shadow: 0 0 20px rgba(52, 211, 153, 0.4);
        }

        .metric-cell:hover .metric-value.indigo {
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        .metric-cell:hover .metric-value.cyan {
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
        }

        .metric-cell:hover .metric-value.orange {
            text-shadow: 0 0 20px rgba(251, 146, 60, 0.4);
        }

        .metric-cell:hover .metric-value.rose {
            text-shadow: 0 0 20px rgba(251, 113, 133, 0.4);
        }

        .metric-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ===== METRIC TOOLTIPS ===== */
        .tooltip-wrap {
            position: relative;
            cursor: help;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid var(--text-muted);
            font-size: 10px;
            font-style: normal;
            letter-spacing: 0;
            text-transform: none;
            color: var(--text-muted);
            cursor: help;
            position: relative;
            flex-shrink: 0;
            transition: all var(--transition);
        }

        .tooltip-icon:hover {
            border-color: var(--accent-indigo);
            color: var(--accent-indigo);
        }

        .tooltip-bubble {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 400;
            color: #e2e8f0;
            width: 260px;
            z-index: 9999;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.5;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Ensure tooltip parents don't clip the tooltip */
        .tooltip-wrap,
        .tooltip-icon {
            position: relative;
        }

        .metric-cell {
            position: relative;
            overflow: visible !important;
        }

        .metric-label {
            position: relative;
            overflow: visible;
        }

        /* Prevent tooltip from going off-screen on left-edge cells */
        .early-exit-cell .tooltip-bubble {
            left: 0;
            transform: none;
        }

        .early-exit-cell .tooltip-bubble::after {
            left: 20px;
            transform: none;
        }

        /* oDOLO left-column tooltip — prevent clipping off-screen left */
        #view-odolo .metrics-strip .metric-cell:nth-child(3n+1) .tooltip-bubble {
            left: 0;
            transform: none;
        }

        #view-odolo .metrics-strip .metric-cell:nth-child(3n+1) .tooltip-bubble::after {
            left: 20px;
            transform: none;
        }

        /* oDOLO right-column tooltip — prevent clipping off-screen right */
        #view-odolo .metrics-strip .metric-cell:nth-child(3n) .tooltip-bubble {
            left: auto;
            right: 0;
            transform: none;
        }

        #view-odolo .metrics-strip .metric-cell:nth-child(3n) .tooltip-bubble::after {
            left: auto;
            right: 20px;
            transform: none;
        }

        .tooltip-bubble::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(99, 102, 241, 0.3);
        }

        .tooltip-icon:hover .tooltip-bubble,
        .tooltip-wrap:hover .tooltip-bubble {
            display: block;
        }

        .metric-value.accent-green {
            color: var(--accent-green);
        }

        .metric-value.accent-amber {
            color: var(--accent-amber);
        }

        /* ===== ANALYTICS GRID ===== */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 28px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-badge {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.04);
            padding: 4px 10px;
            border-radius: 100px;
        }

        /* ===== PROTOCOL INFO ===== */
        .protocol-info-card {
            padding: 0;
        }

        .protocol-info-card .card-header {
            margin-bottom: 0;
            padding: 24px 24px 16px;
        }

        .protocol-links-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0 24px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .protocol-link-pill {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 8px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.25s ease;
            letter-spacing: 0.2px;
        }

        .protocol-link-pill:hover {
            border-color: var(--accent-indigo);
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.08);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .protocol-link-pill svg {
            flex-shrink: 0;
            opacity: 0.65;
        }

        .protocol-link-pill:hover svg {
            opacity: 1;
        }

        .protocol-contracts {
            padding: 0;
        }

        .protocol-addr-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .protocol-addr-row:last-child {
            border-bottom: none;
        }

        .protocol-addr-row:hover {
            transform: scale(1.012);
            z-index: 1;
        }

        /* Token-specific accent colors */
        .protocol-addr-row[data-token="dolo"] {
            border-left-color: rgba(99, 102, 241, 0.5);
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.04) 0%, transparent 40%);
        }

        .protocol-addr-row[data-token="dolo"]:hover {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.08) 0%, rgba(99, 102, 241, 0.02) 60%);
        }

        .protocol-addr-row[data-token="odolo"] {
            border-left-color: rgba(245, 158, 11, 0.5);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.04) 0%, transparent 40%);
        }

        .protocol-addr-row[data-token="odolo"]:hover {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.02) 60%);
        }

        .protocol-addr-row[data-token="vedolo"] {
            border-left-color: rgba(34, 211, 238, 0.5);
            background: linear-gradient(90deg, rgba(34, 211, 238, 0.04) 0%, transparent 40%);
        }

        .protocol-addr-row[data-token="vedolo"]:hover {
            background: linear-gradient(90deg, rgba(34, 211, 238, 0.08) 0%, rgba(34, 211, 238, 0.02) 60%);
        }

        .protocol-addr-token {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 110px;
            flex-shrink: 0;
        }

        .protocol-addr-token img {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .protocol-addr-token span {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .protocol-addr-chain {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .protocol-addr-chain img {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .protocol-addr-value {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }

        .protocol-addr-value a {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .protocol-addr-row:hover .protocol-addr-value a {
            color: #22d3ee;
        }

        .protocol-addr-copy {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            background: none;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
            padding: 0;
            flex-shrink: 0;
            margin-left: -2px;
        }

        .protocol-addr-copy:hover {
            color: var(--text-primary);
            border-color: var(--border-default);
            background: var(--bg-input);
        }

        @media (max-width: 600px) {
            .protocol-info-card .card-header {
                padding: 16px 16px 12px;
            }

            .protocol-links-row {
                padding: 0 16px 16px;
                gap: 6px;
            }

            .protocol-link-pill {
                padding: 6px 10px;
                font-size: 12px;
                gap: 5px;
            }

            .protocol-addr-row {
                padding: 10px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .protocol-addr-token {
                min-width: 90px;
            }

            .protocol-addr-value a {
                font-size: 11px;
            }
        }

        /* Distribution bars */
        .dist-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dist-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dist-item .label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 48px;
            text-align: right;
        }

        .dist-item .track {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            overflow: hidden;
        }

        .dist-item .fill {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .dist-item .fill span {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
        }

        .dist-item {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .dist-item:hover {
            transform: translateX(4px);
        }

        .dist-item:hover .fill {
            filter: brightness(1.3);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.2);
        }

        .dist-tooltip {
            position: absolute;
            display: none;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            color: #e2e8f0;
            z-index: 200;
            pointer-events: none;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
        }

        .expiry-tooltip {
            position: fixed;
            display: none;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            color: #e2e8f0;
            z-index: 300;
            pointer-events: none;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            transform: translate(-50%, -100%);
            text-align: center;
            line-height: 1.4;
        }

        /* Donut */
        .donut-layout {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 28px;
        }

        .donut-svg {
            width: 170px;
            height: 170px;
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .legend-swatch {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .legend-row {
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .legend-row:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .donut-tooltip {
            position: fixed;
            display: none;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 13px;
            color: #e2e8f0;
            z-index: 200;
            pointer-events: none;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
        }

        /* ===== TABLE SECTION ===== */
        .table-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .table-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input-wrapper svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 10px 14px 10px 36px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            outline: none;
            transition: all var(--transition);
        }

        .search-input-wrapper input::placeholder {
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
        }

        .search-input-wrapper input:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.08);
        }

        .filter-dropdown {
            padding: 10px 32px 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23555770' viewBox='0 0 16 16'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: all var(--transition);
        }

        .filter-dropdown:focus {
            border-color: var(--border-focus);
        }

        .toolbar-count {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            padding: 0 8px;
        }

        /* Table */
        .table-scroll {
            overflow-x: auto;
            max-height: 68vh;
            overflow-y: auto;
            border-radius: 12px 12px 0 0;
        }

        .exerciser-row {
            cursor: pointer;
            transition: background var(--transition);
        }

        .exerciser-row:hover {
            background: rgba(99, 102, 241, 0.06);
        }

        .exerciser-row:hover td,
        .exerciser-row:hover td span,
        .exerciser-row:hover td .addr-link,
        .exerciser-row:hover td a:not(.debank-icon) {
            font-size: 15px !important;
        }

        .exerciser-row.expanded {
            background: rgba(99, 102, 241, 0.1);
        }

        .detail-row td {
            padding: 0 !important;
            background: var(--bg-base);
        }

        .detail-row td>div,
        .detail-row td>table {
            padding: 16px 20px;
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .detail-addr {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-indigo);
            text-decoration: none;
        }

        .detail-addr:hover {
            text-decoration: underline;
        }

        .detail-summary {
            font-size: 12px;
            color: var(--text-muted);
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .detail-table th {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-subtle);
            text-align: left;
            font-weight: 600;
        }

        .detail-table td {
            padding: 6px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            color: var(--text-secondary);
        }


        .tx-link {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--accent-cyan);
            text-decoration: none;
        }

        .tx-link:hover {
            text-decoration: underline;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead tr {
            border-radius: 12px 12px 0 0;
        }

        thead th:first-child {
            border-radius: 12px 0 0 0;
        }

        thead th:last-child {
            border-radius: 0 12px 0 0;
        }

        thead th {
            background: var(--bg-surface);
            padding: 11px 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.7px;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            user-select: none;
            transition: color var(--transition);
            white-space: nowrap;
        }

        thead th:hover {
            color: var(--text-secondary);
        }

        thead th.sorted {
            color: var(--accent-indigo);
        }

        thead th .arrow {
            margin-left: 3px;
            font-size: 9px;
            opacity: 0.4;
        }

        thead th.sorted .arrow {
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid var(--border-subtle);
            transition: background var(--transition);
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.06);
        }

        tbody tr:hover td,
        tbody tr:hover td span,
        tbody tr:hover td .mini-bar span,
        tbody tr:hover td .addr-link,
        tbody tr:hover td a:not(.debank-icon) {
            color: var(--accent-cyan) !important;
            font-size: 14px;
        }

        tbody tr:hover td .tokens-truncated {
            color: #ffffff !important;
            font-size: 14px;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody td {
            padding: 10px 20px;
            font-size: 13px;
            vertical-align: middle;
        }

        /* Column specific */
        .c-rank {
            width: 28px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--text-muted);
            text-align: center;
            padding: 10px 0 10px 4px !important;
        }

        .c-rank .rank-cell-inner {
            justify-content: center;
        }

        .c-addr {
            padding-left: 10px !important;
        }

        thead th:first-child {
            padding: 11px 0 11px 4px !important;
            width: 28px;
            border-radius: 12px 0 0 0;
        }

        thead th:last-child {
            border-radius: 0 12px 0 0;
        }

        thead th:nth-child(2) {
            padding-left: 10px !important;
        }

        .rank-cell-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .rank-medal {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 800;
            flex-shrink: 0;
        }

        .rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a1a2e;
        }

        .rank-2 {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            color: #1a1a2e;
        }

        .rank-3 {
            background: linear-gradient(135deg, #d97706, #92400e);
            color: #fef3c7;
        }

        .rank-plain {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            min-width: 28px;
            font-size: 12px;
            font-weight: 600;
        }

        .c-addr {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .c-addr a {
            color: var(--text-primary);
            text-decoration: none;
            transition: color var(--transition);
        }

        .c-addr a:hover {
            color: var(--accent-cyan);
        }

        .addr-link {
            color: var(--text-primary);
            cursor: pointer;
            transition: color var(--transition);
        }

        .addr-link:hover {
            color: var(--accent-cyan);
        }

        .c-nft {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .mini-bar {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .mini-bar-track {
            width: 56px;
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: background 0.2s;
        }

        .mini-bar-fill.purple {
            background: var(--accent-indigo);
        }

        .mini-bar-fill.green {
            background: var(--accent-green);
        }

        .c-dolo {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            color: var(--accent-green);
        }

        .c-tokens {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            max-width: 360px;
        }

        .tokens-truncated {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: default;
            transition: color var(--transition);
        }

        .tokens-truncated:hover {
            color: var(--text-secondary);
        }

        /* Pagination */
        .table-footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 14px 20px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-surface);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .pg-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .pg-btn:hover:not(:disabled) {
            border-color: var(--accent-indigo);
            color: var(--text-primary);
        }

        .pg-btn.active {
            background: var(--accent-indigo);
            border-color: var(--accent-indigo);
            color: white;
        }

        .pg-btn:disabled {
            opacity: 0.25;
            cursor: not-allowed;
        }

        .pg-info {
            font-size: 12px;
            color: var(--text-muted);
            padding: 0 6px;
        }

        /* ===== FOOTER ===== */
        .site-footer {
            text-align: center;
            padding: 32px 0 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .site-footer a {
            color: var(--accent-indigo);
            text-decoration: none;
        }

        .site-footer a:hover {
            text-decoration: underline;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(16px);
            background: var(--accent-indigo);
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.14);
        }

        /* ===== PROFILE MODAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s, visibility 0.25s;
            padding: 24px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px) scale(0.97);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }

        .modal-overlay.active .modal-card {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .modal-rank {
            font-size: 13px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
            flex-shrink: 0;
        }

        .modal-addr {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all var(--transition);
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border-subtle);
        }

        .modal-stat {
            background: var(--bg-surface);
            padding: 24px;
            text-align: center;
        }

        .modal-stat-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .modal-stat-value {
            font-size: 28px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .modal-stat-value.orange {
            color: #f59e0b;
        }

        .modal-stat-value.green {
            color: var(--accent-green);
        }

        .modal-stat-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .modal-body {
            overflow-y: auto;
            padding: 20px 24px;
            flex: 1;
        }

        .modal-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 14px;
        }

        .lock-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            align-items: center;
            transition: border-color var(--transition), transform 0.2s, box-shadow 0.2s;
        }

        .lock-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.1);
        }

        .lock-card-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .lock-card-title {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .lock-card-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .lock-card-value.sm {
            font-size: 15px;
        }

        .lock-card-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .lock-card-vote {
            text-align: right;
        }

        .lock-card-vote .lock-card-value {
            color: #f59e0b;
        }

        .lock-multiplier {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .modal-links {
            display: flex;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .modal-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition);
        }

        .modal-link:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: rgba(99, 102, 241, 0.3);
        }

        @media (max-width: 600px) {
            .modal-overlay {
                padding: 10px;
            }

            .modal-card {
                max-height: 94vh;
            }

            .modal-header {
                padding: 14px 16px;
            }

            .modal-rank {
                font-size: 12px;
                padding: 3px 8px;
            }

            .modal-addr {
                font-size: 12px;
                word-break: break-all;
            }

            .modal-close {
                font-size: 20px;
            }

            .modal-stat {
                padding: 14px 10px;
            }

            .modal-stat-label {
                font-size: 9px;
                letter-spacing: 0.4px;
            }

            .modal-stat-value {
                font-size: 16px;
            }

            .modal-stat-sub {
                font-size: 10px;
            }

            .modal-body {
                padding: 12px 0;
            }

            .modal-section-title {
                font-size: 13px;
                padding: 0 14px;
            }

            /* Exercise History table — horizontal scroll */
            #em-txs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 4px;
            }

            #em-txs .detail-table {
                min-width: 520px;
                font-size: 11px;
            }

            #em-txs .detail-table tbody tr:hover {
                background: rgba(34, 211, 238, 0.08) !important;
            }

            #em-txs .detail-table tbody tr:hover td {
                color: var(--accent-cyan);
            }

            #em-txs .detail-table th {
                font-size: 9px;
                padding: 5px 6px;
                white-space: nowrap;
            }

            #em-txs .detail-table td {
                padding: 5px 6px;
                font-size: 11px;
            }

            .lock-card {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 14px 16px;
            }

            .lock-card-value {
                font-size: 16px;
            }

            .lock-card-value.sm {
                font-size: 14px;
            }

            .lock-card-vote {
                text-align: left;
            }

            .modal-links {
                flex-direction: column;
                padding: 12px 16px;
                gap: 8px;
            }

            .modal-link {
                justify-content: center;
                padding: 10px 14px;
                font-size: 13px;
            }
        }

        /* ===== WHALE GRADIENT ROWS ===== */
        tr.whale-row {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.06) 0%, transparent 60%);
        }

        tr.whale-row:hover {
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.12) 0%, rgba(255, 255, 255, 0.03) 60%) !important;
        }

        .whale-badge {
            display: inline-flex;
            align-items: center;
            font-size: 8px;
            font-weight: 700;
            color: #fbbf24;
            margin-left: 4px;
        }

        /* ===== ADDRESS LABELS ===== */
        .addr-label {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 4px;
            margin-left: 6px;
            vertical-align: middle;
        }

        .addr-label.contract {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .addr-label.multisig {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
        }

        .addr-label.team {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .addr-label.dead {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .debank-icon {
            display: inline-flex;
            align-items: center;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
            vertical-align: middle;
        }

        .debank-icon:hover {
            opacity: 1;
            transform: scale(1.6);
        }

        .debank-icon img {
            border-radius: 3px;
        }

        .copy-addr-icon {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            opacity: 0.35;
            color: #9ca3af;
            transition: opacity 0.2s, transform 0.2s, color 0.2s;
            vertical-align: middle;
        }

        .copy-addr-icon:hover {
            opacity: 1;
            color: #ffffff;
            transform: scale(1.4);
        }

        .copy-addr-icon.copied {
            opacity: 1;
            color: #34d399;
            transform: scale(1.4);
        }

        /* DOLO holder address styling */
        .dolo-holder-addr {
            color: #fff;
            text-decoration: none;
            transition: color 0.2s;
        }

        .dolo-holder-addr:hover {
            color: #22d3ee;
        }

        /* ===== SUPPLY % IN TABLE ===== */
        .supply-pct {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        /* ===== LOCK PROGRESS BAR ===== */
        .lock-progress {
            margin-top: 6px;
            height: 4px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 2px;
            overflow: hidden;
        }

        .lock-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s;
        }

        .lock-progress-fill.active {
            background: linear-gradient(90deg, #6366f1, #818cf8);
        }

        .lock-progress-fill.expiring {
            background: linear-gradient(90deg, #f59e0b, #f97316);
        }

        .lock-progress-fill.expired {
            background: #ef4444;
        }

        /* ===== LOCK SORT CONTROLS ===== */
        .lock-sort-bar {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .lock-sort-btn {
            font-size: 11px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
        }

        .lock-sort-btn:hover {
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        .lock-sort-btn.active {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
            border-color: rgba(99, 102, 241, 0.3);
        }

        /* ===== EXPIRY TIMELINE ===== */
        .expiry-chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 28px;
            position: relative;
        }

        .expiry-chart-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .expiry-canvas {
            width: 100%;
            min-width: 600px;
            height: 260px;
        }

        /* ===== COMPARE TOOL ===== */
        .compare-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .compare-bar.hidden {
            display: none;
        }

        .compare-count {
            font-size: 12px;
            font-weight: 600;
            color: #818cf8;
        }

        .compare-btn {
            margin-left: auto;
            font-size: 12px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
            background: #6366f1;
            color: white;
            cursor: pointer;
            transition: all var(--transition);
        }

        .compare-btn:hover {
            background: #4f46e5;
        }

        .compare-clear {
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            border: none;
            background: none;
            padding: 4px 8px;
        }

        .compare-clear:hover {
            color: var(--text-primary);
        }

        .compare-checkbox {
            width: 14px;
            height: 14px;
            accent-color: #6366f1;
            cursor: pointer;
            flex-shrink: 0;
        }

        .compare-modal .modal-card {
            max-width: 1100px;
        }

        .compare-grid {
            display: grid;
            gap: 1px;
            background: var(--border-subtle);
        }

        .compare-col {
            background: var(--bg-card);
            padding: 16px;
        }

        .compare-col-header {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            word-break: break-all;
        }

        .compare-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .compare-metric:last-child {
            border-bottom: none;
        }

        .compare-metric-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .compare-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ===== HISTORICAL CHART ===== */
        .historical-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 28px;
        }

        .historical-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 160px;
            color: var(--text-muted);
            gap: 8px;
        }

        .historical-placeholder svg {
            opacity: 0.3;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .metrics-strip {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .page-wrapper {
                padding: 16px 14px 48px;
            }

            .site-header {
                padding: 20px 0 0;
                gap: 12px;
            }

            .header-top-logo img {
                height: 50px;
            }

            .header-nav-bar {
                flex-direction: column;
                gap: 10px;
                padding: 10px 12px;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }

            .nav-tab {
                padding: 7px 12px;
                font-size: 12px;
            }

            .nav-divider {
                display: none;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .header-actions .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .metrics-strip {
                grid-template-columns: 1fr 1fr;
                border-radius: var(--radius-md);
            }

            .metric-cell {
                padding: 16px;
            }

            .metric-cell:first-child {
                border-radius: var(--radius-md) 0 0 0;
            }

            .metric-cell:nth-child(2) {
                border-radius: 0 var(--radius-md) 0 0;
            }

            .metric-cell:nth-child(3),
            .metric-cell:nth-child(4) {
                border-radius: 0;
            }

            .metric-cell:nth-child(5) {
                border-radius: 0 0 0 var(--radius-md);
            }

            .metric-cell:nth-child(6) {
                border-radius: 0 0 var(--radius-md) 0;
            }

            /* veDOLO 2×2 corners at tablet */
            #view-vedolo .metric-cell:nth-child(3) {
                border-radius: 0 0 0 var(--radius-md);
            }

            #view-vedolo .metric-cell:nth-child(4) {
                border-radius: 0 0 var(--radius-md) 0;
            }

            .metric-value {
                font-size: 22px;
            }

            /* Early exit adjustments for tablet */
            .early-exit-cell {
                padding: 16px;
            }

            .early-exit-cell .metric-value {
                font-size: 22px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .table-toolbar {
                flex-wrap: wrap;
            }

            .donut-layout {
                flex-direction: column;
                gap: 20px;
            }

            .expiry-canvas {
                height: 240px;
                min-width: 500px;
            }

            .expiry-chart-card {
                padding: 16px;
                overflow: hidden;
            }

            /* When odd number of metric cells, last one spans full width */
            #view-odolo .metrics-strip .metric-cell:last-child:nth-child(odd) {
                grid-column: 1 / -1;
            }

            /* Horizontal scroll hint — right fade on tables */
            .table-scroll {
                position: relative;
            }

            .table-scroll::after {
                content: '';
                position: sticky;
                right: 0;
                top: 0;
                bottom: 0;
                width: 24px;
                pointer-events: none;
                background: linear-gradient(to right, transparent, rgba(10, 12, 20, 0.6));
                z-index: 2;
            }

            /* Chain summary — stack vertically on tablets */
            #dolo-chain-summary {
                flex-direction: column !important;
                gap: 4px !important;
            }

            /* TVL card header title */
            .card-header h3 {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .brand-text h1 {
                font-size: 17px;
            }

            /* Smaller logo on phones */
            .header-top-logo img {
                height: 40px;
            }

            .metric-value {
                font-size: 18px;
            }

            .metric-label {
                font-size: 9px;
                letter-spacing: 0.3px;
            }

            .metric-sub {
                font-size: 10px;
            }

            /* veDOLO: single column on phone */
            #view-vedolo .metrics-strip {
                grid-template-columns: 1fr;
            }

            #view-vedolo .metric-cell {
                border-radius: 0 !important;
            }

            #view-vedolo .metric-cell:first-child {
                border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
            }

            #view-vedolo .metric-cell:last-child {
                border-radius: 0 0 var(--radius-md) var(--radius-md) !important;
            }

            .early-exit-cell {
                padding: 14px 16px;
            }

            /* Stack search + filter vertically */
            .table-toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 12px 14px;
            }

            .filter-dropdown {
                width: 100%;
            }

            .toolbar-count {
                text-align: center;
            }

            /* Tighter table on mobile — will scroll horizontally */
            thead th {
                padding: 8px 8px;
                font-size: 10px;
                letter-spacing: 0.3px;
                white-space: nowrap;
            }

            tbody td {
                padding: 8px 8px;
                font-size: 12px;
            }

            /* Force table min-width so it scrolls horizontally instead of cramping */
            .table-scroll table {
                min-width: 580px;
            }

            /* DOLO holders table needs more width for 5 columns */
            #dolo-holders-table {
                min-width: 620px;
            }

            /* oDOLO exercisers table — wider for 6 columns */
            #exercisers-table {
                min-width: 660px;
            }

            /* Tighter address display on mobile */
            .addr-link,
            .c-addr a {
                font-size: 11px !important;
            }

            /* Keep address + icons on single row — prevent multi-line wrap */
            .c-addr span[style*="inline-flex"] {
                flex-wrap: nowrap !important;
            }

            /* Copy & DeBank icons smaller on mobile */
            .copy-addr-icon svg {
                width: 11px;
                height: 11px;
            }

            .debank-icon img {
                width: 12px !important;
                height: 12px !important;
            }

            /* Stack chain summary items vertically */
            #dolo-chain-summary {
                gap: 2px !important;
                font-size: 12px;
            }

            #dolo-chain-summary>span {
                font-size: 12px !important;
            }

            /* Protocol info — stack address pills */
            .card div[style*="flex-wrap"] {
                flex-direction: column !important;
                gap: 6px !important;
            }

            /* Disable hover font-size effects on touch — no hover on phones */
            tbody tr:hover td,
            tbody tr:hover td span,
            tbody tr:hover td .addr-link,
            tbody tr:hover td a:not(.debank-icon) {
                font-size: inherit !important;
            }

            .exerciser-row:hover td,
            .exerciser-row:hover td span,
            .exerciser-row:hover td .addr-link,
            .exerciser-row:hover td a:not(.debank-icon) {
                font-size: inherit !important;
            }

            /* Nav tab smaller */
            .nav-tab {
                padding: 6px 10px;
                font-size: 11px;
                gap: 5px;
            }

            .nav-tab img {
                width: 14px;
                height: 14px;
            }

            /* Disable tab hover font increase on touch */
            .nav-tab:hover {
                font-size: 11px;
            }

            .nav-tab:hover img {
                transform: none;
            }

            /* Lock Expiry chart scroll */
            .expiry-canvas {
                min-width: 450px;
                height: 200px;
            }

            /* Page wrapper tighter padding */
            .page-wrapper {
                padding: 12px 8px 40px;
            }
        }

        /* ===== VIEW SECTIONS ===== */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* ===== oDOLO SPECIFIC STYLES ===== */
        .odolo-analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .odolo-donut-layout {
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .odolo-donut-container {
            position: relative;
            width: 250px;
            height: 250px;
            flex-shrink: 0;
            overflow: visible;
            padding: 15px;
        }

        .odolo-donut-canvas {
            width: 100%;
            height: 100%;
        }

        .odolo-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .odolo-donut-center-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .odolo-donut-center-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .odolo-donut-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .odolo-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            white-space: nowrap;
        }

        .odolo-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .odolo-legend-label {
            color: var(--text-secondary);
        }

        .odolo-legend-value {
            margin-left: auto;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .odolo-info-box {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 20px 24px;
            margin-bottom: 16px;
        }

        .odolo-info-box-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-amber);
            margin-bottom: 8px;
        }

        .odolo-info-box p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .odolo-flow-steps {
            display: flex;
            align-items: flex-start;
            gap: 0;
            overflow: visible;
            padding: 12px 0;
        }

        .odolo-flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            min-width: 100px;
        }

        .odolo-flow-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            border: 2px solid;
            cursor: help;
            transition: all var(--transition);
        }

        .odolo-flow-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 0 16px rgba(255, 255, 255, 0.15);
        }

        .odolo-flow-icon-wrap {
            position: relative;
            display: inline-flex;
        }

        .odolo-flow-icon-wrap .odolo-flow-tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            z-index: 100;
            background: #1e1e2e;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
        }

        .odolo-flow-step:last-child .odolo-flow-icon-wrap .odolo-flow-tooltip {
            left: auto;
            right: 0;
            transform: none;
        }

        .odolo-flow-step:first-child .odolo-flow-icon-wrap .odolo-flow-tooltip {
            left: 0;
            transform: none;
        }

        .odolo-flow-icon-wrap:hover .odolo-flow-tooltip,
        .odolo-flow-icon-wrap.active .odolo-flow-tooltip {
            display: block;
        }

        .odolo-flow-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
        }

        .odolo-flow-desc {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            max-width: 100px;
        }

        .odolo-flow-arrow {
            font-size: 20px;
            color: var(--text-muted);
            flex-shrink: 0;
            padding: 0 8px;
            margin-top: 14px;
        }

        .odolo-loading-shimmer {
            background: linear-gradient(90deg, var(--bg-surface) 0%, var(--bg-hover) 50%, var(--bg-surface) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            display: inline-block;
            width: 120px;
            height: 28px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* oDOLO responsive */
        @media (max-width: 768px) {
            .odolo-analytics-grid {
                grid-template-columns: 1fr;
            }

            .odolo-donut-layout {
                flex-direction: column;
                gap: 20px;
            }

            .odolo-flow-steps {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
                justify-items: center;
            }

            .odolo-flow-arrow {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .odolo-donut-container {
                width: 220px;
                height: 220px;
                margin: 0 auto;
                padding: 25px;
            }

            /* Stack flow steps into single column on phones */
            .odolo-flow-steps {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .odolo-flow-step {
                padding: 14px 12px !important;
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .anim {
            animation: fadeUp 0.45s ease-out both;
        }

        .anim-d1 {
            animation-delay: 0.05s;
        }

        .anim-d2 {
            animation-delay: 0.1s;
        }

        .anim-d3 {
            animation-delay: 0.15s;
        }

        .anim-d4 {
            animation-delay: 0.2s;
        }

        /* DOLO range buttons */
        .dolo-range-btn {
            padding: 4px 10px;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dolo-range-btn:hover {
            border-color: var(--accent-indigo);
            color: var(--text-primary);
        }

        .dolo-range-btn.active {
            background: var(--accent-indigo);
            border-color: var(--accent-indigo);
            color: #fff;
        }

        /* Brush handle hover effects */
        #dolo-brush-handle-left:hover,
        #dolo-brush-handle-right:hover {
            background: rgba(99, 102, 241, 0.15) !important;
        }

        #dolo-brush-window:hover {
            background: rgba(99, 102, 241, 0.08) !important;
        }

        #dolo-brush-window:active {
            cursor: grabbing !important;
        }

        /* Pulsing live dot on chart */
        @keyframes tvlPulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* TVL change badge */
        .tvl-change-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }

        .tvl-change-badge.positive {
            background: rgba(52, 211, 153, 0.12);
            color: var(--accent-green);
        }

        .tvl-change-badge.negative {
            background: rgba(251, 113, 133, 0.12);
            color: var(--accent-rose);
        }

        /* Enhanced TVL tooltip */
        .tvl-tooltip-enhanced {
            position: absolute;
            display: none;
            background: rgba(15, 23, 42, 0.88);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(99, 102, 241, 0.35);
            border-radius: 10px;
            padding: 10px 14px;
            pointer-events: none;
            font-size: 12px;
            z-index: 10;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            min-width: 140px;
        }

        /* Chain toggle switches (ETH/BERA columns) */
        .chain-toggle {
            position: relative;
            display: inline-block;
            width: 28px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .chain-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .chain-toggle-slider {
            position: absolute;
            inset: 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.25s ease;
        }

        .chain-toggle-slider::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #555;
            transition: all 0.25s ease;
        }

        .chain-toggle input:checked+.chain-toggle-slider.eth {
            background: rgba(98, 126, 234, 0.35);
        }

        .chain-toggle input:checked+.chain-toggle-slider.eth::before {
            transform: translateX(12px);
            background: #627EEA;
            box-shadow: 0 0 6px rgba(98, 126, 234, 0.5);
        }

        .chain-toggle input:checked+.chain-toggle-slider.bera {
            background: rgba(212, 168, 67, 0.35);
        }

        .chain-toggle input:checked+.chain-toggle-slider.bera::before {
            transform: translateX(12px);
            background: #D4A843;
            box-shadow: 0 0 6px rgba(212, 168, 67, 0.5);
        }

        /* ===== MOBILE RESPONSIVENESS — DOLO TAB & GLOBAL ===== */
        @media (max-width: 768px) {

            /* Prevent horizontal overflow globally */
            html,
            body {
                overflow-x: hidden;
            }

            /* DOLO analytics grid — stack on mobile */
            #view-dolo .analytics-grid {
                grid-template-columns: 1fr !important;
            }

            /* TVL History card header — wrap title + range buttons */
            .card-header {
                flex-wrap: wrap;
                gap: 8px;
            }

            /* Range buttons smaller on mobile */
            .dolo-range-btn {
                padding: 3px 7px;
                font-size: 10px;
            }

            /* Brush navigator — less left padding for smaller screens */
            #dolo-brush-wrap {
                padding-left: 8px !important;
            }

            #dolo-brush-overlay {
                left: 8px !important;
            }

            /* Pagination — wrap buttons */
            .table-footer {
                flex-wrap: wrap;
                gap: 4px;
                padding: 10px 12px;
            }

            .pg-btn {
                padding: 5px 9px;
                font-size: 11px;
            }

            /* Cards — reduced padding */
            .card {
                border-radius: var(--radius-md);
            }
        }

        @media (max-width: 480px) {

            /* Range buttons even smaller */
            .dolo-range-btn {
                padding: 3px 6px;
                font-size: 9px;
            }

            /* Protocol Info — stack address pills vertically */
            #dolo-contracts div[style*="flex-wrap"] {
                flex-direction: column !important;
            }

            /* Card headers */
            .card-header h3 {
                font-size: 16px;
            }

            /* Pagination — tighter */
            .table-footer {
                gap: 3px;
                padding: 8px 8px;
            }

            .pg-btn {
                padding: 4px 7px;
                font-size: 10px;
                min-width: 28px;
            }

            /* Pagination — larger tap area on phones */
            .table-footer {
                gap: 4px;
                padding: 10px 8px;
                justify-content: center;
            }

            .pg-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 32px;
                min-height: 32px;
            }

            /* Rank column tight on mobile */
            .c-rank {
                width: 32px;
            }

            .rank-medal,
            .rank-plain {
                width: 24px;
                height: 24px;
                min-width: 24px;
                min-height: 24px;
                font-size: 11px;
                border-radius: 6px;
            }
        }

        /* ===== EARN TAB STYLES ===== */
        .earn-hero {
            text-align: center;
            margin-bottom: 32px;
        }

        .earn-hero h2 {
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .earn-hero p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .earn-input-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 28px 32px;
            margin-bottom: 28px;
            position: relative;
            z-index: 100;
            overflow: visible;
        }

        .earn-input-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-success);
            opacity: 0.6;
        }

        .earn-input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .earn-input-wrapper {
            flex: 1;
            position: relative;
        }

        .earn-input-wrapper svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .earn-input {
            width: 100%;
            padding: 14px 18px 14px 44px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            outline: none;
            transition: all var(--transition);
        }

        .earn-input::placeholder {
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
        }

        .earn-input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.1);
        }

        .earn-search-btn {
            padding: 14px 24px;
            background: var(--gradient-success);
            border: none;
            border-radius: var(--radius-md);
            color: #0a0a14;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .earn-search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(52, 211, 153, 0.3);
        }

        .earn-search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .earn-search-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(10, 10, 20, 0.3);
            border-top-color: #0a0a14;
            border-radius: 50%;
            animation: earnSpin 0.6s linear infinite;
            display: none;
        }

        .earn-search-btn.loading .spinner {
            display: inline-block;
        }

        .earn-search-btn.loading .btn-text {
            display: none;
        }

        @keyframes earnSpin {
            to {
                transform: rotate(360deg);
            }
        }

        .earn-error {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            margin-bottom: 20px;
            color: #fca5a5;
            font-size: 13px;
            display: none;
        }

        .earn-error.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .earn-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
            display: none;
        }

        .earn-empty.visible {
            display: block;
        }

        .earn-empty svg {
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .earn-empty h3 {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .earn-empty p {
            font-size: 13px;
        }

        /* Period selector */
        .earn-period-bar {
            display: none;
            justify-content: center;
            gap: 4px;
            margin-bottom: 16px;
            animation: earnFadeIn 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .earn-period-bar.visible {
            display: flex;
        }

        .earn-period-btn {
            padding: 6px 14px;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .earn-period-btn:hover {
            color: var(--text-secondary);
            border-color: rgba(52, 211, 153, 0.3);
            background: rgba(52, 211, 153, 0.05);
        }

        .earn-period-btn.active {
            color: #34d399;
            border-color: rgba(52, 211, 153, 0.5);
            background: rgba(52, 211, 153, 0.1);
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.1);
        }

        /* Calendar date picker modal */
        .earn-custom-date-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            animation: earnFadeIn 0.2s ease;
        }

        .earn-custom-date-overlay.visible {
            display: flex;
        }

        .earn-custom-date-modal {
            background: var(--bg-card);
            border: 1px solid rgba(52, 211, 153, 0.2);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 340px;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5), 0 0 40px rgba(52, 211, 153, 0.06);
            animation: earnFadeIn 0.3s ease;
        }

        .earn-cal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .earn-cal-header h4 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .earn-cal-header h4 svg {
            width: 18px;
            height: 18px;
            color: #34d399;
        }

        .earn-cal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.15s;
        }

        .earn-cal-close:hover {
            color: var(--text-primary);
        }

        .earn-cal-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .earn-cal-nav button {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .earn-cal-nav button:hover {
            background: rgba(52, 211, 153, 0.1);
            border-color: rgba(52, 211, 153, 0.3);
            color: #34d399;
        }

        .earn-cal-month-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .earn-cal-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .earn-cal-weekdays span {
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 0;
        }

        .earn-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .earn-cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            cursor: default;
            transition: all 0.15s;
            font-family: 'Inter', sans-serif;
            position: relative;
        }

        .earn-cal-day.empty {
            visibility: hidden;
        }

        .earn-cal-day.other-month {
            opacity: 0.2;
        }

        .earn-cal-day.available {
            color: #34d399;
            background: rgba(52, 211, 153, 0.08);
            border-color: rgba(52, 211, 153, 0.15);
            cursor: pointer;
            font-weight: 600;
        }

        .earn-cal-day.available:hover {
            background: rgba(52, 211, 153, 0.2);
            border-color: rgba(52, 211, 153, 0.4);
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(52, 211, 153, 0.15);
        }

        .earn-cal-day.available.selected {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.3), rgba(34, 211, 238, 0.25));
            border-color: #34d399;
            color: #fff;
            box-shadow: 0 0 16px rgba(52, 211, 153, 0.25);
        }

        .earn-cal-day.today {
            box-shadow: inset 0 0 0 2px rgba(52, 211, 153, 0.4);
            color: var(--text-primary);
            font-weight: 700;
        }

        .earn-cal-day.future {
            opacity: 0.15;
        }

        .earn-cal-day .earn-cal-dot {
            position: absolute;
            bottom: 3px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #34d399;
        }

        .earn-cal-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 12px;
            text-align: center;
        }

        .earn-cal-hint .earn-cal-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 6px;
        }

        .earn-cal-hint .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
        }

        .earn-cal-hint .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 3px;
        }

        .earn-cal-hint .legend-dot.available {
            background: rgba(52, 211, 153, 0.3);
            border: 1px solid rgba(52, 211, 153, 0.5);
        }

        .earn-cal-hint .legend-dot.today-dot {
            background: transparent;
            border: 2px solid rgba(52, 211, 153, 0.4);
        }

        .earn-date-apply {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(34, 211, 238, 0.2));
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3) !important;
        }

        .earn-date-apply:hover {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.3), rgba(34, 211, 238, 0.3));
            box-shadow: 0 0 16px rgba(52, 211, 153, 0.15);
        }

        @keyframes earnFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Asset table */
        .earn-results {
            display: none;
            position: relative;
            z-index: 1;
        }

        .earn-results.visible {
            display: block;
            animation: earnFadeIn 0.4s ease;
        }

        .earn-asset-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }

        .earn-asset-table thead th {
            background: rgba(15, 23, 42, 0.8);
            padding: 14px 24px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            text-align: left;
            border-bottom: 1px solid rgba(52, 211, 153, 0.15);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 2;
            backdrop-filter: blur(12px);
        }

        .earn-asset-table thead th:first-child {
            border-radius: 12px 0 0 0;
            padding-left: 52px !important;
            letter-spacing: 0.8px;
        }

        /* Earn header tooltip — reuses global .tooltip-icon + .tooltip-bubble */
        .earn-asset-table thead th .tooltip-icon {
            margin-left: 5px;
            vertical-align: middle;
        }

        .earn-asset-table thead th .tooltip-bubble {
            left: auto;
            right: -10px;
            transform: none;
            width: 260px;
            max-width: 80vw;
            white-space: normal;
        }

        .earn-asset-table thead th .tooltip-bubble::after {
            left: auto;
            right: 20px;
            transform: none;
        }

        .earn-asset-table thead th:last-child {
            border-radius: 0 12px 0 0;
            text-align: right;
            padding-right: 28px;
        }

        .earn-asset-table thead th:nth-child(2),
        .earn-asset-table thead th:nth-child(3) {
            text-align: right;
        }

        .earn-asset-table thead th[data-sort] {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .earn-asset-table thead th[data-sort]:hover {
            color: #34d399;
        }

        .earn-asset-table thead th[data-sort] .earn-sort-arrow {
            display: inline-block;
            margin-left: 4px;
            font-size: 8px;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .earn-asset-table thead th[data-sort].sort-active .earn-sort-arrow {
            opacity: 1;
            color: #34d399;
        }



        .earn-asset-table tbody td {
            padding: 18px 24px;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .earn-asset-table tbody td:first-child {
            padding-left: 28px;
        }

        .earn-asset-table tbody td:last-child {
            text-align: right;
            padding-right: 28px;
        }

        .earn-asset-table tbody td:nth-child(2),
        .earn-asset-table tbody td:nth-child(3),
        .earn-asset-table tbody td:nth-child(4) {
            text-align: right;
        }

        .earn-asset-table tbody tr.earn-data-row {
            transition: all 0.25s ease;
            position: relative;
            cursor: pointer;
        }

        .earn-asset-table tbody tr.earn-data-row:hover {
            background: rgba(52, 211, 153, 0.04);
        }

        .earn-asset-table tbody tr.earn-data-row:hover td {
            border-bottom-color: rgba(52, 211, 153, 0.1);
        }

        .earn-asset-table tbody tr.earn-data-row:hover .earn-amount {
            transform: scale(1.06);
            display: inline-block;
        }

        .earn-asset-table tbody tr.earn-data-row:last-of-type td {
            border-bottom: none;
        }

        /* Staggered row entrance */
        .earn-asset-table tbody tr.earn-data-row {
            animation: earnRowSlideIn 0.5s ease both;
        }

        @keyframes earnRowSlideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .earn-token-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }

        .earn-token-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .earn-token-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(99, 102, 241, 0.15));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid rgba(52, 211, 153, 0.2);
            transition: all 0.3s ease;
        }

        .earn-asset-table tbody tr.earn-data-row:hover .earn-token-icon {
            border-color: rgba(52, 211, 153, 0.5);
            box-shadow: 0 0 12px rgba(52, 211, 153, 0.2);
        }

        .earn-token-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .earn-token-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .earn-token-name {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }

        .earn-token-sub {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .earn-token-addr {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.6;
        }

        /* Chevron indicator on main row */
        .earn-row-chevron {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            vertical-align: middle;
            opacity: 0.3;
            transition: all 0.25s ease;
        }

        .earn-data-row:hover .earn-row-chevron {
            opacity: 0.7;
        }

        .earn-data-row.expanded .earn-row-chevron {
            opacity: 1;
            transform: rotate(180deg);
        }

        /* Expandable detail row */
        .earn-detail-row {
            display: none;
        }

        .earn-detail-row.open {
            display: table-row;
            animation: earnDetailSlide 0.25s ease;
        }

        @keyframes earnDetailSlide {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .earn-detail-row td {
            padding: 6px 28px 12px 28px !important;
            border-bottom: 1px solid rgba(52, 211, 153, 0.06) !important;
            text-align: left !important;
        }

        .earn-detail-row td:first-child {
            padding-left: 28px !important;
        }

        .earn-ca-line {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .earn-ca-addr {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s;
        }

        .earn-ca-addr:hover {
            color: #fff;
        }

        .earn-ca-explorer {
            display: inline-flex;
            align-items: center;
            color: #9ca3af;
            opacity: 0.5;
            transition: opacity 0.2s, color 0.2s, transform 0.2s;
            text-decoration: none;
            cursor: pointer;
        }

        .earn-ca-explorer:hover {
            opacity: 1;
            color: #34d399;
            transform: scale(1.25);
        }

        .earn-ca-explorer svg {
            width: 14px;
            height: 14px;
        }

        /* Source breakdown in detail row */
        .earn-breakdown {
            margin-top: 10px;
            padding: 10px 0 2px 0;
            border-top: 1px solid rgba(52, 211, 153, 0.06);
        }

        .earn-breakdown-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .earn-breakdown-bar {
            display: flex;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.04);
            margin-bottom: 8px;
        }

        .earn-breakdown-seg {
            min-width: 2px;
            transition: width 0.4s ease;
        }

        .earn-seg-d {
            background: #34d399;
        }

        .earn-seg-w {
            background: #f87171;
        }

        .earn-seg-s {
            background: #60a5fa;
        }

        .earn-seg-x {
            background: #a78bfa;
        }

        .earn-seg-l {
            background: #fbbf24;
        }

        .earn-breakdown-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 16px;
        }

        .earn-breakdown-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #9ca3af;
        }

        .earn-breakdown-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .earn-breakdown-label {
            opacity: 0.7;
        }

        .earn-breakdown-val {
            font-family: 'JetBrains Mono', monospace;
            color: #d1d5db;
        }

        /* Premium APY Pill/Card */
        .earn-apy-pill {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 8px 14px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.08), rgba(52, 211, 153, 0.03));
            border: 1px solid rgba(52, 211, 153, 0.15);
            min-width: 90px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .earn-apy-pill::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 10px;
            background: radial-gradient(ellipse at 50% 0%, rgba(52, 211, 153, 0.08) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .earn-data-row:hover .earn-apy-pill {
            border-color: rgba(52, 211, 153, 0.3);
            box-shadow: 0 0 16px rgba(52, 211, 153, 0.1);
        }

        .earn-data-row:hover .earn-apy-pill::before {
            opacity: 1;
        }

        .earn-apy-pill-label {
            font-size: 9px;
            font-weight: 700;
            color: rgba(52, 211, 153, 0.6);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            line-height: 1;
        }

        .earn-apy-pill-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .earn-apy-pill-meta {
            font-size: 9px;
            font-weight: 500;
            color: var(--text-muted);
            opacity: 0.6;
            line-height: 1;
            margin-top: 1px;
        }

        .earn-apy-pill-none {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 8px 14px;
            min-width: 90px;
        }

        .earn-apy-pill-none .earn-apy-pill-label {
            color: var(--text-muted);
            opacity: 0.4;
        }

        .earn-apy-pill-none .earn-apy-pill-value {
            color: var(--text-muted);
            opacity: 0.3;
            font-size: 14px;
        }

        .earn-amount {
            font-family: 'JetBrains Mono', monospace;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .earn-amount-primary {
            color: var(--text-primary);
            font-weight: 600;
        }

        .earn-amount-sym {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 4px;
        }

        .earn-yield-positive {
            color: var(--accent-green);
            font-weight: 600;
        }

        .earn-yield-negative {
            color: var(--accent-rose);
            font-weight: 600;
        }

        .earn-yield-since {
            display: block;
            font-size: 10px;
            font-weight: 400;
            color: var(--text-muted);
            margin-top: 2px;
            letter-spacing: 0.3px;
        }

        .earn-yield-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .earn-yield-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 5px 14px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.3px;
        }

        .earn-yield-badge.positive {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(16, 185, 129, 0.08));
            color: var(--accent-green);
            border: 1px solid rgba(52, 211, 153, 0.2);
        }

        .earn-yield-badge.negative {
            background: linear-gradient(135deg, rgba(251, 113, 133, 0.15), rgba(244, 63, 94, 0.08));
            color: var(--accent-rose);
            border: 1px solid rgba(251, 113, 133, 0.2);
        }

        .earn-yield-bar {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 2px;
            overflow: hidden;
        }

        .earn-yield-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .earn-yield-bar-fill.positive {
            background: linear-gradient(90deg, rgba(52, 211, 153, 0.3), var(--accent-green));
        }

        .earn-yield-bar-fill.negative {
            background: linear-gradient(90deg, rgba(251, 113, 133, 0.3), var(--accent-rose));
        }

        /* EARN total footer row */
        .earn-asset-table tfoot td {
            padding: 18px 24px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            border-top: 2px solid transparent;
            border-image: var(--gradient-success) 1;
            background: rgba(52, 211, 153, 0.03);
        }

        .earn-asset-table tfoot td:first-child {
            padding-left: 28px;
        }

        .earn-asset-table tfoot td:last-child {
            text-align: right;
            padding-right: 28px;
        }

        .earn-asset-table tfoot td:nth-child(2),
        .earn-asset-table tfoot td:nth-child(3),
        .earn-asset-table tfoot td:nth-child(4) {
            text-align: right;
        }

        /* Table wrapper card */
        .earn-results .table-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            overflow: visible;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(52, 211, 153, 0.05);
        }

        .earn-asset-table thead {
            position: relative;
            z-index: 10;
            overflow: visible;
        }

        .earn-asset-table thead th {
            overflow: visible;
        }


        /* Account sub-select */
        .earn-account-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .earn-account-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .earn-account-select {
            padding: 6px 28px 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23555770' viewBox='0 0 16 16'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }

        /* Custom chain selector with logos */
        .earn-chain-dropdown {
            position: relative;
            display: inline-block;
            z-index: 100;
        }

        .earn-chain-trigger {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 30px 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            white-space: nowrap;
        }

        .earn-chain-trigger::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-muted);
            transition: transform 0.2s ease;
        }

        .earn-chain-dropdown.open .earn-chain-trigger::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .earn-chain-trigger:hover {
            border-color: var(--accent-green);
        }

        .earn-chain-trigger img {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .earn-chain-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            min-width: 180px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 4px;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(99, 102, 241, 0.08);
        }

        .earn-chain-dropdown.open .earn-chain-menu {
            display: block;
            animation: earnDropIn 0.2s ease;
        }

        @keyframes earnDropIn {
            from {
                opacity: 0;
                transform: translateY(-6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .earn-chain-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .earn-chain-option:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
        }

        .earn-chain-option.active {
            background: rgba(52, 211, 153, 0.1);
            color: var(--accent-green);
        }

        .earn-chain-option img {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .earn-chain-option .chain-text-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            flex-shrink: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .earn-input-row {
                flex-direction: column;
            }

            .earn-search-btn {
                width: 100%;
                justify-content: center;
            }

            .earn-input-card {
                padding: 20px 16px;
            }

            #view-earn .metrics-strip {
                grid-template-columns: 1fr;
            }

            .earn-asset-table {
                font-size: 12px;
            }

            .earn-asset-table thead th,
            .earn-asset-table tbody td,
            .earn-asset-table tfoot td {
                padding: 10px 12px;
            }
        }

        @media (max-width: 480px) {
            .earn-hero h2 {
                font-size: 22px;
            }

            .earn-token-addr {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="page-wrapper">

        <!-- HEADER -->
        <header class="site-header anim">
            <div class="header-top-logo">
                <a href="https://dolomite.io/" target="_blank"><img src="dolomite-logo.svg" alt="Dolomite"></a>
            </div>
            <nav class="header-nav-bar">
                <div class="nav-tabs">
                    <button class="nav-tab active" id="tab-dolo" onclick="switchView('dolo')">
                        <img src="dolo-logo.svg" alt="DOLO">
                        DOLO
                    </button>
                    <button class="nav-tab" id="tab-odolo" onclick="switchView('odolo')">
                        <img src="odolo-logo-official.svg" alt="oDOLO">
                        oDOLO
                    </button>
                    <button class="nav-tab" id="tab-vedolo" onclick="switchView('vedolo')">
                        <img src="vedolo-logo.svg" alt="veDOLO">
                        veDOLO
                    </button>
                    <button class="nav-tab" id="tab-earn" onclick="switchView('earn')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                        </svg>
                        EARN
                    </button>
                </div>
            </nav>
        </header>

        <!-- veDOLO VIEW -->
        <div id="view-vedolo" class="view-section">

            <!-- METRICS -->
            <div class="metrics-strip anim anim-d1">
                <div class="metric-cell">
                    <div class="metric-label">Unique Holders
                        <span class="tooltip-icon">?
                            <span class="tooltip-bubble">Number of unique wallet addresses holding at least one veDOLO
                                NFT
                                position.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="m-holders">—</div>
                </div>

                <div class="metric-cell">
                    <div class="metric-label">Active
                        <span class="tooltip-icon">?
                            <span class="tooltip-bubble">Currently active veDOLO positions — Total Minted minus Burned.
                                These are in circulation.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="m-active">—</div>
                    <div class="metric-sub">in circulation</div>
                </div>

                <div class="metric-cell">
                    <div class="metric-label">DOLO Locked (veDOLO)
                        <span class="tooltip-icon">?
                            <span class="tooltip-bubble">Total amount of DOLO locked across all active veDOLO positions.
                                Locked DOLO earns governance power.</span>
                        </span>
                    </div>
                    <div class="metric-value accent-green" id="m-dolo">—</div>
                    <div class="metric-sub">total in lock</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">Vote Weight
                        <span class="tooltip-icon">?
                            <span class="tooltip-bubble">Combined voting power across all veDOLO holders. Longer lock =
                                more
                                vote weight per DOLO locked.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="m-vote" style="color:#f59e0b">—</div>
                    <div class="metric-sub">total veDOLO power</div>
                </div>
            </div>

            <!-- EARLY EXITS -->
            <div class="early-exit-card anim anim-d1">
                <div class="early-exit-header">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fca5a5" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    <h3>Early Exits</h3>
                </div>
                <div class="early-exit-grid">
                    <div class="early-exit-cell">
                        <div class="metric-label">Total Penalty
                            <span class="tooltip-icon">?
                                <span class="tooltip-bubble">Total DOLO lost by users who exited veDOLO before lock
                                    maturity.
                                    Penalty = 5% burn fee + variable recoup fee (up to 50%, decreasing linearly to 0% at
                                    maturity).</span>
                            </span>
                        </div>
                        <div class="metric-value" id="m-penalty" style="color:#ef4444">—</div>
                        <div class="exit-bar-section">
                            <div class="exit-bar-track">
                                <div class="penalty-bar" id="penalty-bar">
                                    <div class="penalty-bar-burn" id="penalty-bar-burn" style="width:0%"></div>
                                    <div class="penalty-bar-recoup" id="penalty-bar-recoup" style="width:0%"></div>
                                </div>
                            </div>
                            <div class="penalty-bar-legend" id="penalty-bar-legend">
                                <span><span class="dot dot-burn"></span> <span id="m-burn-label">Burned</span></span>
                                <span><span class="dot dot-recoup"></span> <span
                                        id="m-recoup-label">Recouped</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="early-exit-cell">
                        <div class="metric-label">Early Exits
                            <span class="tooltip-icon">?
                                <span class="tooltip-bubble">Number of veDOLO positions withdrawn before lock expiry,
                                    out of all withdrawals.</span>
                            </span>
                        </div>
                        <div class="metric-value" id="m-exits">—</div>
                        <div class="exit-bar-section">
                            <div class="exit-bar-track">
                                <div class="exit-ratio-fill" id="exit-ratio-fill" style="width:0%"></div>
                            </div>
                            <div class="exit-bar-sub" id="m-exits-sub"></div>
                        </div>
                    </div>
                    <div class="early-exit-cell">
                        <div class="metric-label">Avg Penalty
                            <span class="tooltip-icon">?
                                <span class="tooltip-bubble">Average penalty percentage across all early exits.
                                    Max is ~55% (5% burn + 50% recoup for a fresh 2-year lock).</span>
                            </span>
                        </div>
                        <div class="metric-value" id="m-avg-penalty" style="color:#f97316">—</div>
                        <div class="exit-bar-section">
                            <div class="exit-bar-track">
                                <div class="penalty-gauge-fill" id="penalty-gauge-fill" style="width:0%"></div>
                            </div>
                            <div class="exit-bar-sub" id="m-avg-penalty-sub"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHARTS -->
            <div class="analytics-grid anim anim-d2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Holder Distribution</div>

                    </div>
                    <div class="dist-stack" id="dist-bars"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">NFT Share by Wallet</div>

                    </div>
                    <div class="donut-layout">
                        <svg class="donut-svg" viewBox="0 0 42 42" id="donut-chart"></svg>
                        <div class="donut-legend" id="donut-legend"></div>
                    </div>
                </div>
            </div>

            <!-- EXPIRY TIMELINE -->
            <div class="expiry-chart-card anim anim-d2" id="expiry-section">
                <div class="card-header">
                    <div class="card-title">Lock Expiry Timeline</div>

                </div>
                <div class="expiry-chart-scroll" style="position:relative">
                    <canvas class="expiry-canvas" id="expiry-canvas"></canvas>
                </div>
            </div>



            <!-- TABLE -->
            <div class="card anim anim-d3">
                <div class="card-header">
                    <h3 style="display:flex;align-items:center;gap:8px"><img src="vedolo-logo.svg" width="22"
                            height="22" alt="veDOLO" style="flex-shrink:0"> veDOLO Holders</h3>
                </div>
                <div class="table-toolbar">
                    <div class="search-input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                        <input type="text" id="search" placeholder="Search address 0x… or token ID">
                    </div>
                    <select class="filter-dropdown" id="filter-nft">
                        <option value="all">All</option>
                        <option value="100+">100+ NFT</option>
                        <option value="50-100">50–100 NFT</option>
                        <option value="26-50">26–50 NFT</option>
                        <option value="11-25">11–25 NFT</option>
                        <option value="6-10">6–10 NFT</option>
                        <option value="2-5">2–5 NFT</option>
                        <option value="1">1 NFT</option>
                    </select>
                    <div class="toolbar-count" id="results-count"></div>
                </div>

                <div class="table-scroll">
                    <table style="table-layout:fixed;width:100%">
                        <colgroup>
                            <col style="width:28px">
                            <col style="width:calc((100% - 28px) * 0.25)">
                            <col style="width:calc((100% - 28px) * 0.15)">
                            <col style="width:calc((100% - 28px) * 0.20)">
                            <col style="width:calc((100% - 28px) * 0.20)">
                            <col style="width:calc((100% - 28px) * 0.20)">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="c-rank sorted" data-sort="rank" onclick="sortTable('rank')">
                                    # <span class="arrow">▲</span>
                                </th>
                                <th data-sort="address" onclick="sortTable('address')">
                                    Address <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="nft_count" onclick="sortTable('nft_count')">
                                    NFT <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="total_dolo" onclick="sortTable('total_dolo')">
                                    DOLO 🔒 <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="total_vote_weight" onclick="sortTable('total_vote_weight')">
                                    Vote Weight <span class="arrow">⇅</span>
                                </th>
                                <th>Token IDs</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div class="table-footer" id="pagination"></div>
            </div>

            <!-- Protocol Info -->
            <div class="card anim anim-d4 protocol-info-card" style="margin-top:24px">
                <div class="card-header">
                    <h3>Protocol Info</h3>
                </div>
                <div class="protocol-links-row proto-links"></div>
                <div class="protocol-contracts proto-contracts"></div>
            </div>

        </div><!-- /view-vedolo -->

        <!-- oDOLO VIEW -->
        <div id="view-odolo" class="view-section">

            <!-- oDOLO METRICS -->
            <div class="metrics-strip anim anim-d1">
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            TOTAL SUPPLY
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">Total number of oDOLO tokens ever minted by the protocol. This
                                is the maximum possible supply.</span>
                        </span>
                    </div>
                    <div class="metric-value amber" id="o-m-supply"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub">oDOLO minted</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            HOLDERS
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">Number of unique wallet addresses currently holding oDOLO
                                tokens.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="o-m-holders"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub">unique wallets</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            IN VESTER
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">oDOLO tokens are held in the Vester contract, awaiting
                                distribution.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="o-m-vester"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub" id="o-m-vester-pct">awaiting distribution</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            CURRENTLY VESTING
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">oDOLO that users have paired with DOLO and are actively
                                vesting. These are locked and in the process of converting to veDOLO.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="o-m-vesting"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub">paired with DOLO</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            EXERCISED
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">oDOLO that has been successfully exercised (redeemed) into
                                veDOLO. These tokens completed the full vesting cycle.</span>
                        </span>
                    </div>
                    <div class="metric-value green" id="o-m-exercised"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub">converted to veDOLO</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            EXERCISED VOLUME (USD)
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">Exact total USDC.e paid by users when exercising oDOLO into
                                veDOLO. Calculated from on-chain Transfer events for each exercise transaction. Updated
                                periodically.</span>
                        </span>
                    </div>
                    <div class="metric-value green" id="o-m-revenue"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub" id="o-m-revenue-sub">USDC.e paid for veDOLO</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            AVG veDOLO PRICE
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">Historical average USDC.e cost per veDOLO exercised.
                                Calculated as total USDC.e paid ÷ total oDOLO exercised across all time.
                                This can rise even when DOLO price drops, because earlier exercises at higher DOLO
                                prices
                                are baked into the cumulative average.</span>
                        </span>
                    </div>
                    <div class="metric-value" id="o-m-avg-price"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub">USDC.e per veDOLO</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            AVG LOCK DURATION
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">Average veDOLO lock duration chosen by users when exercising
                                oDOLO. Longer locks get bigger discounts (5% for 1 week up to 50% for 2 years).</span>
                        </span>
                    </div>
                    <div class="metric-value" id="o-m-avg-lock"><span class="odolo-loading-shimmer"></span></div>
                    <div class="metric-sub" id="o-m-avg-lock-sub">avg discount</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">
                        <span class="tooltip-wrap">
                            AVG DISCOUNT
                            <i class="tooltip-icon">?</i>
                            <span class="tooltip-bubble">Average discount received when exercising oDOLO into veDOLO.
                                Linear scale from 5% (1 week lock) to 50% (2 year lock).</span>
                        </span>
                    </div>
                    <div class="metric-value green" id="o-m-avg-discount"><span class="odolo-loading-shimmer"></span>
                    </div>
                    <div class="metric-sub">from veDOLO market price</div>
                </div>
            </div>

            <!-- oDOLO CHARTS -->
            <div class="odolo-analytics-grid anim anim-d2">
                <!-- DISTRIBUTION DONUT -->
                <div class="card">
                    <div class="card-title">oDOLO Distribution</div>
                    <div class="odolo-donut-layout">
                        <div class="odolo-donut-container" style="position:relative;">
                            <canvas class="odolo-donut-canvas" id="o-dist-donut"></canvas>
                            <div class="odolo-donut-center">
                                <div class="odolo-donut-center-value" id="o-donut-total">—</div>
                                <div class="odolo-donut-center-label">total oDOLO</div>
                            </div>
                            <div id="o-donut-tooltip" style="
                            display: none;
                            position: fixed;
                            pointer-events: none;
                            background: rgba(15, 23, 42, 0.95);
                            border: 1px solid rgba(99, 102, 241, 0.4);
                            border-radius: 8px;
                            padding: 10px 14px;
                            font-size: 13px;
                            color: #e2e8f0;
                            z-index: 200;
                            backdrop-filter: blur(8px);
                            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
                            white-space: nowrap;
                            transition: opacity 0.15s ease;
                        "></div>
                        </div>
                        <div class="odolo-donut-legend" id="o-dist-legend">
                            <!-- filled by JS -->
                        </div>
                    </div>
                </div>

                <!-- HOW IT WORKS -->
                <div class="card">
                    <div class="card-title">How oDOLO Works</div>
                    <div class="odolo-info-box">
                        <div class="odolo-info-box-title">⚡ Option Token Mechanics</div>
                        <p>oDOLO is an option token that lets you acquire veDOLO at a discount. Pair oDOLO + DOLO,
                            choose a lock duration (longer lock = bigger discount), then exercise to receive veDOLO.</p>
                        <p style="margin-top: 10px; color: var(--accent-amber); font-size: 12px;">⚠️ The discounted
                            veDOLO price is determined at execution (redemption time), not when pairing.</p>
                    </div>
                    <div class="odolo-flow-steps">
                        <div class="odolo-flow-step">
                            <div class="odolo-flow-icon-wrap">
                                <div class="odolo-flow-icon"
                                    style="border-color: var(--accent-amber); color: var(--accent-amber);">1</div>
                                <span class="tooltip-bubble odolo-flow-tooltip">You have 1 oDOLO — earn it via liquidity
                                    mining rewards on <a href="https://app.dolomite.io/earn" target="_blank"
                                        style="color: var(--accent-cyan); text-decoration: underline;">Dolomite Earn</a>
                                    or buy on the open market.</span>
                            </div>
                            <div class="odolo-flow-label">Have oDOLO</div>
                            <div class="odolo-flow-desc">(Earn or buy)</div>
                        </div>
                        <div class="odolo-flow-arrow">→</div>
                        <div class="odolo-flow-step">
                            <div class="odolo-flow-icon-wrap">
                                <div class="odolo-flow-icon"
                                    style="border-color: var(--accent-indigo); color: var(--accent-indigo);">2</div>
                                <span class="tooltip-bubble odolo-flow-tooltip">Pair 1 oDOLO with 1 DOLO to activate the
                                    discount. The DOLO is required to start the process.</span>
                            </div>
                            <div class="odolo-flow-label">Pair oDOLO + DOLO</div>
                            <div class="odolo-flow-desc">(Activate discount)</div>
                        </div>
                        <div class="odolo-flow-arrow">→</div>
                        <div class="odolo-flow-step">
                            <div class="odolo-flow-icon-wrap">
                                <div class="odolo-flow-icon"
                                    style="border-color: var(--accent-cyan); color: var(--accent-cyan);">3</div>
                                <span class="tooltip-bubble odolo-flow-tooltip">Wait 7 days cooldown. During this period
                                    your oDOLO + DOLO are locked and cannot be withdrawn.</span>
                            </div>
                            <div class="odolo-flow-label">Wait 7 Days</div>
                            <div class="odolo-flow-desc">(Cooldown period)</div>
                        </div>
                        <div class="odolo-flow-arrow">→</div>
                        <div class="odolo-flow-step">
                            <div class="odolo-flow-icon-wrap">
                                <div class="odolo-flow-icon"
                                    style="border-color: var(--accent-green); color: var(--accent-green);">4</div>
                                <span class="tooltip-bubble odolo-flow-tooltip">Redeem: buy 1 veDOLO at 50% off (max
                                    2-year lock), paid in USDC. oDOLO is burned, your DOLO is returned.</span>
                            </div>
                            <div class="odolo-flow-label">Redeem & Buy veDOLO</div>
                            <div class="odolo-flow-desc">(50% off DOLO price, 2y lock)</div>
                        </div>
                    </div>
                </div>
                <script>
                    // Click-to-toggle only for step 1 (has clickable link)
                    const firstWrap = document.querySelector('.odolo-flow-step:first-child .odolo-flow-icon-wrap');
                    if (firstWrap) {
                        firstWrap.style.cursor = 'pointer';
                        firstWrap.addEventListener('click', function (e) {
                            e.stopPropagation();
                            this.classList.toggle('active');
                        });
                    }
                    document.addEventListener('click', () => {
                        document.querySelectorAll('.odolo-flow-icon-wrap.active').forEach(w => w.classList.remove('active'));
                    });
                </script>
            </div><!-- /odolo-analytics-grid -->

            <!-- EXERCISERS TABLE -->
            <!-- EXERCISERS TABLE -->
            <div class="card anim anim-d3" id="exercisers-section" style="margin-top: 20px;">
                <div class="card-header">
                    <h3 style="display:flex;align-items:center;gap:8px"><img src="odolo-logo-official.svg" width="22"
                            height="22" alt="oDOLO" style="flex-shrink:0"> oDOLO Exercisers</h3>
                </div>
                <div class="table-toolbar">
                    <div class="search-input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                        <input type="text" id="exerciser-search" placeholder="Search exerciser address 0x…">
                    </div>
                    <div class="toolbar-count" id="exerciser-count"></div>
                </div>

                <div class="table-scroll">
                    <table id="exercisers-table" style="table-layout:fixed;width:100%">
                        <colgroup>
                            <col style="width:28px">
                            <col style="width:calc((100% - 28px) * 0.25)">
                            <col style="width:calc((100% - 28px) * 0.20)">
                            <col style="width:calc((100% - 28px) * 0.15)">
                            <col style="width:calc((100% - 28px) * 0.20)">
                            <col style="width:calc((100% - 28px) * 0.20)">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="c-rank sorted" data-sort="rank" onclick="sortExercisers('rank')">
                                    # <span class="arrow">▲</span>
                                </th>
                                <th data-sort="address" onclick="sortExercisers('address')">
                                    Address <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="total_usdc" onclick="sortExercisers('total_usdc')">
                                    USDC.e Spent <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="exercises" onclick="sortExercisers('exercises')">
                                    Exercises <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="avg_lock" onclick="sortExercisers('avg_lock')">
                                    Avg Lock <span class="arrow">⇅</span>
                                </th>
                                <th data-sort="avg_price" onclick="sortExercisers('avg_price')">
                                    Avg Price <span class="arrow">⇅</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="exercisers-tbody"></tbody>
                    </table>
                </div>
                <div class="table-footer" id="exerciser-pagination"></div>
            </div>

            <!-- Protocol Info -->
            <div class="card anim anim-d4 protocol-info-card" style="margin-top:24px">
                <div class="card-header">
                    <h3>Protocol Info</h3>
                </div>
                <div class="protocol-links-row proto-links"></div>
                <div class="protocol-contracts proto-contracts"></div>
            </div>

        </div><!-- /view-odolo -->

        <!-- DOLO TOKEN VIEW -->
        <div id="view-dolo" class="view-section active">

            <!-- DOLO METRICS -->
            <div class="metrics-strip anim anim-d1">
                <div class="metric-cell">
                    <div class="metric-label" style="display:flex;align-items:center;gap:5px"><img
                            src="https://icons.llama.fi/dolomite.jpg" alt=""
                            style="width:14px;height:14px;border-radius:50%">DOLO Price</div>
                    <div class="metric-value" id="dolo-price">—</div>
                    <div class="metric-sub" id="dolo-change"></div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">Market Cap</div>
                    <div class="metric-value" id="dolo-mcap">—</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">FDV</div>
                    <div class="metric-value" id="dolo-fdv">—</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">Total TVL</div>
                    <div class="metric-value" style="color:var(--accent-green)" id="dolo-tvl">—</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label">24h Volume</div>
                    <div class="metric-value" id="dolo-vol">—</div>
                </div>
                <div class="metric-cell">
                    <div class="metric-label" style="display:flex;align-items:center;gap:5px"><img
                            src="https://icons.llama.fi/dolomite.jpg" alt=""
                            style="width:14px;height:14px;border-radius:50%">Circulating Supply</div>
                    <div class="metric-value" id="dolo-circ-supply">—</div>
                </div>
            </div>

            <!-- DOLO ANALYTICS -->
            <div class="analytics-grid anim anim-d2" style="grid-template-columns:1fr 1fr">
                <!-- TVL by Chain -->
                <div class="card">
                    <div class="card-header" style="flex-direction:column;align-items:stretch">
                        <h3>Total TVL</h3>
                        <div id="dolo-chain-summary" style="display:flex;gap:16px;margin-top:8px;flex-wrap:wrap"></div>
                    </div>
                    <div id="dolo-chain-bars" style="padding:8px 0 12px 0"></div>
                </div>

                <!-- Token Composition Donut -->
                <div class="card">
                    <div class="card-header">
                        <h3>Token Composition</h3>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:center;padding:20px">
                        <div id="dolo-donut-wrap" style="position:relative;width:260px;height:260px;flex-shrink:0">
                            <canvas id="dolo-token-donut" style="width:260px;height:260px"></canvas>
                            <div id="dolo-donut-center"
                                style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none">
                            </div>
                        </div>
                        <div id="dolo-token-legend"
                            style="margin-top:16px;width:100%;display:flex;flex-direction:column;gap:2px">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TVL History Chart -->
            <div class="card anim anim-d3" style="margin-top:24px">
                <div class="card-header"
                    style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <h3 style="margin:0">TVL History</h3>
                        <span id="dolo-tvl-change-badge" class="tvl-change-badge" style="display:none"></span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <div id="dolo-tvl-range-btns" style="display:flex;gap:4px">
                            <button onclick="dolo_setRange(7)" class="dolo-range-btn" data-days="7">7D</button>
                            <button onclick="dolo_setRange(30)" class="dolo-range-btn" data-days="30">30D</button>
                            <button onclick="dolo_setRange(90)" class="dolo-range-btn" data-days="90">90D</button>
                            <button onclick="dolo_setRange(180)" class="dolo-range-btn" data-days="180">180D</button>
                            <button onclick="dolo_setRange(360)" class="dolo-range-btn active"
                                data-days="360">1Y</button>
                            <button onclick="dolo_setRange(99999)" class="dolo-range-btn" data-days="99999">ALL</button>
                            <button onclick="dolo_resetZoom()" class="dolo-range-btn" id="dolo-reset-zoom-btn"
                                style="display:none;background:rgba(239,68,68,0.15);color:#ef4444;border-color:rgba(239,68,68,0.3)">Reset</button>
                        </div>
                    </div>
                </div>
                <div style="padding:16px;position:relative">
                    <canvas id="dolo-tvl-chart" height="260" style="width:100%"></canvas>
                    <div id="dolo-tvl-tooltip" class="tvl-tooltip-enhanced"></div>
                </div>
                <!-- Brush Navigator -->
                <div id="dolo-brush-date-label"
                    style="padding:4px 16px 0;text-align:center;font-size:12px;color:var(--text-secondary);min-height:18px;display:flex;align-items:center;justify-content:center;gap:6px">
                </div>
                <div style="padding:0 2px 16px 16px;position:relative;user-select:none" id="dolo-brush-wrap">
                    <canvas id="dolo-brush-canvas" height="56" style="width:100%;border-radius:8px"></canvas>
                    <div id="dolo-brush-overlay" style="position:absolute;top:0;left:16px;right:2px;height:56px">
                        <!-- Dim left -->
                        <div id="dolo-brush-dim-left"
                            style="position:absolute;top:0;bottom:0;left:0;background:rgba(0,0,0,0.55);pointer-events:none;border-radius:8px 0 0 8px">
                        </div>
                        <!-- Selected window -->
                        <div id="dolo-brush-window"
                            style="position:absolute;top:0;bottom:0;border:2px solid rgba(99,102,241,0.8);border-radius:6px;cursor:grab;background:rgba(99,102,241,0.04);transition:background 0.15s">
                            <div id="dolo-brush-handle-left"
                                style="position:absolute;left:-7px;top:0;bottom:0;width:14px;cursor:ew-resize;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;transition:background 0.15s">
                                <div style="display:flex;gap:2px">
                                    <div
                                        style="width:2px;height:20px;border-radius:2px;background:rgba(99,102,241,0.9)">
                                    </div>
                                    <div
                                        style="width:2px;height:20px;border-radius:2px;background:rgba(99,102,241,0.5)">
                                    </div>
                                </div>
                            </div>
                            <div id="dolo-brush-handle-right"
                                style="position:absolute;right:-7px;top:0;bottom:0;width:14px;cursor:ew-resize;display:flex;align-items:center;justify-content:center;border-radius:0 4px 4px 0;transition:background 0.15s">
                                <div style="display:flex;gap:2px">
                                    <div
                                        style="width:2px;height:20px;border-radius:2px;background:rgba(99,102,241,0.5)">
                                    </div>
                                    <div
                                        style="width:2px;height:20px;border-radius:2px;background:rgba(99,102,241,0.9)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Dim right -->
                        <div id="dolo-brush-dim-right"
                            style="position:absolute;top:0;bottom:0;right:0;background:rgba(0,0,0,0.55);pointer-events:none;border-radius:0 8px 8px 0">
                        </div>
                    </div>
                </div>
            </div><!-- /TVL History card -->

            <!-- DOLO Holders Table -->
            <div class="card anim anim-d4" style="margin-top:24px" id="dolo-holders-card">
                <div class="card-header">
                    <h3 style="display:flex;align-items:center;gap:8px"><img src="dolo-logo.svg" width="22" height="22"
                            alt="DOLO" style="flex-shrink:0"> DOLO Holders</h3>
                </div>

                <div class="table-toolbar">
                    <div class="search-input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                        <input type="text" id="dolo-holder-search" placeholder="Search address 0x…">
                    </div>
                    <div class="toolbar-count" id="dolo-holder-results-count"></div>
                </div>

                <div class="table-scroll">
                    <table style="table-layout:fixed;width:100%" id="dolo-holders-table">
                        <colgroup>
                            <col style="width:28px">
                            <col style="width:calc((100% - 28px) * 0.34)">
                            <col style="width:calc((100% - 28px) * 0.22)" class="dolo-col-eth">
                            <col style="width:calc((100% - 28px) * 0.22)" class="dolo-col-bera">
                            <col style="width:calc((100% - 28px) * 0.22)">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="c-rank sorted" data-sort="dolo-rank" onclick="dolo_sortHolders('rank')">
                                    # <span class="arrow">▲</span>
                                </th>
                                <th data-sort="dolo-address" onclick="dolo_sortHolders('address')">
                                    Address <span class="arrow">⇅</span>
                                </th>
                                <th class="dolo-col-eth" style="text-align:right">
                                    <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
                                        <img src="https://icons.llamao.fi/icons/chains/rsz_ethereum.jpg" width="16"
                                            height="16" style="border-radius:50%" alt="ETH">
                                        <span style="font-size:12px;font-weight:600">ETH</span>
                                        <label class="chain-toggle" title="Toggle ETH balance">
                                            <input type="checkbox" id="dolo-filter-eth" checked
                                                onchange="dolo_toggleChainColumns()">
                                            <span class="chain-toggle-slider eth"></span>
                                        </label>
                                    </div>
                                </th>
                                <th class="dolo-col-bera" style="text-align:right">
                                    <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
                                        <img src="https://icons.llamao.fi/icons/chains/rsz_berachain.jpg" width="16"
                                            height="16" style="border-radius:50%" alt="BERA">
                                        <span style="font-size:12px;font-weight:600">BERA</span>
                                        <label class="chain-toggle" title="Toggle BERA balance">
                                            <input type="checkbox" id="dolo-filter-bera" checked
                                                onchange="dolo_toggleChainColumns()">
                                            <span class="chain-toggle-slider bera"></span>
                                        </label>
                                    </div>
                                </th>
                                <th data-sort="dolo-balance" onclick="dolo_sortHolders('balance')"
                                    style="text-align:right">
                                    <span id="dolo-balance-header">Balance</span> <span class="arrow">⇅</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dolo-holder-tbody"></tbody>
                    </table>
                </div>
                <div class="table-footer" id="dolo-holder-pagination"></div>
            </div>

            <!-- Protocol Info -->
            <div class="card anim anim-d4 protocol-info-card" style="margin-top:24px">
                <div class="card-header">
                    <h3>Protocol Info</h3>
                </div>
                <div class="protocol-links-row proto-links"></div>
                <div class="protocol-contracts proto-contracts"></div>
            </div>

        </div><!-- /view-dolo -->

        <!-- EARN VIEW -->
        <div id="view-earn" class="view-section">

            <div class="earn-hero anim">
                <h2>💰 Your Dolomite Earnings</h2>
                <p>Enter your wallet address to see deposit balances and accrued yield across all markets</p>
            </div>

            <div class="earn-input-card anim anim-d1">
                <div class="earn-input-row">
                    <div class="earn-input-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="5" width="20" height="14" rx="2" />
                            <path d="M2 10h20" />
                        </svg>
                        <input type="text" class="earn-input" id="earn-address" placeholder="0x... wallet address"
                            spellcheck="false" autocomplete="off">
                    </div>
                    <button class="earn-search-btn" id="earn-search-btn" onclick="earn_lookup()">
                        <span class="btn-text">Check Earnings</span>
                        <div class="spinner"></div>
                    </button>
                </div>
                <div class="earn-account-row">
                    <span class="earn-account-label">Network:</span>
                    <div class="earn-chain-dropdown" id="earn-chain-dropdown">
                        <input type="hidden" id="earn-chain" value="ethereum">
                        <button type="button" class="earn-chain-trigger" id="earn-chain-trigger"
                            onclick="earnChainToggle()">
                            <img src="https://icons.llamao.fi/icons/chains/rsz_ethereum.jpg" alt="">
                            <span>Ethereum</span>
                        </button>
                        <div class="earn-chain-menu" id="earn-chain-menu"></div>
                    </div>
                    <input type="hidden" id="earn-account-num" value="0">
                </div>
            </div>

            <div class="earn-error" id="earn-error">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="15" y1="9" x2="9" y2="15" />
                    <line x1="9" y1="9" x2="15" y2="15" />
                </svg>
                <span id="earn-error-msg"></span>
            </div>

            <div class="earn-empty" id="earn-empty">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="2" y="5" width="20" height="14" rx="2" />
                    <path d="M2 10h20" />
                    <circle cx="16" cy="15" r="2" />
                </svg>
                <h3 id="earn-empty-title">No deposits found</h3>
                <p id="earn-empty-msg">This address has no active deposits on Dolomite</p>
            </div>

            <div class="earn-period-bar" id="earn-period-bar">
                <!-- Dynamic period buttons (3D, 7D, etc.) injected by JS -->
            </div>

            <div class="earn-results" id="earn-results">
                <div class="table-section">
                    <div class="table-scroll">
                        <table class="earn-asset-table">
                            <colgroup>
                                <col style="width:30%">
                                <col style="width:35%">
                                <col style="width:35%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Token</th>
                                    <th data-sort="balance" class="sort-active" onclick="earn_sortAssets('balance')">
                                        Current Balance <span class="earn-sort-arrow">▼</span></th>
                                    <th data-sort="yield" onclick="earn_sortAssets('yield')">Total Yield Earned <span
                                            class="earn-sort-arrow">▼</span> <span class="tooltip-icon">?<span
                                                class="tooltip-bubble">Cumulative interest earned from Dolomite lending,
                                                isolated from deposits, withdrawals, and swaps using supply
                                                index tracking. Coverage period shown below each value.</span></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="earn-table-body"></tbody>
                            <tfoot id="earn-table-foot" style="display:none"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

        </div><!-- /view-earn -->


        <!-- Snapshot Calendar Picker Modal -->
        <div class="earn-custom-date-overlay" id="earn-custom-date-overlay"
            onclick="if(event.target===this)earn_closeCustomDate()">
            <div class="earn-custom-date-modal">
                <div class="earn-cal-header">
                    <h4>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                        Select Date
                    </h4>
                    <button class="earn-cal-close" onclick="earn_closeCustomDate()">&times;</button>
                </div>
                <div class="earn-cal-nav">
                    <button onclick="earn_calNavigate(-1)">&#8249;</button>
                    <span class="earn-cal-month-label" id="earn-cal-month-label"></span>
                    <button onclick="earn_calNavigate(1)">&#8250;</button>
                </div>
                <div class="earn-cal-weekdays">
                    <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
                </div>
                <div class="earn-cal-grid" id="earn-cal-grid"></div>
                <div class="earn-cal-hint">
                    Only verified on-chain snapshot dates can be selected
                    <div class="earn-cal-legend">
                        <span class="legend-item"><span class="legend-dot available"></span> Data available</span>
                        <span class="legend-item"><span class="legend-dot today-dot"></span> Today</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="site-footer anim anim-d4">
            Generated <span id="footer-date"></span> · Data from <a href="https://berascan.com"
                target="_blank">BeraScan</a>
        </footer>
    </div>

    <!-- PROFILE MODAL -->
    <div class="modal-overlay" id="profile-modal" onclick="if(event.target===this)closeProfile()">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-header-left">
                    <span class="modal-rank" id="pm-rank"></span>
                    <span class="modal-addr" id="pm-addr"></span>
                </div>
                <button class="modal-close" onclick="closeProfile()" title="Close">✕</button>
            </div>
            <div class="modal-summary">
                <div class="modal-stat">
                    <div class="modal-stat-label">Total Vote Weight</div>
                    <div class="modal-stat-value orange" id="pm-vote"></div>
                    <div class="modal-stat-sub">veDOLO</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Total DOLO Locked</div>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px">
                        <div class="modal-stat-value green" id="pm-dolo"></div>
                        <img src="vedolo-logo.svg" alt="veDOLO" style="width:24px;height:24px">
                    </div>
                    <div class="modal-stat-sub" id="pm-dolo-pct"></div>
                </div>
            </div>
            <div class="modal-body">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
                    <div class="modal-section-title" id="pm-locks-title" style="margin-bottom:0">Active Locks</div>
                    <div class="lock-sort-bar" id="pm-lock-sort" style="margin-bottom:0"></div>
                </div>
                <div id="pm-locks"></div>
            </div>
            <div class="modal-links">
                <a class="modal-link" id="pm-berascan" target="_blank">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                        <polyline points="15 3 21 3 21 9" />
                        <line x1="10" y1="14" x2="21" y2="3" />
                    </svg>
                    View on BeraScan
                </a>
                <a class="modal-link" id="pm-debank" target="_blank" style="color:#fe815f">
                    <img src="https://debank.com/favicon.ico" width="14" height="14"
                        style="vertical-align:middle;margin-right:4px;border-radius:3px"
                        onerror="this.style.display='none'">
                    View on DeBank
                </a>
                <a class="modal-link" id="pm-copy" onclick="copyFromModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" />
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" />
                    </svg>
                    Copy Address
                </a>
            </div>
        </div>
    </div>

    <!-- EXERCISER DETAIL MODAL -->
    <div class="modal-overlay" id="exerciser-modal" onclick="if(event.target===this)closeExerciserModal()">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-header-left">
                    <span class="modal-rank" id="em-rank"></span>
                    <span class="modal-addr" id="em-addr"></span>
                </div>
                <button class="modal-close" onclick="closeExerciserModal()" title="Close">✕</button>
            </div>
            <div class="modal-summary">
                <div class="modal-stat">
                    <div class="modal-stat-label">USDC.e Spent</div>
                    <div class="modal-stat-value orange" id="em-usdc"></div>
                    <div class="modal-stat-sub">total</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Exercises</div>
                    <div class="modal-stat-value" id="em-exercises" style="color: #fff"></div>
                    <div class="modal-stat-sub" id="em-period"></div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Avg Lock</div>
                    <div class="modal-stat-value" id="em-avglock" style="color: #fff"></div>
                    <div class="modal-stat-sub">duration</div>
                </div>
                <div class="modal-stat">
                    <div class="modal-stat-label">Avg Price</div>
                    <div class="modal-stat-value" id="em-avgprice" style="color: #34d399"></div>
                    <div class="modal-stat-sub">per veDOLO</div>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-section-title">Exercise History</div>
                <div id="em-txs"></div>
            </div>
            <div class="modal-links">
                <a class="modal-link" id="em-berascan" target="_blank">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                        <polyline points="15 3 21 3 21 9" />
                        <line x1="10" y1="14" x2="21" y2="3" />
                    </svg>
                    View on BeraScan
                </a>
                <a class="modal-link" id="em-debank" target="_blank" style="color:#fe815f">
                    <img src="https://debank.com/favicon.ico" width="14" height="14"
                        style="vertical-align:middle;margin-right:4px;border-radius:3px"
                        onerror="this.style.display='none'">
                    View on DeBank
                </a>
                <a class="modal-link" id="em-copy" onclick="copyExerciserAddr()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" />
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" />
                    </svg>
                    Copy Address
                </a>
            </div>
        </div>
    </div>


    <div class="toast" id="copy-toast">✅ Address copied!</div>

    <script>
        // ===== DATA =====
        let HOLDER_DATA = [];
        const STATS = { total_minted: 23391, total_burned: 8606, active_nfts: 14785, unique_holders: 10979, total_locked_dolo: 0 };
        const PER_PAGE = 25;
        let currentPage = 1;
        let filteredData = [];
        let sortField = 'rank';
        let sortAsc = true;
        let compareSet = new Set();

        // ===== KNOWN ADDRESSES =====
        const KNOWN_ADDR = {
            '0x0000000000000000000000000000000000000000': { label: 'Burn', type: 'dead' },
            '0x000000000000000000000000000000000000dead': { label: 'Burn', type: 'dead' },
            '0xcb86b75ee6133d179a12d550b09fb3cdb1e141d4': { label: 'veDOLO Contract', type: 'contract' },
            '0x6bd780e7fdf01d77e4d475c821f1e7ae05409072': { label: 'Dolomite Margin', type: 'contract' },
        };

        const DIST = [
            { label: '1 NFT', min: 1, max: 1, color: '#6366f1' },
            { label: '2–5', min: 2, max: 5, color: '#818cf8' },
            { label: '6–10', min: 6, max: 10, color: '#22d3ee' },
            { label: '11–25', min: 11, max: 25, color: '#34d399' },
            { label: '26–50', min: 26, max: 50, color: '#fbbf24' },
            { label: '51–100', min: 51, max: 100, color: '#fb923c' },
            { label: '100+', min: 101, max: Infinity, color: '#fb7185' },
        ];

        // ===== LOAD =====
        async function loadData() {
            try {
                const resp = await fetch('vedolo_holders.json');
                if (resp.ok) {
                    const data = await resp.json();
                    HOLDER_DATA = data.holders;
                    Object.assign(STATS, data.stats);
                }
            } catch (e) {
                console.warn('Could not load JSON', e);
            }

            if (!HOLDER_DATA.length) {
                document.getElementById('table-body').innerHTML =
                    '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">⚠️ Place vedolo_holders.json in the same directory.</td></tr>';
                return;
            }
            init();
            checkHash();
        }

        async function loadEarlyExitData() {
            try {
                const resp = await fetch('early_exits.json');
                if (!resp.ok) return;
                const data = await resp.json();
                const s = data.stats;
                if (!s) return;

                const fmt = n => Number(Math.round(n)).toLocaleString();

                if (s.total_penalty_dolo > 0) {
                    const doloIcon = ' <img src="dolo-logo.svg" class="metric-icon">';
                    anim('m-penalty', Math.round(s.total_penalty_dolo), true, doloIcon);

                    // Penalty breakdown bar
                    const total = s.total_burn_fee_dolo + s.total_recoup_fee_dolo;
                    if (total > 0) {
                        const burnPct = (s.total_burn_fee_dolo / total * 100).toFixed(1);
                        const recoupPct = (s.total_recoup_fee_dolo / total * 100).toFixed(1);
                        setTimeout(() => {
                            document.getElementById('penalty-bar-burn').style.width = burnPct + '%';
                            document.getElementById('penalty-bar-recoup').style.width = recoupPct + '%';
                        }, 300);
                        document.getElementById('m-burn-label').textContent = fmt(s.total_burn_fee_dolo) + ' burned';
                        document.getElementById('m-recoup-label').textContent = fmt(s.total_recoup_fee_dolo) + ' recouped';
                    }
                }

                if (s.total_early_exits > 0) {
                    anim('m-exits', s.total_early_exits);
                    const exitPct = (s.total_early_exits / s.total_withdrawals * 100).toFixed(1);
                    document.getElementById('m-exits-sub').textContent =
                        exitPct + '% of ' + fmt(s.total_withdrawals) + ' withdrawals';
                    // Exit ratio bar
                    setTimeout(() => {
                        document.getElementById('exit-ratio-fill').style.width = exitPct + '%';
                    }, 500);
                }

                if (s.avg_penalty_pct > 0) {
                    document.getElementById('m-avg-penalty').textContent = s.avg_penalty_pct + '%';
                    document.getElementById('m-avg-penalty-sub').textContent =
                        'out of ~55% max';
                    // Penalty gauge (normalize to 55% max)
                    const gaugePct = Math.min((s.avg_penalty_pct / 55) * 100, 100).toFixed(1);
                    setTimeout(() => {
                        document.getElementById('penalty-gauge-fill').style.width = gaugePct + '%';
                    }, 700);
                }
            } catch (e) {
                console.warn('Early exit data not available', e);
            }
        }

        function init() {
            // Metrics
            const vedoloIcon = ' <img src="vedolo-logo.svg" class="metric-icon">';
            anim('m-holders', STATS.unique_holders, false, '', vedoloIcon);
            anim('m-active', STATS.active_nfts, false, '', vedoloIcon);

            if (STATS.total_locked_dolo) {
                anim('m-dolo', Math.round(STATS.total_locked_dolo), true, '', vedoloIcon);
            }
            if (STATS.total_vote_weight) {
                anim('m-vote', Math.round(STATS.total_vote_weight), true);
            }

            // Load early exit penalty stats
            loadEarlyExitData();

            document.getElementById('footer-date').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            renderDist();
            renderDonut();
            renderExpiryChart();
            setupExpiryInteraction();

            filteredData = [...HOLDER_DATA];
            renderTable();
            renderPagination();

            document.getElementById('search').addEventListener('input', debounce(applyFilters, 200));
            document.getElementById('filter-nft').addEventListener('change', applyFilters);
        }

        // ===== COUNTER ANIMATION =====
        function anim(id, target, suffix, emoji, iconHtml) {
            const el = document.getElementById(id);
            const dur = 1000;
            const start = performance.now();
            const fmt = n => {
                if (suffix && n >= 1e6) return (n / 1e6).toFixed(1).replace('.', ',') + 'M';
                if (suffix && n >= 1e3) return Math.round(n / 1e3).toLocaleString('en-US') + 'K';
                return n.toLocaleString('en-US');
            };
            (function tick(now) {
                const p = Math.min((now - start) / dur, 1);
                const e = 1 - Math.pow(1 - p, 3);
                const val = fmt(Math.floor(target * e)) + (emoji || '');
                el.innerHTML = val + (iconHtml || '');
                if (p < 1) requestAnimationFrame(tick);
            })(start);
        }

        // ===== CHARTS =====
        function renderDist() {
            const el = document.getElementById('dist-bars');
            const counts = DIST.map(d => ({ ...d, count: HOLDER_DATA.filter(h => h.nft_count >= d.min && h.nft_count <= d.max).length }));
            const mx = Math.max(...counts.map(c => c.count));
            const totalHolders = counts.reduce((s, d) => s + d.count, 0);
            el.innerHTML = counts.map(d => {
                const pct = ((d.count / totalHolders) * 100).toFixed(1);
                return `
        <div class="dist-item" onmouseenter="this.querySelector('.dist-tooltip').style.display='block'" onmouseleave="this.querySelector('.dist-tooltip').style.display='none'">
            <div class="label">${d.label}</div>
            <div class="track" style="position:relative">
                <div class="fill" style="width:${Math.max(3, (d.count / mx) * 100)}%;background:${d.color}">
                    <span>${d.count.toLocaleString('en-US')}</span>
                </div>
                <div class="dist-tooltip" style="position:absolute;top:-36px;right:0">
                    <strong style="color:${d.color}">${d.label}</strong>: ${d.count.toLocaleString('en-US')} holders · <strong>${pct}%</strong>
                </div>
            </div>
        </div>
    `}).join('');
        }

        // Arc helper: compute SVG arc path for a donut segment
        function describeArc(cx, cy, r, startAngle, endAngle) {
            const rad = Math.PI / 180;
            const x1 = cx + r * Math.cos((startAngle - 90) * rad);
            const y1 = cy + r * Math.sin((startAngle - 90) * rad);
            const x2 = cx + r * Math.cos((endAngle - 90) * rad);
            const y2 = cy + r * Math.sin((endAngle - 90) * rad);
            const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
            return `M ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`;
        }

        function renderDonut() {
            const svg = document.getElementById('donut-chart');
            const leg = document.getElementById('donut-legend');
            const segs = DIST.map(d => ({
                ...d,
                nfts: HOLDER_DATA.filter(h => h.nft_count >= d.min && h.nft_count <= d.max).reduce((s, h) => s + h.nft_count, 0)
            })).filter(s => s.nfts > 0);

            const total = segs.reduce((s, d) => s + d.nfts, 0);
            const cx = 21, cy = 21, r = 15.91549;

            // Create tooltip element if not exists
            let tooltip = document.getElementById('donut-hover-tip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'donut-hover-tip';
                tooltip.className = 'donut-tooltip';
                document.body.appendChild(tooltip);
            }

            // Background circle
            let html = `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="5"/>`;

            let currentAngle = 0;
            segs.forEach((seg, i) => {
                const pct = seg.nfts / total;
                const angle = pct * 360;
                // Clamp to avoid floating-point overshoot
                const endAngle = Math.min(currentAngle + angle, 360);
                // For a full circle (single segment), use two half-arcs
                if (angle >= 359.99) {
                    html += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${seg.color}" stroke-width="5"
                    style="cursor:pointer"
                    data-idx="${i}" data-label="${seg.label}" data-nfts="${seg.nfts}" data-pct="${(pct * 100).toFixed(1)}" data-color="${seg.color}"
                    onmouseenter="donutHover(this, event)" onmouseleave="donutUnhover(this)" onmousemove="donutMove(event)"/>`;
                } else {
                    const d = describeArc(cx, cy, r, currentAngle, endAngle);
                    html += `<path d="${d}" fill="none" stroke="${seg.color}" stroke-width="5"
                    style="cursor:pointer"
                    data-idx="${i}" data-label="${seg.label}" data-nfts="${seg.nfts}" data-pct="${(pct * 100).toFixed(1)}" data-color="${seg.color}"
                    onmouseenter="donutHover(this, event)" onmouseleave="donutUnhover(this)" onmousemove="donutMove(event)"/>`;
                }
                currentAngle = endAngle;
            });

            html += `<text x="${cx}" y="20" text-anchor="middle" fill="var(--text-primary)" font-size="4" font-weight="700"
        font-family="Inter">${total.toLocaleString('en-US')}</text>
        <text x="${cx}" y="24" text-anchor="middle" fill="var(--text-muted)" font-size="2"
        font-family="Inter">NFT</text>`;
            svg.innerHTML = html;

            leg.innerHTML = segs.map((s, i) => {
                const pct = ((s.nfts / total) * 100).toFixed(1);
                return `
        <div class="legend-row" data-idx="${i}"
            onmouseenter="legendHover(${i}, '${s.color}')" onmouseleave="legendUnhover(${i})">
            <div class="legend-swatch" style="background:${s.color}"></div>
            ${s.label}: ${s.nfts.toLocaleString('en-US')} (${pct}%)
        </div>
    `}).join('');
        }

        // Donut hover helpers — query both path and circle elements
        function donutSegments() {
            return document.querySelectorAll('#donut-chart path[data-idx], #donut-chart circle[data-idx]');
        }
        function donutHover(el, e) {
            const idx = parseInt(el.dataset.idx);
            el.setAttribute('stroke-width', '7');
            el.style.filter = 'brightness(1.4) drop-shadow(0 0 6px ' + el.dataset.color + ')';
            const tip = document.getElementById('donut-hover-tip');
            tip.innerHTML = `<strong style="color:${el.dataset.color}">${el.dataset.label}</strong><br>${parseInt(el.dataset.nfts).toLocaleString('en-US')} NFTs · <strong>${el.dataset.pct}%</strong>`;
            tip.style.display = 'block';
            donutMove(e);
            // Highlight corresponding legend row
            const rows = document.querySelectorAll('#donut-legend .legend-row');
            rows.forEach(r => {
                if (parseInt(r.dataset.idx) === idx) {
                    r.style.background = 'rgba(255,255,255,0.08)';
                    r.style.borderLeft = '3px solid ' + el.dataset.color;
                    r.style.paddingLeft = '8px';
                    r.style.color = '#fff';
                    r.style.fontWeight = '700';
                } else {
                    r.style.opacity = '0.4';
                }
            });
            // Dim other segments
            donutSegments().forEach(c => {
                if (parseInt(c.dataset.idx) !== idx) {
                    c.style.opacity = '0.3';
                }
            });
        }
        function donutUnhover(el) {
            el.setAttribute('stroke-width', '5');
            el.style.filter = '';
            document.getElementById('donut-hover-tip').style.display = 'none';
            // Reset legend rows
            const rows = document.querySelectorAll('#donut-legend .legend-row');
            rows.forEach(r => {
                r.style.background = '';
                r.style.borderLeft = '';
                r.style.paddingLeft = '';
                r.style.color = '';
                r.style.fontWeight = '';
                r.style.opacity = '1';
            });
            // Reset other segments
            donutSegments().forEach(c => {
                c.style.opacity = '1';
            });
        }
        function donutMove(e) {
            const tip = document.getElementById('donut-hover-tip');
            tip.style.left = (e.clientX + 14) + 'px';
            tip.style.top = (e.clientY - 10) + 'px';
        }
        function legendHover(idx, color) {
            donutSegments().forEach(c => {
                if (parseInt(c.dataset.idx) === idx) {
                    c.setAttribute('stroke-width', '7');
                    c.style.filter = 'brightness(1.4) drop-shadow(0 0 6px ' + color + ')';
                } else {
                    c.style.opacity = '0.3';
                }
            });
            // Highlight this legend row, dim others
            const rows = document.querySelectorAll('#donut-legend .legend-row');
            rows.forEach(r => {
                if (parseInt(r.dataset.idx) === idx) {
                    r.style.background = 'rgba(255,255,255,0.08)';
                    r.style.borderLeft = '3px solid ' + color;
                    r.style.paddingLeft = '8px';
                    r.style.color = '#fff';
                    r.style.fontWeight = '700';
                } else {
                    r.style.opacity = '0.4';
                }
            });
        }
        function legendUnhover(idx) {
            donutSegments().forEach(c => {
                c.setAttribute('stroke-width', '5');
                c.style.filter = '';
                c.style.opacity = '1';
            });
            // Reset all legend rows
            const rows = document.querySelectorAll('#donut-legend .legend-row');
            rows.forEach(r => {
                r.style.background = '';
                r.style.borderLeft = '';
                r.style.paddingLeft = '';
                r.style.color = '';
                r.style.fontWeight = '';
                r.style.opacity = '1';
            });
        }

        // ===== EXPIRY TIMELINE CHART =====
        let expiryBars = [];  // stored bar rects for hit detection
        let expiryEntries = [];  // stored data entries
        let expiryTotalDolo = 0;

        function renderExpiryChart(hoveredIdx) {
            const canvas = document.getElementById('expiry-canvas');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            ctx.scale(dpr, dpr);
            const W = canvas.offsetWidth, H = canvas.offsetHeight;

            // Gather all lock end dates with DOLO amounts
            const locks = [];
            HOLDER_DATA.forEach(h => {
                (h.token_details || []).forEach(d => {
                    if (d.end && d.dolo > 0) locks.push({ end: d.end, dolo: d.dolo });
                });
            });

            if (!locks.length) {
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.font = '13px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No lock data available', W / 2, H / 2);
                return;
            }

            // Group by quarter — only future locks
            const now = Date.now() / 1000;
            const buckets = {};
            let totalDoloAll = 0;
            locks.forEach(l => {
                if (l.end < now) return; // skip already expired
                const d = new Date(l.end * 1000);
                const q = `Q${Math.ceil((d.getMonth() + 1) / 3)} ${d.getFullYear()}`;
                buckets[q] = (buckets[q] || 0) + l.dolo;
                totalDoloAll += l.dolo;
            });

            const entries = Object.entries(buckets).sort((a, b) => {
                const pa = a[0].split(' '), pb = b[0].split(' ');
                return (parseInt(pa[1]) * 4 + parseInt(pa[0][1])) - (parseInt(pb[1]) * 4 + parseInt(pb[0][1]));
            });

            if (!entries.length) return;
            expiryEntries = entries;
            expiryTotalDolo = totalDoloAll;

            const maxVal = Math.max(...entries.map(e => e[1]));
            // Responsive sizing
            const isMobile = W < 500;
            const fontSize = isMobile ? 10 : 12;
            const pad = { top: 40, bottom: isMobile ? 45 : 50, left: isMobile ? 45 : 70, right: isMobile ? 10 : 20 };
            const chartW = W - pad.left - pad.right;
            const chartH = H - pad.top - pad.bottom;
            const barW = Math.min(40, (chartW / entries.length) * 0.65);
            const gap = chartW / entries.length;

            // Y axis
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = pad.top + chartH * (1 - i / 4);
                ctx.beginPath();
                ctx.moveTo(pad.left, y);
                ctx.lineTo(W - pad.right, y);
                ctx.stroke();

                ctx.fillStyle = 'rgba(255,255,255,0.35)';
                ctx.font = `${fontSize}px Inter`;
                ctx.textAlign = 'right';
                const val = (maxVal * i / 4);
                ctx.fillText(val >= 1e6 ? (val / 1e6).toFixed(1) + 'M' : val >= 1e3 ? Math.round(val / 1e3) + 'K' : Math.round(val), pad.left - 6, y + 3);
            }

            // Store bar positions for hit detection
            const bars = [];

            // Bars
            entries.forEach(([label, val], i) => {
                const x = pad.left + i * gap + (gap - barW) / 2;
                const barH = (val / maxVal) * chartH;
                const y = pad.top + chartH - barH;
                const isHovered = (hoveredIdx === i);

                bars.push({ x, y, w: barW, h: barH, label, val, idx: i });

                // gradient fill
                const grd = ctx.createLinearGradient(x, y, x, y + barH);
                if (isHovered) {
                    grd.addColorStop(0, '#818cf8');
                    grd.addColorStop(1, '#a5b4fc');
                } else {
                    grd.addColorStop(0, '#6366f1');
                    grd.addColorStop(1, '#818cf8');
                }
                ctx.fillStyle = grd;

                // dim non-hovered bars when one is hovered
                if (hoveredIdx !== undefined && !isHovered) {
                    ctx.globalAlpha = 0.35;
                }

                ctx.beginPath();
                ctx.roundRect(x, y, barW, barH, [4, 4, 0, 0]);
                ctx.fill();

                // glow effect on hovered bar
                if (isHovered) {
                    ctx.shadowColor = '#6366f1';
                    ctx.shadowBlur = 16;
                    ctx.fill();
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                }

                ctx.globalAlpha = 1;

                // X-axis label
                ctx.fillStyle = isHovered ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.5)';
                ctx.font = `${isHovered ? 'bold ' : ''}${fontSize}px Inter`;
                ctx.textAlign = 'center';
                const shortLabel = label.replace(/ 20(\d\d)/, "'$1");
                ctx.fillText(shortLabel, x + barW / 2, H - pad.bottom + 14);

                // Value on top
                ctx.fillStyle = isHovered ? '#fff' : 'rgba(255,255,255,0.7)';
                ctx.font = `${isHovered ? 'bold ' : ''}${fontSize}px Inter`;
                const valLbl = val >= 1e6 ? (val / 1e6).toFixed(1) + 'M' : val >= 1e3 ? Math.round(val / 1e3) + 'K' : Math.round(val);
                ctx.fillText(valLbl, x + barW / 2, y - 5);
            });

            expiryBars = bars;
        }

        // Expiry chart mouse interaction
        function setupExpiryInteraction() {
            const canvas = document.getElementById('expiry-canvas');
            if (!canvas) return;
            const tooltip = document.getElementById('expiry-tooltip');
            let lastHovered;

            function handleMove(clientX, clientY) {
                const rect = canvas.getBoundingClientRect();
                const mx = clientX - rect.left;
                const my = clientY - rect.top;
                let hit;

                for (const bar of expiryBars) {
                    const colCenter = bar.x + bar.w / 2;
                    const halfGap = 35;
                    if (mx >= colCenter - halfGap && mx <= colCenter + halfGap) {
                        hit = bar.idx;
                        break;
                    }
                }

                if (hit !== lastHovered) {
                    lastHovered = hit;
                    renderExpiryChart(hit);
                }

                if (hit !== undefined && expiryBars[hit]) {
                    canvas.style.cursor = 'pointer';
                    const bar = expiryBars[hit];
                    const pct = expiryTotalDolo ? ((bar.val / expiryTotalDolo) * 100).toFixed(1) : '0';
                    const doloFmt = bar.val >= 1e6 ? (bar.val / 1e6).toFixed(2) + 'M' : bar.val >= 1e3 ? (bar.val / 1e3).toFixed(1) + 'K' : Math.round(bar.val);
                    tooltip.innerHTML = `<strong style="color:#a5b4fc">${bar.label}</strong><br>${doloFmt} DOLO<br><span style="opacity:0.7">${pct}% of total</span>`;
                    tooltip.style.display = 'block';
                    // Position tooltip using viewport coordinates (fixed positioning)
                    const tipX = rect.left + bar.x + bar.w / 2;
                    const tipY = rect.top + bar.y - 8;
                    tooltip.style.left = tipX + 'px';
                    tooltip.style.top = tipY + 'px';
                } else {
                    canvas.style.cursor = 'default';
                    tooltip.style.display = 'none';
                }
            }

            canvas.addEventListener('mousemove', function (e) {
                handleMove(e.clientX, e.clientY);
            });

            canvas.addEventListener('mouseleave', function () {
                lastHovered = undefined;
                renderExpiryChart();
                tooltip.style.display = 'none';
                canvas.style.cursor = 'default';
            });

            // Touch support for mobile
            canvas.addEventListener('touchstart', function (e) {
                e.preventDefault();
                const touch = e.touches[0];
                handleMove(touch.clientX, touch.clientY);
            }, { passive: false });

            canvas.addEventListener('touchmove', function (e) {
                e.preventDefault();
                const touch = e.touches[0];
                handleMove(touch.clientX, touch.clientY);
            }, { passive: false });

            canvas.addEventListener('touchend', function () {
                lastHovered = undefined;
                renderExpiryChart();
                tooltip.style.display = 'none';
            });
        }

        // ===== TABLE =====
        function fmtDolo(n) {
            if (!n) return '0';
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function getAddrLabel(addr) {
            const info = KNOWN_ADDR[addr.toLowerCase()];
            if (!info) return '';
            return `<span class="addr-label ${info.type}">${info.label}</span>`;
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            const start = (currentPage - 1) * PER_PAGE;
            const page = filteredData.slice(start, start + PER_PAGE);
            const maxNft = Math.max(...filteredData.map(h => h.nft_count), 1);
            const maxDolo = Math.max(...filteredData.map(h => h.total_dolo || 0), 1);
            const maxVote = Math.max(...filteredData.map(h => h.total_vote_weight || 0), 1);
            const totalDolo = STATS.total_locked_dolo || 1;

            tbody.innerHTML = page.map(h => {
                const rc = h.rank <= 3 ? `rank-${h.rank}` : '';
                const isWhale = h.rank <= 10;
                const nftPct = Math.max(3, (h.nft_count / maxNft) * 100);
                const doloPct = Math.max(3, ((h.total_dolo || 0) / maxDolo) * 100);
                const votePct = Math.max(3, ((h.total_vote_weight || 0) / maxVote) * 100);
                const supplyPct = ((h.total_dolo || 0) / totalDolo * 100).toFixed(1);
                const tokPrev = h.token_ids.slice(0, 3).join(', ') + (h.token_ids.length > 3 ? ` …+${h.token_ids.length - 3}` : '');
                const doloExact = (h.total_dolo || 0).toLocaleString('en-US', { maximumFractionDigits: 2 });
                const voteExact = (h.total_vote_weight || 0).toLocaleString('en-US', { maximumFractionDigits: 4 });
                const addrLabel = getAddrLabel(h.address);
                const checked = compareSet.has(h.address) ? 'checked' : '';

                return `<tr class="${isWhale ? 'whale-row' : ''}" style="cursor:pointer" onclick="showProfile('${h.address}')">
            <td class="c-rank">
                <div class="rank-cell-inner">
                    ${rc ? `<span class="rank-medal ${rc}">${h.rank}</span>` : `<span class="rank-plain">${h.rank}</span>`}
                </div>
            </td>
            <td class="c-addr">
                <span style="display:inline-flex;align-items:center;gap:4px"><a href="#address=${h.address}" onclick="event.preventDefault();event.stopPropagation();showProfile('${h.address}')">${h.address.slice(0, 6)}…${h.address.slice(-4)}</a>${addrLabel}<span class="copy-addr-icon" onclick="event.stopPropagation();copyAddr('${h.address}',this)" title="Copy address"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span><a href="https://debank.com/profile/${h.address}?chain=bera" target="_blank" onclick="event.stopPropagation()" class="debank-icon" title="View on DeBank"><img src="https://debank.com/favicon.ico" width="14" height="14" onerror="this.parentElement.style.display='none'"></a></span>
            </td>
            <td class="c-nft">${h.nft_count}</td>
            <td class="c-dolo" title="${doloExact} DOLO">${fmtDolo(h.total_dolo || 0)}<span class="supply-pct">(${supplyPct}%)</span></td>
            <td class="c-vote" title="${voteExact} veDOLO" style="color:#f59e0b">${fmtDolo(h.total_vote_weight || 0)}</td>
            <td class="c-tokens"><div class="tokens-truncated" title="${h.token_ids.join(', ')}">${tokPrev}</div></td>
        </tr>`;
            }).join('');

            document.getElementById('results-count').textContent =
                `${filteredData.length.toLocaleString('en-US')} results`;
        }

        // ===== PAGINATION =====
        function renderPagination() {
            const total = Math.ceil(filteredData.length / PER_PAGE);
            const el = document.getElementById('pagination');
            if (total <= 1) { el.innerHTML = ''; return; }

            let h = `<button class="pg-btn" onclick="goPage(1)" ${currentPage === 1 ? 'disabled' : ''}>«</button>`;
            h += `<button class="pg-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>`;

            for (let p = Math.max(1, currentPage - 1); p <= Math.min(total, currentPage + 1); p++) {
                h += `<button class="pg-btn ${p === currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
            }

            h += `<button class="pg-btn" onclick="goPage(${currentPage + 1})" ${currentPage === total ? 'disabled' : ''}>›</button>`;
            h += `<button class="pg-btn" onclick="goPage(${total})" ${currentPage === total ? 'disabled' : ''}>»</button>`;
            h += `<span class="pg-info">${currentPage} / ${total}</span>`;
            el.innerHTML = h;
        }

        function goPage(p) {
            const t = Math.ceil(filteredData.length / PER_PAGE);
            currentPage = Math.max(1, Math.min(p, t));
            renderTable();
            renderPagination();
            document.querySelector('.table-scroll').scrollTop = 0;
        }

        // ===== SORT =====
        function sortTable(field) {
            document.querySelectorAll('thead th').forEach(h => h.classList.remove('sorted'));
            if (sortField === field) { sortAsc = !sortAsc; } else { sortField = field; sortAsc = field === 'rank'; }

            const th = document.querySelector(`th[data-sort="${field}"]`);
            th.classList.add('sorted');
            th.querySelector('.arrow').textContent = sortAsc ? '▲' : '▼';

            filteredData.sort((a, b) => {
                let va = a[field], vb = b[field];
                if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                return va < vb ? (sortAsc ? -1 : 1) : va > vb ? (sortAsc ? 1 : -1) : 0;
            });

            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // ===== FILTER =====
        function applyFilters() {
            const q = document.getElementById('search').value.toLowerCase().trim();
            const nf = document.getElementById('filter-nft').value;

            filteredData = HOLDER_DATA.filter(h => {
                if (q) {
                    const byAddr = h.address.toLowerCase().includes(q);
                    const byTok = q.match(/^\d+$/) && h.token_ids.includes(parseInt(q));
                    if (!byAddr && !byTok) return false;
                }
                if (nf !== 'all') {
                    const n = h.nft_count;
                    switch (nf) {
                        case '100+': if (n < 100) return false; break;
                        case '50-100': if (n < 50 || n > 100) return false; break;
                        case '26-50': if (n < 26 || n > 50) return false; break;
                        case '11-25': if (n < 11 || n > 25) return false; break;
                        case '6-10': if (n < 6 || n > 10) return false; break;
                        case '2-5': if (n < 2 || n > 5) return false; break;
                        case '1': if (n !== 1) return false; break;
                    }
                }
                return true;
            });

            if (sortField !== 'rank') {
                filteredData.sort((a, b) => {
                    let va = a[sortField], vb = b[sortField];
                    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                    return va < vb ? (sortAsc ? -1 : 1) : va > vb ? (sortAsc ? 1 : -1) : 0;
                });
            }

            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // ===== UTILS =====
        function copyAddr(e, addr) {
            if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                navigator.clipboard.writeText(addr);
                const t = document.getElementById('copy-toast');
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 1500);
            }
        }

        function downloadCSV() {
            let csv = 'Rank,Address,NFT_Count,Total_DOLO,Supply_Pct,Vote_Weight,Token_IDs\n';
            const totalDolo = STATS.total_locked_dolo || 1;
            filteredData.forEach(h => {
                const pct = ((h.total_dolo || 0) / totalDolo * 100).toFixed(2);
                csv += `${h.rank},${h.address},${h.nft_count},${(h.total_dolo || 0).toFixed(2)},${pct}%,${(h.total_vote_weight || 0).toFixed(4)},"${h.token_ids.join(';')}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'vedolo_holders.csv'; a.click();
            URL.revokeObjectURL(url);
        }

        function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

        // ===== PROFILE MODAL =====
        let currentProfileAddr = null;
        let currentLockSort = 'dolo';

        function renderLockCards(details, sortBy) {
            const now = Date.now() / 1000;
            const MAX_LOCK = 2 * 365 * 86400; // 2 years max lock

            const sorted = [...details].sort((a, b) => {
                switch (sortBy) {
                    case 'vote': return (b.vote_weight || 0) - (a.vote_weight || 0);
                    case 'time': return (a.end || 0) - (b.end || 0);
                    default: return (b.dolo || 0) - (a.dolo || 0);
                }
            });

            return sorted.map(d => {
                const dolo = (d.dolo || 0);
                const vw = (d.vote_weight || 0);
                const mult = dolo > 0 ? (vw / dolo) : 0;
                const secsLeft = Math.max(0, (d.end || 0) - now);
                const daysLeft = Math.ceil(secsLeft / 86400);
                const maturity = d.end ? new Date(d.end * 1000).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                }) : '—';

                // Progress: how much time has elapsed (estimate: max lock is 2yr)
                const totalLockTime = MAX_LOCK;
                const elapsed = totalLockTime - secsLeft;
                const progressPct = Math.min(100, Math.max(0, (elapsed / totalLockTime) * 100));
                const progressClass = daysLeft === 0 ? 'expired' : daysLeft < 90 ? 'expiring' : 'active';

                const nftUrl = `https://berascan.com/nft/0xcb86b75ee6133d179a12d550b09fb3cdb1e141d4/${d.id}`;
                return `<div class="lock-card" style="cursor:pointer" onclick="window.open('${nftUrl}','_blank')">
                    <div>
                        <div class="lock-card-title">Lock #${d.id} <span style="font-size:9px;color:var(--text-muted);margin-left:4px">↗ BeraChain</span></div>
                        <div class="lock-card-value">${dolo.toLocaleString('en-US', { maximumFractionDigits: 2 })}</div>
                        <div class="lock-card-sub">DOLO</div>
                    </div>
                    <div>
                        <div class="lock-card-label">Time Remaining</div>
                        <div class="lock-card-value sm">${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}</div>
                        <div class="lock-card-sub">Matures on ${maturity}</div>
                        <div class="lock-progress"><div class="lock-progress-fill ${progressClass}" style="width:${progressPct}%"></div></div>
                    </div>
                    <div class="lock-card-vote">
                        <div class="lock-card-label">Vote Weight</div>
                        <div class="lock-card-value">${vw.toLocaleString('en-US', { maximumFractionDigits: 4 })}</div>
                        <div class="lock-multiplier">${mult.toFixed(2)}x multiplier</div>
                    </div>
                </div>`;
            }).join('');
        }

        function copyAddr(addr, el) {
            navigator.clipboard.writeText(addr).then(() => {
                el.classList.add('copied');
                const origSvg = el.innerHTML;
                el.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
                setTimeout(() => {
                    el.innerHTML = origSvg;
                    el.classList.remove('copied');
                }, 1500);
            });
        }

        function showProfile(address) {
            const holder = HOLDER_DATA.find(h => h.address.toLowerCase() === address.toLowerCase());
            if (!holder) return;
            currentProfileAddr = holder.address;
            currentLockSort = 'dolo';

            document.getElementById('pm-rank').textContent = `#${holder.rank}`;
            document.getElementById('pm-addr').textContent = holder.address;

            const totalVote = (holder.total_vote_weight || 0);
            const totalDolo = (holder.total_dolo || 0);
            const supplyPct = STATS.total_locked_dolo ? ((totalDolo / STATS.total_locked_dolo) * 100).toFixed(2) : '0';
            document.getElementById('pm-vote').textContent = totalVote.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('pm-dolo').textContent = totalDolo.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('pm-dolo-pct').textContent = `${supplyPct}% of total · DOLO`;

            const details = holder.token_details || [];
            document.getElementById('pm-locks-title').textContent = `Active Locks (${details.length})`;

            // Lock sort buttons
            document.getElementById('pm-lock-sort').innerHTML = [
                { key: 'dolo', label: 'DOLO ↓' },
                { key: 'vote', label: 'Vote ↓' },
                { key: 'time', label: 'Expiry ↑' }
            ].map(s => `<button class="lock-sort-btn ${s.key === currentLockSort ? 'active' : ''}" onclick="sortLocks('${s.key}')">${s.label}</button>`).join('');

            document.getElementById('pm-locks').innerHTML = renderLockCards(details, currentLockSort);

            document.getElementById('pm-berascan').href = `https://berascan.com/address/${holder.address}`;
            document.getElementById('pm-debank').href = `https://debank.com/profile/${holder.address}?chain=bera`;

            document.getElementById('profile-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            history.replaceState(null, '', `#address=${holder.address}`);
        }

        function sortLocks(key) {
            currentLockSort = key;
            const holder = HOLDER_DATA.find(h => h.address === currentProfileAddr);
            if (!holder) return;

            document.querySelectorAll('.lock-sort-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.lock-sort-btn[onclick="sortLocks('${key}')"]`).classList.add('active');
            document.getElementById('pm-locks').innerHTML = renderLockCards(holder.token_details || [], key);
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.remove('active');
            document.body.style.overflow = '';
            currentProfileAddr = null;
            history.replaceState(null, '', window.location.pathname);
        }

        function copyFromModal() {
            if (!currentProfileAddr) return;
            navigator.clipboard.writeText(currentProfileAddr);
            const t = document.getElementById('copy-toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                if (document.getElementById('compare-modal').classList.contains('active')) {
                    closeCompare();
                } else {
                    closeProfile();
                }
            }
        });

        function checkHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#address=')) {
                const addr = hash.slice(9);
                if (addr && HOLDER_DATA.length > 0) showProfile(addr);
            }
        }

        window.addEventListener('hashchange', checkHash);

        // ===== COMPARE TOOL =====
        function toggleCompare(addr, checked) {
            if (checked) {
                if (compareSet.size >= 3) {
                    alert('Max 3 holders for comparison');
                    renderTable(); // re-render to uncheck
                    return;
                }
                compareSet.add(addr);
            } else {
                compareSet.delete(addr);
            }
            updateCompareBar();
        }

        function updateCompareBar() {
            const bar = document.getElementById('compare-bar');
            const count = document.getElementById('compare-count');
            if (compareSet.size > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${compareSet.size} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        function clearCompare() {
            compareSet.clear();
            updateCompareBar();
            renderTable();
        }

        function openCompare() {
            if (compareSet.size < 2) {
                alert('Select at least 2 holders to compare');
                return;
            }

            const holders = [...compareSet].map(addr =>
                HOLDER_DATA.find(h => h.address.toLowerCase() === addr.toLowerCase())
            ).filter(Boolean);

            const totalDolo = STATS.total_locked_dolo || 1;
            const cols = holders.length;

            document.getElementById('compare-body').innerHTML = `
                <div class="compare-grid" style="grid-template-columns: repeat(${cols}, 1fr)">
                    ${holders.map(h => {
                const supPct = ((h.total_dolo || 0) / totalDolo * 100).toFixed(2);
                const avgMult = (h.total_dolo || 0) > 0 ? ((h.total_vote_weight || 0) / (h.total_dolo || 1)).toFixed(2) : '0';
                return `<div class="compare-col">
                            <div class="compare-col-header">#${h.rank} — ${h.address.slice(0, 8)}…${h.address.slice(-6)}</div>
                            <div class="compare-metric">
                                <span class="compare-metric-label">NFTs</span>
                                <span class="compare-metric-value">${h.nft_count}</span>
                            </div>
                            <div class="compare-metric">
                                <span class="compare-metric-label">Locked DOLO</span>
                                <span class="compare-metric-value" style="color:var(--accent-green)">${fmtDolo(h.total_dolo || 0)}</span>
                            </div>
                            <div class="compare-metric">
                                <span class="compare-metric-label">Supply %</span>
                                <span class="compare-metric-value">${supPct}%</span>
                            </div>
                            <div class="compare-metric">
                                <span class="compare-metric-label">Vote Weight</span>
                                <span class="compare-metric-value" style="color:#f59e0b">${fmtDolo(h.total_vote_weight || 0)}</span>
                            </div>
                            <div class="compare-metric">
                                <span class="compare-metric-label">Avg Multiplier</span>
                                <span class="compare-metric-value">${avgMult}x</span>
                            </div>
                            <div class="compare-metric">
                                <span class="compare-metric-label">Locks</span>
                                <span class="compare-metric-value">${(h.token_details || []).length}</span>
                            </div>
                        </div>`;
            }).join('')}
                </div>
            `;

            document.getElementById('compare-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCompare() {
            document.getElementById('compare-modal').classList.remove('active');
            if (!document.getElementById('profile-modal').classList.contains('active')) {
                document.body.style.overflow = '';
            }
        }

        // ===== TAB SWITCHING =====
        let currentView = 'dolo';
        let odoloLoaded = false;
        let doloLoaded = false;

        function switchView(view) {
            if (view === currentView) return;
            currentView = view;

            // Toggle view sections
            ['vedolo', 'odolo', 'dolo', 'earn'].forEach(v => {
                document.getElementById('view-' + v).classList.toggle('active', view === v);
                document.getElementById('tab-' + v).classList.toggle('active', view === v);
            });

            // Update page title
            const titles = { vedolo: 'veDOLO', odolo: 'oDOLO', dolo: 'DOLO', earn: 'EARN' };
            document.title = (titles[view] || 'Dashboard') + ' — Berachain Dashboard';

            // Lazy load oDOLO data on first switch
            // Data is preloaded eagerly on page load, no lazy loading needed

            // Re-render oDOLO donut on switch (canvas needs visible dimensions)
            if (view === 'odolo' && odolo_cachedData) {
                setTimeout(() => odolo_renderDonut(odolo_cachedData), 50);
            }

            // Re-render DOLO charts on switch
            if (view === 'dolo' && dolo_cachedData) {
                setTimeout(() => {
                    dolo_renderTvlChart(dolo_cachedData);
                    dolo_renderTokenDonut(dolo_cachedData);
                }, 50);
            }

            // Focus the earn input when switching to earn tab
            if (view === 'earn') {
                setTimeout(() => document.getElementById('earn-address').focus(), 100);
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== oDOLO NAMESPACE =====
        const ODOLO_RPC_URLS = [
            'https://rpc.berachain.com/',
            'https://berachain-rpc.publicnode.com/',
            'https://berachain.drpc.org/',
        ];
        const ODOLO_TOKEN = '0x02E513b5B54eE216Bf836ceb471507488fC89543';
        const ODOLO_VESTER = '0x3E9b9A16743551DA49b5e136C716bBa7932d2cEc';

        const ODOLO_SEL = {
            totalSupply: '0x18160ddd',
            balanceOf: '0x70a08231',
            decimals: '0x313ce567',
            promisedTokens: '0x5e17b694',
            pushedTokens: '0x818c16e2',
            availableTokens: '0x69bb4dc2',
        };

        let odolo_rpcId = 1000;
        let odolo_rpcUrlIdx = 0;
        let odolo_cachedData = null;

        function odolo_getRpcUrl() {
            return ODOLO_RPC_URLS[odolo_rpcUrlIdx % ODOLO_RPC_URLS.length];
        }

        async function odolo_rpcCall(to, data, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const resp = await fetch(odolo_getRpcUrl(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'eth_call',
                            params: [{ to, data }, 'latest'],
                            id: odolo_rpcId++
                        })
                    });
                    const json = await resp.json();
                    if (json.error) {
                        console.warn(`oDOLO RPC error:`, json.error);
                        odolo_rpcUrlIdx++;
                        continue;
                    }
                    return json.result || '0x0';
                } catch (err) {
                    console.warn(`oDOLO RPC failed (attempt ${attempt + 1}):`, err.message);
                    odolo_rpcUrlIdx++;
                    await new Promise(r => setTimeout(r, 300 * (attempt + 1)));
                }
            }
            return '0x0';
        }

        async function odolo_rpcBatch3(calls) {
            try {
                const batch = calls.map((c, i) => ({
                    jsonrpc: '2.0',
                    method: 'eth_call',
                    params: [{ to: c.to, data: c.data }, 'latest'],
                    id: i + 1000
                }));
                const resp = await fetch(odolo_getRpcUrl(), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(batch)
                });
                const results = await resp.json();
                if (Array.isArray(results)) {
                    results.sort((a, b) => a.id - b.id);
                    return results.map(r => r.result || '0x0');
                }
                const out = [];
                for (const c of calls) out.push(await odolo_rpcCall(c.to, c.data));
                return out;
            } catch (err) {
                const out = [];
                for (const c of calls) out.push(await odolo_rpcCall(c.to, c.data));
                return out;
            }
        }

        function odolo_decodeUint256(hex) {
            if (!hex || hex === '0x' || hex === '0x0') return 0n;
            const clean = hex.replace('0x', '').slice(0, 64);
            return BigInt('0x' + (clean || '0'));
        }

        function odolo_padAddress(addr) {
            return addr.replace('0x', '').toLowerCase().padStart(64, '0');
        }

        function odolo_formatNum(n, decimals = 2) {
            if (n >= 1e9) return (n / 1e9).toFixed(decimals) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(decimals) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(decimals) + 'K';
            return n.toFixed(decimals);
        }

        function odolo_formatFullNum(n) {
            return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        async function odolo_fetchAllData() {
            console.log('🔄 Fetching oDOLO data...');
            try {
                let totalSupply, availableTokens, promisedTokens, pushedTokens, inCirculation;

                // Try static JSON first (pre-fetched by GitHub Actions)
                let usedStatic = false;
                try {
                    const contractResp = await fetch('odolo_contract_data.json');
                    if (contractResp.ok) {
                        const cd = await contractResp.json();
                        if (cd.totalSupply && cd.totalSupply > 0) {
                            totalSupply = cd.totalSupply;
                            availableTokens = cd.availableTokens;
                            promisedTokens = cd.promisedTokens;
                            pushedTokens = cd.pushedTokens;
                            inCirculation = cd.inCirculation || (totalSupply - availableTokens - promisedTokens);
                            usedStatic = true;
                            console.log('✅ oDOLO: Loaded contract data from static JSON');
                        }
                    }
                } catch (e) {
                    console.warn('⚠️ oDOLO: odolo_contract_data.json not available:', e.message);
                }

                // Fallback to live RPC if static not available
                if (!usedStatic) {
                    console.log('🔄 oDOLO: Falling back to live RPC...');
                    const batch1 = await odolo_rpcBatch3([
                        { to: ODOLO_TOKEN, data: ODOLO_SEL.totalSupply },
                        { to: ODOLO_TOKEN, data: ODOLO_SEL.decimals },
                        { to: ODOLO_TOKEN, data: ODOLO_SEL.balanceOf + odolo_padAddress(ODOLO_VESTER) },
                    ]);
                    const batch2 = await odolo_rpcBatch3([
                        { to: ODOLO_VESTER, data: ODOLO_SEL.promisedTokens },
                        { to: ODOLO_VESTER, data: ODOLO_SEL.pushedTokens },
                        { to: ODOLO_VESTER, data: ODOLO_SEL.availableTokens },
                    ]);

                    const oDec = Number(odolo_decodeUint256(batch1[1])) || 18;
                    const divisor = 10 ** oDec;

                    totalSupply = Number(odolo_decodeUint256(batch1[0])) / divisor;
                    const inVesterBalance = Number(odolo_decodeUint256(batch1[2])) / divisor;
                    promisedTokens = Number(odolo_decodeUint256(batch2[0])) / divisor;
                    pushedTokens = Number(odolo_decodeUint256(batch2[1])) / divisor;
                    availableTokens = Number(odolo_decodeUint256(batch2[2])) / divisor;
                    inCirculation = totalSupply - availableTokens - promisedTokens;
                    console.log('✅ oDOLO: Loaded from live RPC');
                }

                console.log('✅ oDOLO data fetched:', { totalSupply, promisedTokens, pushedTokens, availableTokens, inCirculation });

                odolo_cachedData = {
                    totalSupply, availableTokens, inCirculation,
                    promisedTokens, pushedTokens,
                };

                try {
                    const usdResp = await fetch('exercised_usd.json');
                    if (usdResp.ok) {
                        const usdData = await usdResp.json();
                        odolo_cachedData.exercisedUsd = usdData.total_usdc;
                        odolo_cachedData.exercisedTxs = usdData.total_txs;
                        odolo_cachedData.exercisedUpdated = usdData.last_updated;
                    }
                } catch (e) { console.warn('⚠️ oDOLO: exercised_usd.json error:', e); }

                try {
                    const lockResp = await fetch('avg_lock_data.json');
                    if (lockResp.ok) {
                        const lockData = await lockResp.json();
                        odolo_cachedData.avgLockDays = lockData.avg_lock_days;
                        odolo_cachedData.avgLockMonths = lockData.avg_lock_months;
                        odolo_cachedData.avgDiscountPct = lockData.avg_discount_pct;
                    }
                } catch (e) { console.warn('⚠️ oDOLO: avg_lock_data.json error:', e); }

                return odolo_cachedData;
            } catch (err) {
                console.error('❌ oDOLO fetch error:', err);
                return null;
            }
        }

        function odolo_renderMetrics(data) {
            if (!data) return;
            document.getElementById('o-m-supply').innerHTML = odolo_formatNum(data.totalSupply) + ' <img src="odolo-logo-official.svg" class="metric-icon">';
            document.getElementById('o-m-holders').textContent = '1,724';
            document.getElementById('o-m-vester').textContent = odolo_formatNum(data.availableTokens);
            const vesterPct = data.totalSupply > 0 ? ((data.availableTokens / data.totalSupply) * 100).toFixed(1) : '0';
            document.getElementById('o-m-vester-pct').textContent = vesterPct + '% of supply';
            document.getElementById('o-m-vesting').textContent = odolo_formatNum(data.promisedTokens);
            document.getElementById('o-m-exercised').innerHTML = odolo_formatNum(data.pushedTokens) + ' <img src="vedolo-logo.svg" class="metric-icon">';

            if (data.exercisedUsd && data.exercisedUsd > 0) {
                document.getElementById('o-m-revenue').textContent = '$' + odolo_formatNum(data.exercisedUsd);
                const updDate = data.exercisedUpdated
                    ? new Date(data.exercisedUpdated).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : '';
                document.getElementById('o-m-revenue-sub').textContent =
                    data.exercisedTxs + ' exercises' + (updDate ? ' · updated ' + updDate : '');
            } else {
                document.getElementById('o-m-revenue').textContent = '—';
                document.getElementById('o-m-revenue-sub').textContent = 'data pending';
            }

            if (data.exercisedUsd && data.pushedTokens > 0) {
                const avgPrice = data.exercisedUsd / data.pushedTokens;
                document.getElementById('o-m-avg-price').textContent = '$' + avgPrice.toFixed(4);
            } else {
                document.getElementById('o-m-avg-price').textContent = '—';
            }

            if (data.avgLockDays) {
                document.getElementById('o-m-avg-lock').textContent = Math.round(data.avgLockDays) + ' days';
                document.getElementById('o-m-avg-lock-sub').textContent = '~' + (data.avgLockDays / 30.44).toFixed(1) + ' months';
            } else {
                document.getElementById('o-m-avg-lock').textContent = '—';
                document.getElementById('o-m-avg-lock-sub').textContent = 'data pending';
            }

            if (data.avgDiscountPct) {
                document.getElementById('o-m-avg-discount').textContent = data.avgDiscountPct.toFixed(1) + '%';
            } else {
                document.getElementById('o-m-avg-discount').textContent = '—';
            }
        }

        // ===== oDOLO DONUT =====
        let odolo_donutSegments = [];
        let odolo_donutTotal = 0;
        let odolo_donutCx = 0, odolo_donutCy = 0, odolo_donutOuterR = 0, odolo_donutInnerR = 0;
        let odolo_hoveredSegIdx = -1;

        function odolo_renderDonut(data) {
            if (!data) return;

            const canvas = document.getElementById('o-dist-donut');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0) return; // not visible yet
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            const segments = [
                { label: 'Available in Vester', value: data.availableTokens, color: '#22d3ee' },
                { label: 'In Circulation', value: data.inCirculation, color: '#fbbf24' },
                { label: 'Currently Vesting', value: data.promisedTokens, color: '#6366f1' },
                { label: 'Exercised (Redeemed)', value: data.pushedTokens, color: '#34d399' },
            ].filter(s => s.value > 0);

            const total = segments.reduce((s, seg) => s + seg.value, 0);
            odolo_donutSegments = segments;
            odolo_donutTotal = total;
            odolo_donutCx = rect.width / 2;
            odolo_donutCy = rect.height / 2;
            odolo_donutOuterR = Math.min(rect.width, rect.height) / 2 - 20;
            odolo_donutInnerR = odolo_donutOuterR * 0.65;

            const gap = 0.02;
            let angle = -Math.PI / 2;
            segments.forEach(seg => {
                const slice = (seg.value / total) * (Math.PI * 2 - gap * segments.length);
                seg.startAngle = angle + gap / 2;
                seg.endAngle = angle + slice - gap / 2;
                angle += slice + gap;
            });

            odolo_drawDonut(-1);

            document.getElementById('o-donut-total').textContent = odolo_formatNum(data.totalSupply);

            const legend = document.getElementById('o-dist-legend');
            legend.innerHTML = segments.map((seg, i) => `
                <div class="odolo-legend-item" data-seg-idx="${i}" style="cursor:pointer; padding: 4px 6px; border-radius: 6px; transition: background 0.2s;">
                    <span class="odolo-legend-dot" style="background: ${seg.color}"></span>
                    <span class="odolo-legend-label">${seg.label}</span>
                    <span class="odolo-legend-value">${odolo_formatNum(seg.value)} (${((seg.value / total) * 100).toFixed(1)}%)</span>
                </div>
            `).join('');

            legend.querySelectorAll('.odolo-legend-item').forEach(item => {
                const idx = parseInt(item.dataset.segIdx);
                item.addEventListener('mouseenter', () => {
                    odolo_hoveredSegIdx = idx;
                    odolo_drawDonut(idx);
                    odolo_highlightLegend(idx);
                });
                item.addEventListener('mouseleave', () => {
                    odolo_hoveredSegIdx = -1;
                    odolo_drawDonut(-1);
                    odolo_highlightLegend(-1);
                });
            });

            canvas.addEventListener('mousemove', (e) => {
                const mRect = canvas.getBoundingClientRect();
                const mx = e.clientX - mRect.left;
                const my = e.clientY - mRect.top;
                const idx = odolo_getHoveredSegment(mx, my);

                if (idx !== odolo_hoveredSegIdx) {
                    odolo_hoveredSegIdx = idx;
                    odolo_drawDonut(idx);
                    odolo_highlightLegend(idx);
                }

                const tooltip = document.getElementById('o-donut-tooltip');
                if (idx >= 0) {
                    canvas.style.cursor = 'pointer';
                    const seg = odolo_donutSegments[idx];
                    const pct = ((seg.value / odolo_donutTotal) * 100).toFixed(1);
                    tooltip.innerHTML = `
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                            <span style="width:10px;height:10px;border-radius:3px;background:${seg.color};display:inline-block;"></span>
                            <strong>${seg.label}</strong>
                        </div>
                        <div style="color:#94a3b8; font-size:12px;">
                            ${odolo_formatFullNum(Math.round(seg.value))} oDOLO · <span style="color:${seg.color};font-weight:600;">${pct}%</span> of supply
                        </div>
                    `;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX + 14) + 'px';
                    tooltip.style.top = (e.clientY - 20) + 'px';
                } else {
                    canvas.style.cursor = 'default';
                    tooltip.style.display = 'none';
                }
            });

            canvas.addEventListener('mouseleave', () => {
                odolo_hoveredSegIdx = -1;
                odolo_drawDonut(-1);
                odolo_highlightLegend(-1);
                canvas.style.cursor = 'default';
                document.getElementById('o-donut-tooltip').style.display = 'none';
            });
        }

        function odolo_getHoveredSegment(mx, my) {
            const dx = mx - odolo_donutCx;
            const dy = my - odolo_donutCy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < odolo_donutInnerR || dist > odolo_donutOuterR + 10) return -1;
            let ang = Math.atan2(dy, dx);
            if (ang < -Math.PI / 2) ang += Math.PI * 2;
            for (let i = 0; i < odolo_donutSegments.length; i++) {
                let start = odolo_donutSegments[i].startAngle;
                let end = odolo_donutSegments[i].endAngle;
                if (start < -Math.PI / 2) start += Math.PI * 2;
                if (end < -Math.PI / 2) end += Math.PI * 2;
                if (ang >= start && ang <= end) return i;
            }
            return -1;
        }

        function odolo_drawDonut(hoverIdx) {
            const canvas = document.getElementById('o-dist-donut');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.scale(dpr, dpr);

            const cx = odolo_donutCx, cy = odolo_donutCy;
            const outerR = odolo_donutOuterR, innerR = odolo_donutInnerR;
            const pushOut = 8;

            odolo_donutSegments.forEach((seg, i) => {
                const isHovered = (i === hoverIdx);
                const midAngle = (seg.startAngle + seg.endAngle) / 2;
                const offX = isHovered ? Math.cos(midAngle) * pushOut : 0;
                const offY = isHovered ? Math.sin(midAngle) * pushOut : 0;
                const r = isHovered ? outerR + 4 : outerR;

                ctx.beginPath();
                ctx.arc(cx + offX, cy + offY, r, seg.startAngle, seg.endAngle);
                ctx.arc(cx + offX, cy + offY, innerR, seg.endAngle, seg.startAngle, true);
                ctx.closePath();
                ctx.fillStyle = seg.color;
                ctx.globalAlpha = (hoverIdx >= 0 && !isHovered) ? 0.4 : 1;
                ctx.fill();

                if (isHovered) {
                    ctx.shadowColor = seg.color;
                    ctx.shadowBlur = 16;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });

            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function odolo_highlightLegend(hoverIdx) {
            const items = document.querySelectorAll('#o-dist-legend .odolo-legend-item');
            items.forEach((item, i) => {
                if (hoverIdx >= 0 && i !== hoverIdx) {
                    item.style.opacity = '0.4';
                    item.style.background = 'transparent';
                } else if (i === hoverIdx) {
                    item.style.opacity = '1';
                    item.style.background = 'rgba(99, 102, 241, 0.1)';
                } else {
                    item.style.opacity = '1';
                    item.style.background = 'transparent';
                }
            });
        }

        // ===== EXERCISERS TABLE =====
        let EXERCISER_DATA = [];
        let exerciserSortKey = 'rank';
        let exerciserSortAsc = true;
        let exerciserSearchTerm = '';
        let currentExerciserAddr = '';
        let exerciserPage = 1;
        const EXERCISER_PER_PAGE = 25;

        async function loadExercisers() {
            try {
                const resp = await fetch('exercisers_by_address.json');
                if (!resp.ok) return;
                const json = await resp.json();
                EXERCISER_DATA = json.exercisers || [];
                renderExercisersTable();
            } catch (e) { console.warn('exercisers error:', e); }
        }

        const exFmtUsd = v => v >= 1000 ? '$' + v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '$' + v.toFixed(2);
        const exShortAddr = a => a.slice(0, 6) + '\u2026' + a.slice(-4);
        const exFmtDate = d => { if (!d) return '\u2014'; const p = d.split('-'); const m = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; return m[parseInt(p[1]) - 1] + ' ' + parseInt(p[2]) + ', ' + p[0].slice(2); };
        const exFmtLock = days => { if (!days) return '\u2014'; if (days >= 365) return (days / 365).toFixed(1) + 'y'; if (days >= 30) return Math.round(days / 30) + 'mo'; return Math.round(days) + 'd'; };

        function getExerciserAvgPrice(e) {
            let totalVedolo = 0;
            (e.txs || []).forEach(tx => { if (tx.vedolo) totalVedolo += tx.vedolo; });
            return totalVedolo > 0 ? e.total_usdc / totalVedolo : null;
        }

        function renderExercisersTable() {
            const tbody = document.getElementById('exercisers-tbody');
            if (!tbody) return;
            let data = [...EXERCISER_DATA];
            if (exerciserSearchTerm) data = data.filter(e => e.address.toLowerCase().includes(exerciserSearchTerm));

            data.sort((a, b) => {
                let va, vb;
                if (exerciserSortKey === 'rank' || exerciserSortKey === 'total_usdc') {
                    va = a.total_usdc; vb = b.total_usdc;
                    if (exerciserSortKey === 'rank') return exerciserSortAsc ? vb - va : va - vb;
                    return exerciserSortAsc ? va - vb : vb - va;
                }
                if (exerciserSortKey === 'exercises') { va = a.exercises; vb = b.exercises; return exerciserSortAsc ? va - vb : vb - va; }
                if (exerciserSortKey === 'avg_lock') { va = a.avg_lock_days || 0; vb = b.avg_lock_days || 0; return exerciserSortAsc ? va - vb : vb - va; }
                if (exerciserSortKey === 'avg_price') {
                    va = getExerciserAvgPrice(a) || 0; vb = getExerciserAvgPrice(b) || 0;
                    return exerciserSortAsc ? va - vb : vb - va;
                }
                if (exerciserSortKey === 'address') return exerciserSortAsc ? a.address.localeCompare(b.address) : b.address.localeCompare(a.address);
                if (exerciserSortKey === 'first' || exerciserSortKey === 'last') {
                    va = a[exerciserSortKey] || ''; vb = b[exerciserSortKey] || '';
                    return exerciserSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
                }
                return 0;
            });

            document.getElementById('exerciser-count').textContent = data.length + ' exercisers';

            // Paginate
            const totalPages = Math.ceil(data.length / EXERCISER_PER_PAGE);
            if (exerciserPage > totalPages) exerciserPage = totalPages || 1;
            const start = (exerciserPage - 1) * EXERCISER_PER_PAGE;
            const pageData = data.slice(start, start + EXERCISER_PER_PAGE);

            let html = '';
            pageData.forEach((e, i) => {
                const rank = start + i + 1;
                const isWhale = rank <= 10;
                const rc = rank <= 3 ? 'rank-' + rank : '';
                const avgPrice = getExerciserAvgPrice(e);
                const rowClass = isWhale ? 'exerciser-row whale-row' : 'exerciser-row';

                html += '<tr class="' + rowClass + '" onclick="openExerciserModal(\'' + e.address + '\',' + rank + ')">';
                html += '<td class="c-rank"><div class="rank-cell-inner">';
                if (rc) {
                    html += '<span class="rank-medal ' + rc + '">' + rank + '</span>';
                } else {
                    html += '<span class="rank-plain">' + rank + '</span>';
                }
                html += '</div></td>';
                html += '<td class="c-addr"><span style="display:inline-flex;align-items:center;gap:4px"><span class="addr-link">' + exShortAddr(e.address) + '</span><span class="copy-addr-icon" onclick="event.stopPropagation();copyAddr(\'' + e.address + '\',this)" title="Copy address"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span><a href="https://debank.com/profile/' + e.address + '?chain=bera" target="_blank" onclick="event.stopPropagation()" class="debank-icon" title="View on DeBank"><img src="https://debank.com/favicon.ico" width="14" height="14" onerror="this.parentElement.style.display=\'none\'"></a></span></td>';
                html += '<td class="c-num">' + exFmtUsd(e.total_usdc) + '</td>';
                html += '<td class="c-num">' + e.exercises + '</td>';
                html += '<td class="c-num">' + exFmtLock(e.avg_lock_days) + '</td>';
                html += '<td class="c-num" style="color:#34d399">' + (avgPrice ? '$' + avgPrice.toFixed(4) : '\u2014') + '</td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;

            // Render pagination
            renderExercisersPagination(data.length);
        }

        function renderExercisersPagination(total) {
            const totalPages = Math.ceil(total / EXERCISER_PER_PAGE);
            const el = document.getElementById('exerciser-pagination');
            if (!el || totalPages <= 1) { if (el) el.innerHTML = ''; return; }

            let h = `<button class="pg-btn" onclick="exerciserPage=1;renderExercisersTable()" ${exerciserPage === 1 ? 'disabled' : ''}>«</button>`;
            h += `<button class="pg-btn" onclick="exerciserPage--;renderExercisersTable()" ${exerciserPage === 1 ? 'disabled' : ''}>‹</button>`;

            for (let p = Math.max(1, exerciserPage - 1); p <= Math.min(totalPages, exerciserPage + 1); p++) {
                h += `<button class="pg-btn ${p === exerciserPage ? 'active' : ''}" onclick="exerciserPage=${p};renderExercisersTable()">${p}</button>`;
            }

            h += `<button class="pg-btn" onclick="exerciserPage++;renderExercisersTable()" ${exerciserPage === totalPages ? 'disabled' : ''}>›</button>`;
            h += `<button class="pg-btn" onclick="exerciserPage=${totalPages};renderExercisersTable()" ${exerciserPage === totalPages ? 'disabled' : ''}>»</button>`;
            h += `<span class="pg-info">${exerciserPage} / ${totalPages}</span>`;
            el.innerHTML = h;
        }

        function openExerciserModal(addr, rank) {
            const e = EXERCISER_DATA.find(x => x.address === addr);
            if (!e) return;
            currentExerciserAddr = addr;

            let totalVedolo = 0;
            (e.txs || []).forEach(tx => { if (tx.vedolo) totalVedolo += tx.vedolo; });
            const avgPrice = totalVedolo > 0 ? e.total_usdc / totalVedolo : null;

            document.getElementById('em-rank').textContent = '#' + rank;
            document.getElementById('em-addr').textContent = exShortAddr(addr);
            document.getElementById('em-usdc').textContent = exFmtUsd(e.total_usdc);
            document.getElementById('em-exercises').textContent = e.exercises;
            document.getElementById('em-period').textContent = exFmtDate(e.first) + ' \u2013 ' + exFmtDate(e.last);
            document.getElementById('em-avglock').textContent = exFmtLock(e.avg_lock_days);
            document.getElementById('em-avgprice').textContent = avgPrice ? '$' + avgPrice.toFixed(4) : '\u2014';
            document.getElementById('em-berascan').href = 'https://berascan.com/address/' + addr;
            document.getElementById('em-debank').href = 'https://debank.com/profile/' + addr + '?chain=bera';

            const txs = e.txs || [];
            let html = '<table class="detail-table"><thead><tr>';
            html += '<th style="width:36px">#</th>';
            html += '<th>Date</th>';
            html += '<th style="text-align:right">USDC.e Paid</th>';
            html += '<th style="text-align:right">veDOLO Received</th>';
            html += '<th style="text-align:right">Price/veDOLO</th>';
            html += '<th style="text-align:center">Lock</th>';
            html += '<th>Tx</th>';
            html += '</tr></thead><tbody>';
            txs.forEach((tx, i) => {
                const rowBg = i % 2 === 0 ? '' : 'background:rgba(255,255,255,0.02);';
                html += '<tr style="' + rowBg + 'cursor:pointer" onclick="window.open(\'https://berascan.com/tx/' + tx.hash + '\',\'_blank\')">';
                html += '<td>' + (i + 1) + '</td>';
                html += '<td>' + exFmtDate(tx.date) + '</td>';
                html += '<td style="text-align:right;font-family:JetBrains Mono,monospace;font-size:11px">' + exFmtUsd(tx.usdc) + '</td>';
                html += '<td style="text-align:right;font-family:JetBrains Mono,monospace;font-size:11px">' + (tx.vedolo != null ? tx.vedolo.toLocaleString('en-US', { maximumFractionDigits: 0 }) : '\u2014') + '</td>';
                html += '<td style="text-align:right;font-family:JetBrains Mono,monospace;font-size:11px;color:#34d399">' + (tx.price != null ? '$' + tx.price.toFixed(4) : '\u2014') + '</td>';
                html += '<td style="text-align:center">' + exFmtLock(tx.lock_days) + '</td>';
                html += '<td><a href="https://berascan.com/tx/' + tx.hash + '" target="_blank" class="tx-link" onclick="event.stopPropagation()">' + tx.hash.slice(0, 8) + '\u2026</a></td>';
                html += '</tr>';
            });
            if (txs.length > 1) {
                html += '<tr style="border-top:2px solid var(--border-subtle);font-weight:600;color:#fff">';
                html += '<td colspan="2" style="color:#fff">Total (' + txs.length + ' txs)</td>';
                html += '<td style="text-align:right;font-family:JetBrains Mono,monospace;font-size:11px;color:#fff">' + exFmtUsd(e.total_usdc) + '</td>';
                html += '<td style="text-align:right;font-family:JetBrains Mono,monospace;font-size:11px;color:#fff">' + (totalVedolo > 0 ? totalVedolo.toLocaleString('en-US', { maximumFractionDigits: 0 }) : '\u2014') + '</td>';
                html += '<td style="text-align:right;font-family:JetBrains Mono,monospace;font-size:11px;color:#34d399">' + (avgPrice ? '$' + avgPrice.toFixed(4) : '\u2014') + '</td>';
                html += '<td style="text-align:center;color:#fff">' + exFmtLock(e.avg_lock_days) + '</td>';
                html += '<td></td>';
                html += '</tr>';
            }
            html += '</tbody></table>';
            document.getElementById('em-txs').innerHTML = html;

            document.getElementById('exerciser-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeExerciserModal() {
            document.getElementById('exerciser-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function copyExerciserAddr() {
            navigator.clipboard.writeText(currentExerciserAddr);
            const toast = document.getElementById('copy-toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function sortExercisers(key) {
            const th = document.querySelector('#exercisers-table th[data-sort="' + key + '"]');
            if (exerciserSortKey === key) { exerciserSortAsc = !exerciserSortAsc; }
            else { exerciserSortKey = key; exerciserSortAsc = (key === 'rank' || key === 'total_usdc' || key === 'exercises' || key === 'avg_lock' || key === 'avg_price') ? false : true; if (key === 'rank') exerciserSortAsc = true; }
            document.querySelectorAll('#exercisers-table th').forEach(t => { t.classList.remove('sorted'); t.querySelector('.arrow').textContent = '\u21c5'; });
            th.classList.add('sorted');
            th.querySelector('.arrow').textContent = exerciserSortAsc ? '\u25b2' : '\u25bc';
            renderExercisersTable();
        }

        document.getElementById('exerciser-search')?.addEventListener('input', function () {
            exerciserSearchTerm = this.value.trim().toLowerCase();
            renderExercisersTable();
        });

        async function odolo_init() {
            const data = await odolo_fetchAllData();
            odolo_renderMetrics(data);
            odolo_renderDonut(data);
            loadExercisers();
        }

        // Redraw oDOLO donut on resize
        let odolo_resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(odolo_resizeTimer);
            odolo_resizeTimer = setTimeout(() => {
                if (odolo_cachedData && currentView === 'odolo') odolo_renderDonut(odolo_cachedData);
            }, 300);
        });

        // ===== DOLO TOKEN NAMESPACE =====
        let dolo_cachedData = null;
        let dolo_tvlPoints = [];
        let dolo_allTvlPoints = [];
        let dolo_currentRange = 360;
        let dolo_refreshTimer = null;

        function dolo_applyRange(days) {
            dolo_currentRange = days;
            if (days >= dolo_allTvlPoints.length) {
                dolo_tvlPoints = [...dolo_allTvlPoints];
            } else {
                dolo_tvlPoints = dolo_allTvlPoints.slice(-days);
            }
            dolo_updateChangeBadge();
        }

        function dolo_updateChangeBadge() {
            const badge = document.getElementById('dolo-tvl-change-badge');
            if (!badge || dolo_tvlPoints.length < 2) { if (badge) badge.style.display = 'none'; return; }
            const first = dolo_tvlPoints[0].tvl;
            const last = dolo_tvlPoints[dolo_tvlPoints.length - 1].tvl;
            if (!first || first === 0) { badge.style.display = 'none'; return; }
            const pctChange = ((last - first) / first) * 100;
            const sign = pctChange >= 0 ? '+' : '';
            const arrow = pctChange >= 0 ? '↑' : '↓';
            const rangeLabel = dolo_currentRange >= dolo_allTvlPoints.length ? 'ALL' :
                dolo_currentRange >= 360 ? '1Y' :
                    dolo_currentRange >= 180 ? '180D' :
                        dolo_currentRange >= 90 ? '90D' :
                            dolo_currentRange >= 30 ? '30D' : '7D';
            badge.className = 'tvl-change-badge ' + (pctChange >= 0 ? 'positive' : 'negative');
            badge.textContent = `${arrow} ${sign}${pctChange.toFixed(1)}% ${rangeLabel}`;
            badge.style.display = '';
        }

        function dolo_setRange(days) {
            if (days === dolo_currentRange) return;
            dolo_applyRange(days);
            dolo_brushStart = 0; dolo_brushEnd = 1;
            // Toggle active button
            document.querySelectorAll('.dolo-range-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });
            document.getElementById('dolo-reset-zoom-btn').style.display = 'none';
            dolo_renderTvlChart(dolo_cachedData);
        }

        function dolo_resetZoom() {
            dolo_brushStart = 0; dolo_brushEnd = 1;
            dolo_applyRange(dolo_currentRange);
            document.getElementById('dolo-reset-zoom-btn').style.display = 'none';
            document.querySelectorAll('.dolo-range-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === dolo_currentRange);
            });
            dolo_renderTvlChart(dolo_cachedData);
        }

        const DOLO_CHAIN_COLORS = {
            'Ethereum': '#627EEA', 'Berachain': '#D4A843', 'Arbitrum': '#28A0F0',
            'Botanix': '#4CAF50', 'Mantle': '#000', 'X Layer': '#8B5CF6', 'BoB': '#FF6B00',
            'Polygon zkEVM': '#7B3FE4'
        };
        const DOLO_CHAIN_LOGOS = {
            'Ethereum': 'https://icons.llamao.fi/icons/chains/rsz_ethereum.jpg',
            'Arbitrum': 'https://icons.llamao.fi/icons/chains/rsz_arbitrum.jpg',
            'Berachain': 'https://icons.llamao.fi/icons/chains/rsz_berachain.jpg',
            'Botanix': 'https://icons.llamao.fi/icons/chains/rsz_botanix.jpg',
            'Mantle': 'https://icons.llamao.fi/icons/chains/rsz_mantle.jpg',
            'X Layer': 'https://icons.llamao.fi/icons/chains/rsz_x%20layer.jpg',
            'BoB': 'https://icons.llamao.fi/icons/chains/rsz_bob.jpg',
            'Polygon zkEVM': 'https://icons.llamao.fi/icons/chains/rsz_polygon%20zkevm.jpg'
        };
        const DOLO_TOKEN_COLORS = ['#6366f1', '#22d3ee', '#34d399', '#fbbf24', '#fb7185', '#fb923c', '#a78bfa', '#f472b6', '#38bdf8', '#4ade80'];

        function dolo_fmt(n) {
            if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
            if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
            return '$' + n.toFixed(2);
        }

        async function dolo_init() {
            // Start loading holders immediately (parallel with everything else)
            dolo_loadHolders();

            // --- 1. Price data (from pre-fetched static JSON, always reliable) ---
            try {
                const priceData = await fetch('dolo_price.json').then(r => r.json());
                const cg = { usd: priceData.price, usd_market_cap: priceData.market_cap, usd_24h_vol: priceData.volume_24h, usd_24h_change: priceData.change_24h };
                const cgCoin = { market_data: { circulating_supply: priceData.circulating_supply, total_supply: priceData.total_supply, fully_diluted_valuation: { usd: priceData.fdv } } };

                const price = cg.usd || 0;
                const change = cg.usd_24h_change || 0;
                document.getElementById('dolo-price').textContent = '$' + price.toFixed(4);
                const changeEl = document.getElementById('dolo-change');
                const sign = change >= 0 ? '+' : '';
                changeEl.innerHTML = `<span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;background:${change >= 0 ? 'rgba(52,211,153,0.15)' : 'rgba(251,113,133,0.15)'};color:${change >= 0 ? 'var(--accent-green)' : 'var(--accent-rose)'}">${sign}${change.toFixed(2)}% 24h</span>`;
                document.getElementById('dolo-mcap').textContent = dolo_fmt(cg.usd_market_cap || 0);
                document.getElementById('dolo-vol').textContent = dolo_fmt(cg.usd_24h_vol || 0);

                const maxSupply = cgCoin?.market_data?.max_supply || cgCoin?.market_data?.total_supply || 1e9;
                const fdv = price * maxSupply;
                document.getElementById('dolo-fdv').textContent = dolo_fmt(fdv);

                const circSupply = cgCoin?.market_data?.circulating_supply || 0;
                const circEl = document.getElementById('dolo-circ-supply');
                if (circEl) circEl.textContent = circSupply > 0 ? (circSupply >= 1e9 ? (circSupply / 1e9).toFixed(2) + 'B' : circSupply >= 1e6 ? (circSupply / 1e6).toFixed(2) + 'M' : circSupply >= 1e3 ? (circSupply / 1e3).toFixed(1) + 'K' : circSupply.toFixed(0)) : '—';

                // Store for later use
                dolo_cachedData = { cg, cgCoin };

                // Auto-refresh price every 60s, but also fetch live price immediately
                if (dolo_refreshTimer) clearInterval(dolo_refreshTimer);
                dolo_refreshTimer = setInterval(dolo_refreshPrice, 60000);
                setTimeout(dolo_refreshPrice, 2000); // Replace stale JSON price with live CoinGecko ASAP
            } catch (err) {
                console.error('DOLO price error:', err);
                document.getElementById('dolo-price').textContent = 'Error';
            }

            // --- 2. DeFi Llama data (static JSON first, live API fallback) ---
            try {
                let llRes = null;
                try {
                    llRes = await fetch('defillama_data.json').then(r => r.json());
                    if (llRes.error) throw new Error('Static file has error: ' + llRes.error);
                    console.log('✅ DOLO: Loaded DeFi Llama from static JSON');
                } catch (staticErr) {
                    console.warn('⚠️ DOLO: Static defillama_data.json failed, trying live API...', staticErr.message);
                    llRes = await fetch('https://api.llama.fi/protocol/dolomite').then(r => r.json());
                    console.log('✅ DOLO: Loaded DeFi Llama from live API');
                }

                if (dolo_cachedData) dolo_cachedData.ll = llRes;
                else dolo_cachedData = { ll: llRes };

                const tvl = llRes.currentChainTvls || {};
                let totalTvl = 0;
                const chainTvls = [];
                const NON_CHAINS = ['borrowed', 'staking', 'pool2', 'vesting', 'offers', 'treasury', 'cex', 'governance'];
                for (const [chain, val] of Object.entries(tvl)) {
                    if (!chain.includes('-') && typeof val === 'number' && val > 0 && !NON_CHAINS.includes(chain.toLowerCase())) {
                        chainTvls.push({ chain, tvl: val });
                        totalTvl += val;
                    }
                }
                chainTvls.sort((a, b) => b.tvl - a.tvl);

                document.getElementById('dolo-tvl').textContent = dolo_fmt(totalTvl);

                const totalBorrowed = tvl['borrowed'] || 0;
                const supplyLiquidity = totalTvl + totalBorrowed;

                dolo_renderChainBars(chainTvls, totalTvl, tvl, totalBorrowed, supplyLiquidity);

                const tvlHist = llRes.tvl || [];
                dolo_allTvlPoints = tvlHist.map(p => ({ date: new Date(p.date * 1000), tvl: p.totalLiquidityUSD }));
                dolo_currentRange = 360;
                dolo_applyRange(360);
                dolo_renderTvlChart(dolo_cachedData);

                dolo_renderTokenDonut(dolo_cachedData);
                dolo_renderProtocolInfo(llRes);
            } catch (err) {
                console.error('DOLO DeFi Llama error:', err);
                document.getElementById('dolo-tvl').textContent = '—';
            }
        }

        async function dolo_refreshPrice() {
            // Refresh regardless of current tab — price is used globally
            try {
                // Try live CoinGecko first
                let price, ch;
                try {
                    const ctrl = new AbortController();
                    setTimeout(() => ctrl.abort(), 5000);
                    const resp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=dolomite&vs_currencies=usd&include_24hr_change=true', { signal: ctrl.signal });
                    const data = await resp.json();
                    price = data?.dolomite?.usd;
                    ch = data?.dolomite?.usd_24h_change || 0;
                } catch (_) {
                    // Fallback to static JSON
                    const pd = await fetch('dolo_price.json').then(r => r.json());
                    price = pd.price;
                    ch = pd.change_24h || 0;
                }
                if (price) {
                    document.getElementById('dolo-price').textContent = '$' + price.toFixed(4);
                    const sign = ch >= 0 ? '+' : '';
                    document.getElementById('dolo-change').innerHTML = `<span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;background:${ch >= 0 ? 'rgba(52,211,153,0.15)' : 'rgba(251,113,133,0.15)'};color:${ch >= 0 ? 'var(--accent-green)' : 'var(--accent-rose)'}">${sign}${ch.toFixed(2)}% 24h</span>`;
                }
            } catch (e) { /* silent */ }
        }

        // ===== DOLO HOLDERS TABLE =====
        let dolo_holderData = [];
        let dolo_holderFiltered = [];
        let dolo_holderPage = 1;
        let dolo_holderSortField = 'rank';
        let dolo_holderSortAsc = true;
        const DOLO_HOLDER_PER_PAGE = 25;

        const ETH_CHAIN_ICON = `<img src="https://icons.llamao.fi/icons/chains/rsz_ethereum.jpg" width="14" height="14" style="border-radius:50%;flex-shrink:0" alt="ETH">`;
        const BERA_CHAIN_ICON = `<img src="https://icons.llamao.fi/icons/chains/rsz_berachain.jpg" width="14" height="14" style="border-radius:50%;flex-shrink:0" alt="BERA">`;

        async function dolo_loadHolders() {
            try {
                const resp = await fetch('dolo_holders.json');
                if (!resp.ok) throw new Error('Not found');
                const data = await resp.json();
                dolo_holderData = data.holders || [];
                dolo_holderFiltered = [...dolo_holderData];
                dolo_renderHoldersTable();
                dolo_renderHoldersPagination();

                document.getElementById('dolo-holder-search').addEventListener('input',
                    debounce(dolo_applyHolderFilters, 200));

                document.getElementById('dolo-holders-card').style.display = '';
            } catch (e) {
                console.warn('dolo_holders.json not available:', e.message);
                document.getElementById('dolo-holder-tbody').innerHTML =
                    '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">⚠️ Place dolo_holders.json in the same directory.<br><code style="font-size:11px;opacity:0.7">python3 generate_dolo_holders.py</code></td></tr>';
            }
        }

        function dolo_fmtBal(n) {
            if (!n) return '0';
            if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function dolo_getDisplayBalance(h) {
            const showEth = document.getElementById('dolo-filter-eth')?.checked ?? true;
            const showBera = document.getElementById('dolo-filter-bera')?.checked ?? true;
            if (showEth && !showBera) return h.balance_eth || 0;
            if (!showEth && showBera) return h.balance_bera || 0;
            return h.balance;
        }

        // Toggle ETH/BERA — just re-render, never hide columns
        function dolo_toggleChainColumns() {
            dolo_applyHolderFilters();
        }

        function dolo_renderHoldersTable() {
            const tbody = document.getElementById('dolo-holder-tbody');
            const start = (dolo_holderPage - 1) * DOLO_HOLDER_PER_PAGE;
            const page = dolo_holderFiltered.slice(start, start + DOLO_HOLDER_PER_PAGE);
            const showEth = document.getElementById('dolo-filter-eth')?.checked ?? true;
            const showBera = document.getElementById('dolo-filter-bera')?.checked ?? true;

            // Update balance header text
            const balHeader = document.getElementById('dolo-balance-header');
            if (balHeader) {
                if (showEth && !showBera) balHeader.textContent = 'Balance (ETH)';
                else if (!showEth && showBera) balHeader.textContent = 'Balance (BERA)';
                else balHeader.textContent = 'Balance';
            }

            const totalSupply = dolo_holderFiltered.reduce((s, h) => s + dolo_getDisplayBalance(h), 0) || 1;

            tbody.innerHTML = page.map((h, idx) => {
                const dispRank = start + idx + 1;
                const rc = dispRank <= 3 ? `rank-${dispRank}` : '';
                const isWhale = dispRank <= 10;
                const dispBal = dolo_getDisplayBalance(h);
                const supplyPct = ((dispBal / totalSupply) * 100).toFixed(2);
                const balExact = dispBal.toLocaleString('en-US', { maximumFractionDigits: 2 });

                const dbUrl = `https://debank.com/profile/${h.address}`;
                const ethUrl = `https://etherscan.io/address/${h.address}`;
                const beraUrl = `https://berascan.com/address/${h.address}`;

                const ethBal = h.balance_eth || 0;
                const beraBal = h.balance_bera || 0;

                // ETH cell: show value if checked, empty dash if unchecked
                const ethCell = showEth
                    ? (ethBal > 0 ? `<a href="${ethUrl}" target="_blank" onclick="event.stopPropagation()" style="color:var(--accent-green);text-decoration:none" title="View on Etherscan: ${ethBal.toLocaleString('en-US')} DOLO">${dolo_fmtBal(ethBal)}</a>` : '<span style="opacity:0.3">—</span>')
                    : '<span style="opacity:0.15">—</span>';

                // BERA cell: show value if checked, empty dash if unchecked
                const beraCell = showBera
                    ? (beraBal > 0 ? `<a href="${beraUrl}" target="_blank" onclick="event.stopPropagation()" style="color:#f59e0b;text-decoration:none" title="View on Berascan: ${beraBal.toLocaleString('en-US')} DOLO">${dolo_fmtBal(beraBal)}</a>` : '<span style="opacity:0.3">—</span>')
                    : '<span style="opacity:0.15">—</span>';

                return `<tr class="${isWhale ? 'whale-row' : ''}" style="cursor:pointer" onclick="window.open('${dbUrl}','_blank')">
                        <td class="c-rank">
                            <div class="rank-cell-inner">
                                ${rc ? `<span class="rank-medal ${rc}">${dispRank}</span>` : `<span class="rank-plain">${dispRank}</span>`}
                            </div>
                        </td>
                        <td class="c-addr">
                            <span style="display:inline-flex;align-items:center;gap:4px">
                                <a href="${dbUrl}" target="_blank" onclick="event.stopPropagation()" class="dolo-holder-addr" title="${h.address}">${h.address.slice(0, 6)}…${h.address.slice(-4)}</a>
                                <span class="copy-addr-icon" onclick="event.stopPropagation();copyAddr('${h.address}',this)" title="Copy address"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span>
                                <a href="${dbUrl}" target="_blank" onclick="event.stopPropagation()" class="debank-icon" title="View on DeBank"><img src="https://debank.com/favicon.ico" width="14" height="14" onerror="this.parentElement.style.display='none'"></a>
                            </span>
                        </td>
                        <td class="c-dolo" style="text-align:right">${ethCell}</td>
                        <td class="c-dolo" style="text-align:right">${beraCell}</td>
                        <td class="c-dolo" style="text-align:right" title="${balExact} DOLO">${dolo_fmtBal(dispBal)}<span class="supply-pct">(${supplyPct}%)</span></td>
                    </tr>`;
            }).join('');

            document.getElementById('dolo-holder-results-count').textContent =
                `${dolo_holderFiltered.length.toLocaleString('en-US')} results`;
        }

        function dolo_renderHoldersPagination() {
            const total = Math.ceil(dolo_holderFiltered.length / DOLO_HOLDER_PER_PAGE);
            const el = document.getElementById('dolo-holder-pagination');
            if (total <= 1) { el.innerHTML = ''; return; }

            let h = `<button class="pg-btn" onclick="dolo_goHolderPage(1)" ${dolo_holderPage === 1 ? 'disabled' : ''}>«</button>`;
            h += `<button class="pg-btn" onclick="dolo_goHolderPage(${dolo_holderPage - 1})" ${dolo_holderPage === 1 ? 'disabled' : ''}>‹</button>`;

            for (let p = Math.max(1, dolo_holderPage - 1); p <= Math.min(total, dolo_holderPage + 1); p++) {
                h += `<button class="pg-btn ${p === dolo_holderPage ? 'active' : ''}" onclick="dolo_goHolderPage(${p})">${p}</button>`;
            }

            h += `<button class="pg-btn" onclick="dolo_goHolderPage(${dolo_holderPage + 1})" ${dolo_holderPage === total ? 'disabled' : ''}>›</button>`;
            h += `<button class="pg-btn" onclick="dolo_goHolderPage(${total})" ${dolo_holderPage === total ? 'disabled' : ''}>»</button>`;
            h += `<span class="pg-info">${dolo_holderPage} / ${total}</span>`;
            el.innerHTML = h;
        }

        function dolo_goHolderPage(p) {
            const t = Math.ceil(dolo_holderFiltered.length / DOLO_HOLDER_PER_PAGE);
            dolo_holderPage = Math.max(1, Math.min(p, t));
            dolo_renderHoldersTable();
            dolo_renderHoldersPagination();
            const card = document.getElementById('dolo-holders-card');
            if (card) card.querySelector('.table-scroll').scrollTop = 0;
        }

        function dolo_sortHolders(field) {
            const card = document.getElementById('dolo-holders-card');
            card.querySelectorAll('thead th').forEach(h => h.classList.remove('sorted'));
            if (dolo_holderSortField === field) {
                dolo_holderSortAsc = !dolo_holderSortAsc;
            } else {
                dolo_holderSortField = field;
                dolo_holderSortAsc = field === 'rank';
            }

            const th = card.querySelector(`th[data-sort="dolo-${field}"]`);
            if (th) {
                th.classList.add('sorted');
                th.querySelector('.arrow').textContent = dolo_holderSortAsc ? '▲' : '▼';
            }

            const balKey = (h) => dolo_getDisplayBalance(h);
            const key = field === 'balance' ? balKey : (h => h[field]);
            dolo_holderFiltered.sort((a, b) => {
                let va = key(a), vb = key(b);
                if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                return va < vb ? (dolo_holderSortAsc ? -1 : 1) : va > vb ? (dolo_holderSortAsc ? 1 : -1) : 0;
            });

            dolo_holderPage = 1;
            dolo_renderHoldersTable();
            dolo_renderHoldersPagination();
        }

        function dolo_applyHolderFilters() {
            const q = document.getElementById('dolo-holder-search').value.toLowerCase().trim();
            const showEth = document.getElementById('dolo-filter-eth').checked;
            const showBera = document.getElementById('dolo-filter-bera').checked;

            dolo_holderFiltered = dolo_holderData.filter(h => {
                if (q && !h.address.toLowerCase().includes(q)) return false;
                const hasEth = h.chains && h.chains.includes('eth');
                const hasBera = h.chains && h.chains.includes('bera');
                if (!showEth && !showBera) return false;
                if (showEth && showBera) return true;
                if (showEth && !showBera) return hasEth;
                if (!showEth && showBera) return hasBera;
                return true;
            });

            // Sort by display balance (chain-specific) descending by default
            dolo_holderFiltered.sort((a, b) => dolo_getDisplayBalance(b) - dolo_getDisplayBalance(a));

            // Reset sort state to rank-like order
            dolo_holderSortField = 'rank';
            dolo_holderSortAsc = true;
            const card = document.getElementById('dolo-holders-card');
            card.querySelectorAll('thead th').forEach(h => h.classList.remove('sorted'));
            const rankTh = card.querySelector('th[data-sort="dolo-rank"]');
            if (rankTh) { rankTh.classList.add('sorted'); rankTh.querySelector('.arrow').textContent = '▲'; }

            dolo_holderPage = 1;
            dolo_renderHoldersTable();
            dolo_renderHoldersPagination();
        }

        function dolo_renderChainBars(chains, total, allTvl, totalBorrowed, supplyLiquidity) {
            // Render summary in header
            const summaryEl = document.getElementById('dolo-chain-summary');
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <div style="display:flex;align-items:center;gap:6px;font-size:15px"><span style="color:var(--text-muted)">TVL</span><span style="color:var(--accent-green);font-weight:600">${dolo_fmt(total)}</span></div>
                    <div style="display:flex;align-items:center;gap:6px;font-size:15px"><span style="color:var(--text-muted)">Supply Liquidity</span><span style="font-weight:600;color:var(--text-primary)">${dolo_fmt(supplyLiquidity)}</span></div>
                    <div style="display:flex;align-items:center;gap:6px;font-size:15px"><span style="color:var(--text-muted)">Borrowed</span><span style="color:var(--accent-amber);font-weight:600">${dolo_fmt(totalBorrowed)}</span></div>
                `;
            }
            const container = document.getElementById('dolo-chain-bars');
            const renderRow = (c, i) => {
                const pct = ((c.tvl / total) * 100).toFixed(1);
                const color = DOLO_CHAIN_COLORS[c.chain] || '#6366f1';
                const borrowed = allTvl[c.chain + '-borrowed'] || 0;
                const supply = c.tvl + borrowed;
                const logo = DOLO_CHAIN_LOGOS[c.chain] || '';
                const logoImg = logo ? `<img src="${logo}" alt="${c.chain}" style="width:22px;height:22px;border-radius:50%;flex-shrink:0;object-fit:cover">` : `<span style="width:22px;height:22px;border-radius:50%;background:${color};flex-shrink:0"></span>`;
                return `<div style="margin-bottom:14px;cursor:default;padding:9px 4px;border-radius:10px;transition:all 0.25s ease" class="dolo-chain-row"
                    onmouseenter="this.style.background='rgba(99,102,241,0.1)';this.style.transform='translateY(-2px)';this.querySelector('.chain-bar-wrap').style.height='10px';this.querySelectorAll('.chain-name-text').forEach(e=>{e.style.fontSize='16px'});this.querySelectorAll('.chain-stat-text').forEach(e=>{e.style.fontSize='15.5px'})"
                    onmouseleave="this.style.background='transparent';this.style.transform='translateY(0)';this.querySelector('.chain-bar-wrap').style.height='8px';this.querySelectorAll('.chain-name-text').forEach(e=>{e.style.fontSize='14px'});this.querySelectorAll('.chain-stat-text').forEach(e=>{e.style.fontSize='13.5px'})">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px">
                        <span class="chain-name-text" style="display:flex;align-items:center;gap:8px;color:var(--text-primary);font-weight:600;font-size:14px;transition:font-size 0.2s">${logoImg} ${c.chain}</span>
                        <span style="display:flex;align-items:center;gap:4px"><span class="chain-name-text" style="color:var(--accent-green);font-weight:600;font-size:14px;transition:font-size 0.2s">${dolo_fmt(c.tvl)}</span> <span style="color:var(--text-muted);font-size:11px">(${pct}%)</span></span>
                    </div>
                    <div class="chain-bar-wrap" style="height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden;position:relative;transition:height 0.25s ease">
                        <div class="dolo-bar-fill" style="height:100%;width:0%;background:${color};border-radius:4px;transition:width 1s cubic-bezier(0.4,0,0.2,1)" data-width="${pct}%"></div>
                    </div>
                    <div style="display:flex;gap:14px;margin-top:6px">
                        <span class="chain-stat-text" style="font-size:13.5px;transition:font-size 0.2s"><span style="color:var(--text-muted)">Supply</span> <span style="color:#fff">${dolo_fmt(supply)}</span></span>
                        ${borrowed > 0 ? `<span class="chain-stat-text" style="font-size:13.5px;transition:font-size 0.2s"><span style="color:var(--text-muted)">Borrowed</span> <span style="color:var(--accent-amber)">${dolo_fmt(borrowed)}</span></span>` : ''}
                    </div>
                </div>`;
            };

            const top3 = chains.slice(0, 3).map((c, i) => renderRow(c, i)).join('');
            const rest = chains.slice(3);
            let expandHtml = '';
            if (rest.length > 0) {
                expandHtml = `<div id="dolo-chains-expand" style="overflow:hidden;max-height:0;transition:max-height 0.4s ease">
                    ${rest.map((c, i) => renderRow(c, i + 3)).join('')}
                </div>
                <button id="dolo-chains-toggle" onclick="dolo_toggleChains()" style="display:flex;align-items:center;gap:4px;width:100%;padding:8px;margin-top:4px;background:transparent;border:1px solid var(--border-default);border-radius:8px;color:var(--text-muted);font-size:12px;cursor:pointer;justify-content:center;transition:all 0.2s;font-family:'Inter',sans-serif" onmouseover="this.style.borderColor='var(--accent-indigo)';this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-default)';this.style.color='var(--text-muted)'">
                    <span>Show ${rest.length} more chains</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </button>`;
            }
            container.innerHTML = top3 + expandHtml;

            // Animate bars in
            requestAnimationFrame(() => {
                container.querySelectorAll('.dolo-bar-fill').forEach(el => {
                    el.style.width = el.dataset.width;
                });
            });
        }

        let dolo_chainsExpanded = false;
        function dolo_toggleChains() {
            dolo_chainsExpanded = !dolo_chainsExpanded;
            const panel = document.getElementById('dolo-chains-expand');
            const btn = document.getElementById('dolo-chains-toggle');
            if (dolo_chainsExpanded) {
                panel.style.maxHeight = panel.scrollHeight + 'px';
                btn.querySelector('span').textContent = 'Show less';
                btn.querySelector('svg').style.transform = 'rotate(180deg)';
                // Animate newly visible bars
                requestAnimationFrame(() => {
                    panel.querySelectorAll('.dolo-bar-fill').forEach(el => {
                        el.style.width = el.dataset.width;
                    });
                });
            } else {
                panel.style.maxHeight = '0';
                btn.querySelector('span').textContent = 'Show more chains';
                btn.querySelector('svg').style.transform = 'rotate(0)';
            }
        }

        function dolo_renderTvlChart(data) {
            const canvas = document.getElementById('dolo-tvl-chart');
            if (!canvas) return;
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const CHART_H = 260;
            canvas.width = rect.width * dpr;
            canvas.height = CHART_H * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = CHART_H + 'px';
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            const W = rect.width, H = CHART_H;
            ctx.clearRect(0, 0, W, H);

            if (!dolo_tvlPoints.length) return;

            const pad = { top: 16, right: 70, bottom: 32, left: 62 };
            const cw = W - pad.left - pad.right;
            const ch = H - pad.top - pad.bottom;

            const vals = dolo_tvlPoints.map(p => p.tvl);
            const minV = Math.min(...vals) * 0.95;
            const maxV = Math.max(...vals) * 1.02;
            const range = maxV - minV || 1;

            // Find min/max indices
            let minIdx = 0, maxIdx = 0;
            vals.forEach((v, i) => { if (v < vals[minIdx]) minIdx = i; if (v > vals[maxIdx]) maxIdx = i; });

            // Helper: get xy for index
            const getXY = (i) => ({
                x: pad.left + (cw * i / (dolo_tvlPoints.length - 1)),
                y: pad.top + ch - (ch * (dolo_tvlPoints[i].tvl - minV) / range)
            });

            // ── Draw function (used for initial render and hover redraw) ──
            function drawChart(hoverIdx) {
                ctx.clearRect(0, 0, W, H);

                // Grid lines (dashed, subtle)
                for (let i = 0; i <= 4; i++) {
                    const v = minV + (range * i / 4);
                    const y = pad.top + ch - (ch * (v - minV) / range);
                    // Y-axis labels
                    ctx.fillStyle = '#6b6f89';
                    ctx.font = '11px Inter';
                    ctx.textAlign = 'right';
                    ctx.fillText(dolo_fmt(v), pad.left - 10, y + 4);
                    // Grid line
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
                    ctx.setLineDash([4, 4]);
                    ctx.lineWidth = 0.5;
                    ctx.moveTo(pad.left, y);
                    ctx.lineTo(W - pad.right, y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // X-axis dates
                ctx.fillStyle = '#6b6f89';
                ctx.font = '11px Inter';
                ctx.textAlign = 'center';
                const step = Math.max(1, Math.floor(dolo_tvlPoints.length / 6));
                for (let i = 0; i < dolo_tvlPoints.length; i += step) {
                    const x = pad.left + (cw * i / (dolo_tvlPoints.length - 1));
                    const d = dolo_tvlPoints[i].date;
                    ctx.fillText(d.toLocaleDateString('en', { month: 'short', day: 'numeric' }), x, H - 8);
                }

                // Gradient fill (richer 3-stop)
                const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
                grad.addColorStop(0, 'rgba(99,102,241,0.40)');
                grad.addColorStop(0.5, 'rgba(99,102,241,0.12)');
                grad.addColorStop(1, 'rgba(99,102,241,0.01)');

                // Build points (bezier)
                const pts = dolo_tvlPoints.map((_, i) => getXY(i));

                // Fill area with bezier
                ctx.beginPath();
                ctx.moveTo(pts[0].x, pts[0].y);
                for (let i = 1; i < pts.length; i++) {
                    const prev = pts[i - 1];
                    const cur = pts[i];
                    const cpx = (prev.x + cur.x) / 2;
                    ctx.quadraticCurveTo(prev.x + (cur.x - prev.x) * 0.5, prev.y, cpx, (prev.y + cur.y) / 2);
                    if (i === pts.length - 1) ctx.quadraticCurveTo(cpx + (cur.x - cpx), (prev.y + cur.y) / 2 + (cur.y - prev.y) * 0.5, cur.x, cur.y);
                }
                ctx.lineTo(pts[pts.length - 1].x, pad.top + ch);
                ctx.lineTo(pts[0].x, pad.top + ch);
                ctx.closePath();
                ctx.fillStyle = grad;
                ctx.fill();

                // Main line (smoothed bezier)
                ctx.beginPath();
                ctx.moveTo(pts[0].x, pts[0].y);
                for (let i = 1; i < pts.length; i++) {
                    const prev = pts[i - 1];
                    const cur = pts[i];
                    const cpx = (prev.x + cur.x) / 2;
                    ctx.quadraticCurveTo(prev.x + (cur.x - prev.x) * 0.5, prev.y, cpx, (prev.y + cur.y) / 2);
                    if (i === pts.length - 1) ctx.quadraticCurveTo(cpx + (cur.x - cpx), (prev.y + cur.y) / 2 + (cur.y - prev.y) * 0.5, cur.x, cur.y);
                }
                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 2.5;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.stroke();

                // ── Min / Max markers ──
                if (dolo_tvlPoints.length > 5) {
                    // Don't draw min/max if they're at very edge
                    const drawMarker = (idx, label, color, above) => {
                        const p = getXY(idx);
                        // Dot
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, 3.5, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.fill();
                        // Label
                        ctx.font = '600 10px Inter';
                        ctx.fillStyle = color;
                        ctx.textAlign = 'center';
                        const labelY = above ? p.y - 10 : p.y + 16;
                        ctx.fillText(label + ' ' + dolo_fmt(dolo_tvlPoints[idx].tvl), p.x, labelY);
                    };
                    // Only show if min != max
                    if (minIdx !== maxIdx) {
                        drawMarker(maxIdx, '▲', 'rgba(52,211,153,0.85)', true);
                        drawMarker(minIdx, '▼', 'rgba(251,113,133,0.75)', false);
                    }
                }

                // ── Current value label (right side) ──
                const lastPt = pts[pts.length - 1];
                const lastVal = dolo_tvlPoints[dolo_tvlPoints.length - 1].tvl;
                // Background pill
                const labelText = dolo_fmt(lastVal);
                ctx.font = '600 12px Inter';
                const tw = ctx.measureText(labelText).width;
                const pillW = tw + 16;
                const pillH = 22;
                const pillX = lastPt.x + 8;
                const pillY = lastPt.y - pillH / 2;
                ctx.fillStyle = 'rgba(99,102,241,0.18)';
                ctx.beginPath();
                ctx.roundRect(pillX, pillY, pillW, pillH, 6);
                ctx.fill();
                ctx.fillStyle = '#818cf8';
                ctx.textAlign = 'left';
                ctx.fillText(labelText, pillX + 8, pillY + 15);

                // Pulsing live dot on last point (static outer ring, inner uses animation in CSS via overlay)
                if (hoverIdx === undefined || hoverIdx === null) {
                    ctx.beginPath();
                    ctx.arc(lastPt.x, lastPt.y, 5, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(99,102,241,0.3)';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(lastPt.x, lastPt.y, 3, 0, Math.PI * 2);
                    ctx.fillStyle = '#6366f1';
                    ctx.fill();
                }

                // ── Hover crosshair + dot ──
                if (hoverIdx !== undefined && hoverIdx !== null && hoverIdx >= 0 && hoverIdx < dolo_tvlPoints.length) {
                    const hp = getXY(hoverIdx);

                    // Vertical crosshair
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(99,102,241,0.35)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 3]);
                    ctx.moveTo(hp.x, pad.top);
                    ctx.lineTo(hp.x, pad.top + ch);
                    ctx.stroke();

                    // Horizontal crosshair
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(99,102,241,0.2)';
                    ctx.moveTo(pad.left, hp.y);
                    ctx.lineTo(W - pad.right, hp.y);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Hover dot
                    ctx.beginPath();
                    ctx.arc(hp.x, hp.y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(99,102,241,0.25)';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(hp.x, hp.y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#6366f1';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(hp.x, hp.y, 2, 0, Math.PI * 2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                }
            }

            // Initial draw
            drawChart(null);

            // ── Mouse interaction ──
            canvas.onmousemove = function (e) {
                const cRect = canvas.getBoundingClientRect();
                const mx = e.clientX - cRect.left;
                const idx = Math.round(((mx - pad.left) / cw) * (dolo_tvlPoints.length - 1));
                if (idx < 0 || idx >= dolo_tvlPoints.length) { dolo_hideTvlTooltip(); drawChart(null); return; }

                drawChart(idx);

                const pt = dolo_tvlPoints[idx];
                const hp = getXY(idx);

                // Tooltip content
                const tip = document.getElementById('dolo-tvl-tooltip');
                const firstTvl = dolo_tvlPoints[0].tvl;
                const pctFromStart = firstTvl > 0 ? ((pt.tvl - firstTvl) / firstTvl * 100) : 0;
                const pctSign = pctFromStart >= 0 ? '+' : '';
                const pctColor = pctFromStart >= 0 ? 'var(--accent-green)' : 'var(--accent-rose)';
                tip.style.display = 'block';
                tip.innerHTML = `<div style="font-weight:700;font-size:15px;color:#f0f0f6;letter-spacing:-0.3px">${dolo_fmt(pt.tvl)}</div>
                        <div style="color:#8b8fa3;font-size:11px;margin-top:3px">${pt.date.toLocaleDateString('en', { weekday: 'short', month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        <div style="margin-top:5px;padding-top:5px;border-top:1px solid rgba(255,255,255,0.06);font-size:11px;color:${pctColor};font-weight:600">${pctSign}${pctFromStart.toFixed(2)}% from start</div>`;

                // Position tooltip
                const tipW = 180;
                let left = hp.x - tipW / 2;
                if (left < 0) left = 4;
                if (left + tipW > W) left = W - tipW - 4;
                let top = hp.y - 85;
                if (top < 0) top = hp.y + 15;
                tip.style.left = left + 'px';
                tip.style.top = top + 'px';
            };
            canvas.onmouseleave = function () {
                dolo_hideTvlTooltip();
                drawChart(null);
            };

            // --- Brush Navigator ---
            dolo_renderBrush();
        }

        // ===== BRUSH NAVIGATOR =====
        let dolo_brushStart = 0;   // 0..1 fraction
        let dolo_brushEnd = 1;     // 0..1 fraction

        function dolo_renderBrush() {
            const brushCanvas = document.getElementById('dolo-brush-canvas');
            if (!brushCanvas || !dolo_allTvlPoints.length) return;

            const BRUSH_H = 56;
            const allPts = dolo_currentRange >= dolo_allTvlPoints.length ? [...dolo_allTvlPoints] : dolo_allTvlPoints.slice(-dolo_currentRange);
            const rect = brushCanvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            brushCanvas.width = rect.width * dpr;
            brushCanvas.height = BRUSH_H * dpr;
            brushCanvas.style.width = rect.width + 'px';
            brushCanvas.style.height = BRUSH_H + 'px';
            const ctx = brushCanvas.getContext('2d');
            ctx.scale(dpr, dpr);
            const W = rect.width, H = BRUSH_H;
            // Use same padding as main chart
            const padL = 60, padR = 0;
            const plotW = W - padL - padR;
            ctx.clearRect(0, 0, W, H);

            // Background - only fill within plot area
            ctx.fillStyle = 'rgba(30,30,50,0.6)';
            ctx.fillRect(padL, 0, plotW, H);

            // Draw mini line within padded area
            const vals = allPts.map(p => p.tvl);
            const minV = Math.min(...vals) * 0.95;
            const maxV = Math.max(...vals) * 1.02;
            const range = maxV - minV || 1;
            const vPad = 4;

            // Gradient fill
            const grad = ctx.createLinearGradient(0, vPad, 0, H - vPad);
            grad.addColorStop(0, 'rgba(99,102,241,0.2)');
            grad.addColorStop(1, 'rgba(99,102,241,0)');
            ctx.beginPath();
            allPts.forEach((p, i) => {
                const x = padL + (plotW * i / (allPts.length - 1));
                const y = vPad + (H - 2 * vPad) - ((H - 2 * vPad) * (p.tvl - minV) / range);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.lineTo(padL + plotW, H); ctx.lineTo(padL, H); ctx.closePath();
            ctx.fillStyle = grad; ctx.fill();

            // Line
            ctx.beginPath();
            allPts.forEach((p, i) => {
                const x = padL + (plotW * i / (allPts.length - 1));
                const y = vPad + (H - 2 * vPad) - ((H - 2 * vPad) * (p.tvl - minV) / range);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.strokeStyle = 'rgba(99,102,241,0.5)';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Update overlay positions
            dolo_updateBrushOverlay();
        }

        function dolo_updateBrushOverlay() {
            const overlay = document.getElementById('dolo-brush-overlay');
            if (!overlay) return;
            const W = overlay.offsetWidth;
            // Brush selection only operates within the padded plot area
            const padL = 60, padR = 0;
            const plotW = W - padL - padR;
            const left = padL + dolo_brushStart * plotW;
            const right = padL + dolo_brushEnd * plotW;

            const dimL = document.getElementById('dolo-brush-dim-left');
            dimL.style.left = padL + 'px';
            dimL.style.width = (left - padL) + 'px';
            const dimR = document.getElementById('dolo-brush-dim-right');
            dimR.style.left = right + 'px';
            dimR.style.width = (W - padR - right) + 'px';
            const win = document.getElementById('dolo-brush-window');
            win.style.left = left + 'px';
            win.style.width = (right - left) + 'px';

            // Update date range label
            const allPts = dolo_currentRange >= dolo_allTvlPoints.length ? [...dolo_allTvlPoints] : dolo_allTvlPoints.slice(-dolo_currentRange);
            if (allPts.length > 1) {
                const startIdx = Math.floor(dolo_brushStart * (allPts.length - 1));
                const endIdx = Math.ceil(dolo_brushEnd * (allPts.length - 1));
                const sDate = allPts[startIdx]?.date;
                const eDate = allPts[endIdx]?.date;
                const label = document.getElementById('dolo-brush-date-label');
                if (label && sDate && eDate) {
                    const fmt = d => d.toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' });
                    label.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="flex-shrink:0;opacity:0.6"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><span>${fmt(sDate)}  →  ${fmt(eDate)}</span>`;
                }
            }
        }

        function dolo_brushApply() {
            const allPts = dolo_currentRange >= dolo_allTvlPoints.length ? [...dolo_allTvlPoints] : dolo_allTvlPoints.slice(-dolo_currentRange);
            const startIdx = Math.floor(dolo_brushStart * (allPts.length - 1));
            const endIdx = Math.ceil(dolo_brushEnd * (allPts.length - 1));
            dolo_tvlPoints = allPts.slice(startIdx, endIdx + 1);
            if (dolo_tvlPoints.length < 2) dolo_tvlPoints = allPts;
            dolo_updateChangeBadge();

            // Re-render main chart only (not brush) using the new polished renderer
            // We save/restore brush state to avoid re-rendering the brush
            const canvas = document.getElementById('dolo-tvl-chart');
            if (!canvas) return;
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const CHART_H = 260;
            canvas.width = rect.width * dpr;
            canvas.height = CHART_H * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = CHART_H + 'px';
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            const W = rect.width, H = CHART_H;
            ctx.clearRect(0, 0, W, H);

            if (!dolo_tvlPoints.length) return;
            const pad = { top: 16, right: 70, bottom: 32, left: 62 };
            const cw = W - pad.left - pad.right;
            const ch = H - pad.top - pad.bottom;
            const vals = dolo_tvlPoints.map(p => p.tvl);
            const minV = Math.min(...vals) * 0.95;
            const maxV = Math.max(...vals) * 1.02;
            const range = maxV - minV || 1;
            let minIdx = 0, maxIdx = 0;
            vals.forEach((v, i) => { if (v < vals[minIdx]) minIdx = i; if (v > vals[maxIdx]) maxIdx = i; });
            const getXY = (i) => ({
                x: pad.left + (cw * i / (dolo_tvlPoints.length - 1)),
                y: pad.top + ch - (ch * (dolo_tvlPoints[i].tvl - minV) / range)
            });

            // Draw using same logic as main chart
            function drawBrushChart(hoverIdx) {
                ctx.clearRect(0, 0, W, H);
                // Grid
                for (let i = 0; i <= 4; i++) {
                    const v = minV + (range * i / 4);
                    const y = pad.top + ch - (ch * (v - minV) / range);
                    ctx.fillStyle = '#6b6f89'; ctx.font = '11px Inter'; ctx.textAlign = 'right';
                    ctx.fillText(dolo_fmt(v), pad.left - 10, y + 4);
                    ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.setLineDash([4, 4]); ctx.lineWidth = 0.5;
                    ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke(); ctx.setLineDash([]);
                }
                // X dates
                ctx.fillStyle = '#6b6f89'; ctx.font = '11px Inter'; ctx.textAlign = 'center';
                const step = Math.max(1, Math.floor(dolo_tvlPoints.length / 6));
                for (let i = 0; i < dolo_tvlPoints.length; i += step) {
                    const x = pad.left + (cw * i / (dolo_tvlPoints.length - 1));
                    ctx.fillText(dolo_tvlPoints[i].date.toLocaleDateString('en', { month: 'short', day: 'numeric' }), x, H - 8);
                }
                // Gradient
                const pts = dolo_tvlPoints.map((_, i) => getXY(i));
                const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
                grad.addColorStop(0, 'rgba(99,102,241,0.40)'); grad.addColorStop(0.5, 'rgba(99,102,241,0.12)'); grad.addColorStop(1, 'rgba(99,102,241,0.01)');
                ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
                for (let i = 1; i < pts.length; i++) {
                    const prev = pts[i - 1], cur = pts[i], cpx = (prev.x + cur.x) / 2;
                    ctx.quadraticCurveTo(prev.x + (cur.x - prev.x) * 0.5, prev.y, cpx, (prev.y + cur.y) / 2);
                    if (i === pts.length - 1) ctx.quadraticCurveTo(cpx + (cur.x - cpx), (prev.y + cur.y) / 2 + (cur.y - prev.y) * 0.5, cur.x, cur.y);
                }
                ctx.lineTo(pts[pts.length - 1].x, pad.top + ch); ctx.lineTo(pts[0].x, pad.top + ch); ctx.closePath();
                ctx.fillStyle = grad; ctx.fill();
                // Line
                ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
                for (let i = 1; i < pts.length; i++) {
                    const prev = pts[i - 1], cur = pts[i], cpx = (prev.x + cur.x) / 2;
                    ctx.quadraticCurveTo(prev.x + (cur.x - prev.x) * 0.5, prev.y, cpx, (prev.y + cur.y) / 2);
                    if (i === pts.length - 1) ctx.quadraticCurveTo(cpx + (cur.x - cpx), (prev.y + cur.y) / 2 + (cur.y - prev.y) * 0.5, cur.x, cur.y);
                }
                ctx.strokeStyle = '#6366f1'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.stroke();
                // Min/Max
                if (dolo_tvlPoints.length > 5 && minIdx !== maxIdx) {
                    const drawM = (idx, lbl, col, above) => {
                        const p = getXY(idx); ctx.beginPath(); ctx.arc(p.x, p.y, 3.5, 0, Math.PI * 2); ctx.fillStyle = col; ctx.fill();
                        ctx.font = '600 10px Inter'; ctx.fillStyle = col; ctx.textAlign = 'center';
                        ctx.fillText(lbl + ' ' + dolo_fmt(dolo_tvlPoints[idx].tvl), p.x, above ? p.y - 10 : p.y + 16);
                    };
                    drawM(maxIdx, '▲', 'rgba(52,211,153,0.85)', true);
                    drawM(minIdx, '▼', 'rgba(251,113,133,0.75)', false);
                }
                // Current value label
                const lastPt = pts[pts.length - 1]; const lastVal = dolo_tvlPoints[dolo_tvlPoints.length - 1].tvl;
                const labelText = dolo_fmt(lastVal); ctx.font = '600 12px Inter';
                const tw = ctx.measureText(labelText).width; const pillW = tw + 16, pillH = 22, pillX = lastPt.x + 8, pillY = lastPt.y - pillH / 2;
                ctx.fillStyle = 'rgba(99,102,241,0.18)'; ctx.beginPath(); ctx.roundRect(pillX, pillY, pillW, pillH, 6); ctx.fill();
                ctx.fillStyle = '#818cf8'; ctx.textAlign = 'left'; ctx.fillText(labelText, pillX + 8, pillY + 15);
                if (!hoverIdx && hoverIdx !== 0) { ctx.beginPath(); ctx.arc(lastPt.x, lastPt.y, 5, 0, Math.PI * 2); ctx.fillStyle = 'rgba(99,102,241,0.3)'; ctx.fill(); ctx.beginPath(); ctx.arc(lastPt.x, lastPt.y, 3, 0, Math.PI * 2); ctx.fillStyle = '#6366f1'; ctx.fill(); }
                // Hover
                if (hoverIdx >= 0 && hoverIdx < dolo_tvlPoints.length) {
                    const hp = getXY(hoverIdx);
                    ctx.beginPath(); ctx.strokeStyle = 'rgba(99,102,241,0.35)'; ctx.lineWidth = 1; ctx.setLineDash([5, 3]);
                    ctx.moveTo(hp.x, pad.top); ctx.lineTo(hp.x, pad.top + ch); ctx.stroke();
                    ctx.beginPath(); ctx.strokeStyle = 'rgba(99,102,241,0.2)'; ctx.moveTo(pad.left, hp.y); ctx.lineTo(W - pad.right, hp.y); ctx.stroke(); ctx.setLineDash([]);
                    ctx.beginPath(); ctx.arc(hp.x, hp.y, 6, 0, Math.PI * 2); ctx.fillStyle = 'rgba(99,102,241,0.25)'; ctx.fill();
                    ctx.beginPath(); ctx.arc(hp.x, hp.y, 4, 0, Math.PI * 2); ctx.fillStyle = '#6366f1'; ctx.fill();
                    ctx.beginPath(); ctx.arc(hp.x, hp.y, 2, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
                }
            }
            drawBrushChart(null);
            canvas.onmousemove = function (e) {
                const cRect = canvas.getBoundingClientRect(); const mx = e.clientX - cRect.left;
                const idx = Math.round(((mx - pad.left) / cw) * (dolo_tvlPoints.length - 1));
                if (idx < 0 || idx >= dolo_tvlPoints.length) { dolo_hideTvlTooltip(); drawBrushChart(null); return; }
                drawBrushChart(idx);
                const pt = dolo_tvlPoints[idx]; const hp = getXY(idx);
                const tip = document.getElementById('dolo-tvl-tooltip');
                const firstTvl = dolo_tvlPoints[0].tvl;
                const pctFromStart = firstTvl > 0 ? ((pt.tvl - firstTvl) / firstTvl * 100) : 0;
                const pctSign = pctFromStart >= 0 ? '+' : ''; const pctColor = pctFromStart >= 0 ? 'var(--accent-green)' : 'var(--accent-rose)';
                tip.style.display = 'block';
                tip.innerHTML = `<div style="font-weight:700;font-size:15px;color:#f0f0f6;letter-spacing:-0.3px">${dolo_fmt(pt.tvl)}</div>
                        <div style="color:#8b8fa3;font-size:11px;margin-top:3px">${pt.date.toLocaleDateString('en', { weekday: 'short', month: 'long', day: 'numeric', year: 'numeric' })}</div>
                        <div style="margin-top:5px;padding-top:5px;border-top:1px solid rgba(255,255,255,0.06);font-size:11px;color:${pctColor};font-weight:600">${pctSign}${pctFromStart.toFixed(2)}% from start</div>`;
                const tipW = 180; let left = hp.x - tipW / 2;
                if (left < 0) left = 4; if (left + tipW > W) left = W - tipW - 4;
                let top = hp.y - 85; if (top < 0) top = hp.y + 15;
                tip.style.left = left + 'px'; tip.style.top = top + 'px';
            };
            canvas.onmouseleave = function () { dolo_hideTvlTooltip(); drawBrushChart(null); };
        }

        // Brush interaction
        (function initBrushInteraction() {
            let mode = null; // 'left', 'right', 'pan'
            let startX = 0, startBrushStart = 0, startBrushEnd = 0;

            function getOverlayX(e) {
                const ov = document.getElementById('dolo-brush-overlay');
                return e.clientX - ov.getBoundingClientRect().left;
            }
            function getOverlayW() {
                return document.getElementById('dolo-brush-overlay').offsetWidth;
            }

            document.getElementById('dolo-brush-handle-left').addEventListener('mousedown', e => {
                e.preventDefault(); e.stopPropagation();
                mode = 'left'; startX = e.clientX; startBrushStart = dolo_brushStart;
                document.body.style.cursor = 'ew-resize';
            });
            document.getElementById('dolo-brush-handle-right').addEventListener('mousedown', e => {
                e.preventDefault(); e.stopPropagation();
                mode = 'right'; startX = e.clientX; startBrushEnd = dolo_brushEnd;
                document.body.style.cursor = 'ew-resize';
            });
            document.getElementById('dolo-brush-window').addEventListener('mousedown', e => {
                if (e.target.id === 'dolo-brush-handle-left' || e.target.id === 'dolo-brush-handle-right') return;
                if (e.target.parentElement?.id === 'dolo-brush-handle-left' || e.target.parentElement?.id === 'dolo-brush-handle-right') return;
                e.preventDefault();
                mode = 'pan'; startX = e.clientX; startBrushStart = dolo_brushStart; startBrushEnd = dolo_brushEnd;
                document.body.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', e => {
                if (!mode) return;
                const W = getOverlayW();
                const padL = 60, padR = 0;
                const plotW = W - padL - padR;
                const dx = (e.clientX - startX) / plotW;
                const minWidth = 0.03; // minimum 3% selection

                if (mode === 'left') {
                    dolo_brushStart = Math.max(0, Math.min(startBrushStart + dx, dolo_brushEnd - minWidth));
                } else if (mode === 'right') {
                    dolo_brushEnd = Math.max(dolo_brushStart + minWidth, Math.min(1, startBrushEnd + dx));
                } else if (mode === 'pan') {
                    const span = startBrushEnd - startBrushStart;
                    let newStart = startBrushStart + dx;
                    let newEnd = startBrushEnd + dx;
                    if (newStart < 0) { newStart = 0; newEnd = span; }
                    if (newEnd > 1) { newEnd = 1; newStart = 1 - span; }
                    dolo_brushStart = newStart;
                    dolo_brushEnd = newEnd;
                }
                dolo_updateBrushOverlay();
                dolo_brushApply();
            });

            document.addEventListener('mouseup', () => {
                if (mode) {
                    mode = null;
                    document.body.style.cursor = '';
                    // Show/hide reset button
                    const isFullRange = dolo_brushStart < 0.01 && dolo_brushEnd > 0.99;
                    document.getElementById('dolo-reset-zoom-btn').style.display = isFullRange ? 'none' : '';
                    if (!isFullRange) {
                        document.querySelectorAll('.dolo-range-btn').forEach(btn => {
                            if (btn.id !== 'dolo-reset-zoom-btn') btn.classList.remove('active');
                        });
                    }
                }
            });
        })();

        function dolo_hideTvlTooltip() {
            const tip = document.getElementById('dolo-tvl-tooltip');
            if (tip) tip.style.display = 'none';
        }

        function dolo_renderTokenDonut(data) {
            const wrap = document.getElementById('dolo-donut-wrap');
            if (!wrap || !data.ll) return;

            // Get token breakdown from tokensInUsd if available
            let tokens = [];
            const tokensInUsd = data.ll.tokensInUsd || [];
            if (tokensInUsd.length > 0) {
                const latest = tokensInUsd[tokensInUsd.length - 1];
                const tokenMap = latest.tokens || {};
                for (const [name, val] of Object.entries(tokenMap)) {
                    if (typeof val === 'number' && val > 0) tokens.push({ name, value: val });
                }
            }
            if (!tokens.length) {
                const tvl = data.ll.currentChainTvls || {};
                for (const [c, v] of Object.entries(tvl)) {
                    if (!c.includes('-') && typeof v === 'number' && v > 0) tokens.push({ name: c, value: v });
                }
            }
            tokens.sort((a, b) => b.value - a.value);
            if (tokens.length > 8) {
                const top = tokens.slice(0, 8);
                const otherVal = tokens.slice(8).reduce((s, t) => s + t.value, 0);
                top.push({ name: 'Other', value: otherVal });
                tokens = top;
            }
            const total = tokens.reduce((s, t) => s + t.value, 0);
            if (!total) return;

            const size = 260, cx = 130, cy = 130, r = 110, innerR = 70;
            let angle = -Math.PI / 2;
            const sliceData = [];
            const pathElems = [];

            tokens.forEach((t, i) => {
                const sweep = (t.value / total) * Math.PI * 2;
                const color = DOLO_TOKEN_COLORS[i % DOLO_TOKEN_COLORS.length];
                const x1 = cx + r * Math.cos(angle);
                const y1 = cy + r * Math.sin(angle);
                const x2 = cx + r * Math.cos(angle + sweep);
                const y2 = cy + r * Math.sin(angle + sweep);
                const ix1 = cx + innerR * Math.cos(angle + sweep);
                const iy1 = cy + innerR * Math.sin(angle + sweep);
                const ix2 = cx + innerR * Math.cos(angle);
                const iy2 = cy + innerR * Math.sin(angle);
                const large = sweep > Math.PI ? 1 : 0;
                const d = `M${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} L${ix1},${iy1} A${innerR},${innerR} 0 ${large} 0 ${ix2},${iy2} Z`;
                pathElems.push({ d, color, i });
                sliceData.push({ name: t.name, value: t.value, pct: ((t.value / total) * 100).toFixed(1), color, startAngle: angle, endAngle: angle + sweep });
                angle += sweep;
            });

            // Remove old canvas if present
            const oldCanvas = document.getElementById('dolo-token-donut');
            if (oldCanvas) oldCanvas.remove();

            // Remove old SVG if present
            const oldSvg = wrap.querySelector('svg');
            if (oldSvg) oldSvg.remove();

            // Create SVG programmatically
            const ns = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(ns, 'svg');
            svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.style.cssText = 'display:block;width:260px;height:260px';
            svg.id = 'dolo-token-svg';

            pathElems.forEach(p => {
                const path = document.createElementNS(ns, 'path');
                path.setAttribute('d', p.d);
                path.setAttribute('fill', p.color);
                path.setAttribute('data-idx', p.i);
                path.style.cursor = 'pointer';
                path.style.transition = 'opacity 0.15s, transform 0.15s';
                path.style.transformOrigin = `${cx}px ${cy}px`;
                path.addEventListener('mouseenter', () => dolo_highlightSlice(p.i));
                path.addEventListener('mouseleave', () => dolo_highlightSlice(-1));
                svg.appendChild(path);
            });

            wrap.insertBefore(svg, wrap.firstChild);

            // Center text
            const centerOverlay = document.getElementById('dolo-donut-center');
            if (centerOverlay) {
                centerOverlay.innerHTML = `<div style="font-weight:600;font-size:16px;color:#f0f0f6">${dolo_fmt(total)}</div><div style="font-size:11px;color:#555770;margin-top:2px">Total Value</div>`;
            }

            // Legend
            const legend = document.getElementById('dolo-token-legend');
            legend.innerHTML = sliceData.map((s, i) => `<div data-idx="${i}" class="dolo-legend-item" style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:default;padding:4px 8px;border-radius:6px;transition:all 0.2s"
                onmouseover="dolo_highlightSlice(${i})" onmouseout="dolo_highlightSlice(-1)">
                <span style="width:10px;height:10px;border-radius:3px;background:${s.color};flex-shrink:0"></span>
                <span class="legend-text" style="flex:1;color:var(--text-secondary);transition:all 0.15s">${s.name}</span>
                <span class="legend-text" style="color:var(--text-muted);font-weight:500;transition:all 0.15s">${s.pct}%</span>
                <span class="legend-text" style="color:var(--text-secondary);min-width:60px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:11px;transition:all 0.15s">${dolo_fmt(s.value)}</span>
            </div>`).join('');

            // Store slice data for highlight
            dolo_donutSlices = sliceData;
            dolo_donutTotal = total;
        }

        let dolo_donutSlices = [];
        let dolo_donutTotal = 0;
        let dolo_highlightedIdx = -1;

        function dolo_highlightSlice(idx) {
            if (idx === dolo_highlightedIdx) return;
            dolo_highlightedIdx = idx;

            // Highlight legend rows
            document.querySelectorAll('.dolo-legend-item').forEach((el, i) => {
                const texts = el.querySelectorAll('.legend-text');
                if (i === idx) {
                    el.style.background = 'rgba(99,102,241,0.12)';
                    el.style.transform = 'translateY(-1px)';
                    el.style.opacity = '1';
                    el.style.fontSize = '14px';
                    texts.forEach(t => t.style.color = '#fff');
                } else if (idx >= 0) {
                    el.style.background = 'transparent';
                    el.style.transform = 'translateY(0)';
                    el.style.opacity = '0.4';
                    el.style.fontSize = '12px';
                    texts.forEach(t => t.style.color = '');
                } else {
                    el.style.background = 'transparent';
                    el.style.transform = 'translateY(0)';
                    el.style.opacity = '1';
                    el.style.fontSize = '12px';
                    texts.forEach(t => t.style.color = '');
                }
            });

            // Update center overlay text
            const centerOverlay = document.getElementById('dolo-donut-center');
            if (centerOverlay) {
                if (idx >= 0 && dolo_donutSlices[idx]) {
                    const hit = dolo_donutSlices[idx];
                    centerOverlay.innerHTML = `<div style="font-weight:600;font-size:13px;color:#f0f0f6">${hit.name}</div><div style="font-weight:600;font-size:15px;color:#f0f0f6;margin-top:1px">${dolo_fmt(hit.value)}</div><div style="font-size:11px;color:#555770;margin-top:1px">${hit.pct}%</div>`;
                } else {
                    centerOverlay.innerHTML = `<div style="font-weight:600;font-size:16px;color:#f0f0f6">${dolo_fmt(dolo_donutTotal)}</div><div style="font-size:11px;color:#555770;margin-top:2px">Total Value</div>`;
                }
            }

            // Highlight SVG segments (no re-rendering needed!)
            const svg = document.getElementById('dolo-token-svg');
            if (!svg) return;
            svg.querySelectorAll('path').forEach((path, i) => {
                if (i === idx) {
                    path.style.opacity = '1';
                    path.style.transform = 'scale(1.04)';
                } else if (idx >= 0) {
                    path.style.opacity = '0.35';
                    path.style.transform = 'scale(1)';
                } else {
                    path.style.opacity = '1';
                    path.style.transform = 'scale(1)';
                }
            });
        }

        function copyAddr(addr, btn) {
            navigator.clipboard.writeText(addr);
            const origHTML = btn.innerHTML;
            btn.innerHTML = '✓';
            btn.style.color = 'var(--accent-green)';
            setTimeout(() => { btn.innerHTML = origHTML; btn.style.color = 'var(--text-muted)'; }, 1500);
        }

        function dolo_renderProtocolInfo(ll) {

            const X_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>';
            const GLOBE_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>';
            const GITHUB_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>';
            const AUDIT_SVG = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>';
            const LINK_SVG = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:0.5"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>';

            const linkData = [
                { icon: GLOBE_SVG, label: 'Website', url: ll.url },
                { icon: X_SVG, label: 'Twitter', url: ll.twitter ? 'https://twitter.com/' + ll.twitter : null },
                { icon: GITHUB_SVG, label: 'GitHub', url: ll.openSource ? ll.github?.[0] : null },
                { icon: AUDIT_SVG, label: 'Audits', url: ll.audits ? ll.audit_links?.[0] : null },
            ].filter(l => l.url);
            const linksHTML = linkData.map(l =>
                `<a href="${l.url}" target="_blank" class="protocol-link-pill">${l.icon} ${l.label} ${LINK_SVG}</a>`
            ).join('');

            // Contract addresses
            const DOLO_ADDR = '0x0F81001eF0A83ecCE5ccebf63EB302c70a39a654';
            const ODOLO_ADDR = '0x02E513b5B54eE216Bf836ceb471507488fC89543';
            const VEDOLO_ADDR = '0xCB86B75EE6133d179a12D550b09FB3cdB1e141D4';
            const ETH_ICON = `<img src="https://icons.llamao.fi/icons/chains/rsz_ethereum.jpg" alt="ETH">`;
            const BERA_ICON = `<img src="https://icons.llamao.fi/icons/chains/rsz_berachain.jpg" alt="BERA">`;
            const COPY_SVG = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';

            function addrRow(tokenIcon, tokenName, chainIcon, chainName, addr, explorer) {
                const slug = tokenName.toLowerCase().replace(/\s/g, '');
                const url = `${explorer}/token/${addr}`;
                return `<div class="protocol-addr-row" data-token="${slug}" onclick="window.open('${url}','_blank')">
                    <div class="protocol-addr-token">
                        <img src="${tokenIcon}" alt="${tokenName}">
                        <span>${tokenName}</span>
                    </div>
                    <div class="protocol-addr-chain">${chainIcon} ${chainName}</div>
                    <div class="protocol-addr-value">
                        <a href="${url}" target="_blank" onclick="event.stopPropagation()">${addr}</a>
                        <button class="protocol-addr-copy" onclick="event.stopPropagation();copyAddr('${addr}',this)" title="Copy address">${COPY_SVG}</button>
                    </div>
                </div>`;
            }

            const contractsHTML =
                addrRow('dolo-logo.svg', 'DOLO', ETH_ICON, 'Ethereum', DOLO_ADDR, 'https://etherscan.io') +
                addrRow('dolo-logo.svg', 'DOLO', BERA_ICON, 'Berachain', DOLO_ADDR, 'https://berascan.com') +
                addrRow('odolo-logo-official.svg', 'oDOLO', BERA_ICON, 'Berachain', ODOLO_ADDR, 'https://berascan.com') +
                addrRow('vedolo-logo.svg', 'veDOLO', BERA_ICON, 'Berachain', VEDOLO_ADDR, 'https://berascan.com');

            // Populate ALL Protocol Info instances across tabs
            document.querySelectorAll('.proto-links').forEach(el => el.innerHTML = linksHTML);
            document.querySelectorAll('.proto-contracts').forEach(el => el.innerHTML = contractsHTML);
        }

        // Redraw DOLO charts on resize
        let dolo_resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(dolo_resizeTimer);
            dolo_resizeTimer = setTimeout(() => {
                if (dolo_cachedData && currentView === 'dolo') {
                    dolo_renderTvlChart(dolo_cachedData);
                    dolo_renderTokenDonut(dolo_cachedData);
                }
            }, 300);
        });

        // ===== EARN TAB NAMESPACE =====
        // Chains sorted by TVL (descending)
        const EARN_CHAINS = {
            ethereum: {
                name: 'Ethereum',
                icon: 'https://icons.llamao.fi/icons/chains/rsz_ethereum.jpg',
                twChain: 'ethereum',
                cgPlatform: 'ethereum',
                explorer: 'https://etherscan.io',
                margin: '0x003Ca23Fd5F0ca87D01F6eC6CD14A8AE60c2b97D',
                rpcs: ['https://eth.llamarpc.com/', 'https://ethereum-rpc.publicnode.com/', 'https://eth.drpc.org/'],
                rpcIdx: 0,
            },
            berachain: {
                name: 'Berachain',
                icon: 'https://icons.llamao.fi/icons/chains/rsz_berachain.jpg',
                twChain: null,
                cgPlatform: 'berachain',
                explorer: 'https://berascan.com',
                margin: '0x003Ca23Fd5F0ca87D01F6eC6CD14A8AE60c2b97D',
                rpcs: ['https://rpc.berachain.com/', 'https://berachain-rpc.publicnode.com/', 'https://berachain.drpc.org/'],
                rpcIdx: 0,
            },
            arbitrum: {
                name: 'Arbitrum',
                icon: 'https://icons.llamao.fi/icons/chains/rsz_arbitrum.jpg',
                twChain: 'arbitrum',
                cgPlatform: 'arbitrum-one',
                explorer: 'https://arbiscan.io',
                margin: '0x6bd780e7fDf01D77e4d475c821f1e7AE05409072',
                rpcs: ['https://arb1.arbitrum.io/rpc', 'https://arbitrum.drpc.org/', 'https://arbitrum-one-rpc.publicnode.com/'],
                rpcIdx: 0,
            },
            botanix: {
                name: 'Botanix',
                icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%234a9c5d'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-size='18' font-weight='bold' fill='white'%3E₿%3C/text%3E%3C/svg%3E",
                twChain: null,
                explorer: 'https://explorer.botanixlabs.dev',
                margin: '0x0000000000000000000000000000000000000000',
                rpcs: ['https://rpc.botanixlabs.dev/'],
                rpcIdx: 0,
                pending: true,
            },
            polygonzkevm: {
                name: 'Polygon zkEVM',
                icon: 'https://icons.llamao.fi/icons/chains/rsz_polygon_zkevm.jpg',
                twChain: null,
                explorer: 'https://zkevm.polygonscan.com',
                margin: '0x836b557cf9ef29fcf49c776841191782df34e4e5',
                rpcs: ['https://zkevm-rpc.com/', 'https://polygon-zkevm.drpc.org/'],
                rpcIdx: 0,
            },
            mantle: {
                name: 'Mantle',
                icon: 'https://icons.llamao.fi/icons/chains/rsz_mantle.jpg',
                twChain: 'mantle',
                explorer: 'https://mantlescan.xyz',
                margin: '0xe6ef4f0b2455bab92ce7cc78e35324ab58917de8',
                rpcs: ['https://rpc.mantle.xyz/', 'https://mantle-rpc.publicnode.com/', 'https://mantle.drpc.org/'],
                rpcIdx: 0,
            },
            xlayer: {
                name: 'X Layer',
                icon: 'https://icons.llamao.fi/icons/chains/rsz_x%20layer.jpg',
                twChain: null,
                explorer: 'https://www.oklink.com/xlayer',
                margin: '0x836b557cf9ef29fcf49c776841191782df34e4e5',
                rpcs: ['https://rpc.xlayer.tech/', 'https://xlayer.drpc.org/'],
                rpcIdx: 0,
            },
        };
        let earn_rpcId = 5000;
        const earn_tokenCache = {}; // "chain:address" => { symbol, decimals, icon }

        // ---- Custom chain selector logic ----
        function earnChainToggle() {
            document.getElementById('earn-chain-dropdown').classList.toggle('open');
        }
        function earnChainSelect(key) {
            const chain = EARN_CHAINS[key];
            document.getElementById('earn-chain').value = key;
            const trigger = document.getElementById('earn-chain-trigger');
            if (chain.icon) {
                trigger.innerHTML = `<img src="${chain.icon}" alt=""><span>${chain.name}</span>`;
            } else {
                trigger.innerHTML = `<span style="font-size:15px">${chain.textIcon || '○'}</span><span>${chain.name}</span>`;
            }
            document.getElementById('earn-chain-dropdown').classList.remove('open');
            // Update active state
            document.querySelectorAll('.earn-chain-option').forEach(o => o.classList.toggle('active', o.dataset.chain === key));
        }
        function earnBuildChainMenu() {
            const menu = document.getElementById('earn-chain-menu');
            let html = '';
            for (const [key, chain] of Object.entries(EARN_CHAINS)) {
                const iconHtml = chain.icon
                    ? `<img src="${chain.icon}" alt="">`
                    : `<span class="chain-text-icon">${chain.textIcon || '○'}</span>`;
                html += `<div class="earn-chain-option${key === 'ethereum' ? ' active' : ''}" data-chain="${key}" onclick="earnChainSelect('${key}')">
                    ${iconHtml}<span>${chain.name}</span>
                </div>`;
            }
            menu.innerHTML = html;
        }
        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('earn-chain-dropdown');
            if (dd && !dd.contains(e.target)) dd.classList.remove('open');
        });
        // Build on load
        earnBuildChainMenu();

        function earn_getChain() {
            const sel = document.getElementById('earn-chain');
            return EARN_CHAINS[sel ? sel.value : 'ethereum'];
        }

        function earn_nextRpc() {
            const chain = earn_getChain();
            return chain.rpcs[chain.rpcIdx++ % chain.rpcs.length];
        }

        async function earn_rpcCall(to, data, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const resp = await fetch(earn_nextRpc(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'eth_call',
                            params: [{ to, data }, 'latest'],
                            id: earn_rpcId++
                        })
                    });
                    const json = await resp.json();
                    if (json.error) throw new Error(json.error.message);
                    return json.result;
                } catch (e) {
                    if (attempt === retries - 1) throw e;
                }
            }
        }

        // Batch JSON-RPC: send multiple eth_call in a single HTTP request
        async function earn_rpcBatch(calls, retries = 3) {
            const batch = calls.map((c, i) => ({
                jsonrpc: '2.0',
                method: 'eth_call',
                params: [{ to: c.to, data: c.data }, 'latest'],
                id: earn_rpcId++
            }));
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const resp = await fetch(earn_nextRpc(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(batch)
                    });
                    const results = await resp.json();
                    // Results may come in any order, sort by id
                    if (Array.isArray(results)) {
                        const map = {};
                        results.forEach(r => { map[r.id] = r.result || null; });
                        return batch.map(b => map[b.id] || null);
                    }
                    // Some RPCs don't support batch, fall back to individual calls
                    console.warn('RPC batch not supported, falling back to individual calls');
                    return Promise.all(calls.map(c => earn_rpcCall(c.to, c.data)));
                } catch (e) {
                    if (attempt === retries - 1) {
                        // Fallback to individual calls
                        return Promise.all(calls.map(c => earn_rpcCall(c.to, c.data)));
                    }
                }
            }
        }

        // ABI helpers
        function earn_padAddr(addr) {
            return addr.toLowerCase().replace('0x', '').padStart(64, '0');
        }

        function earn_padUint(n) {
            return BigInt(n).toString(16).padStart(64, '0');
        }

        // Decode getAccountBalances result:
        // returns (uint256[] marketIds, address[] tokenAddresses, Types.Par[] pars, Types.Wei[] weis)
        // Types.Par = { bool sign, uint128 value }
        // Types.Wei = { bool sign, uint256 value }
        function earn_decodeBalances(hex) {
            if (!hex || hex === '0x') return [];
            const data = hex.replace('0x', '');
            const word = (i) => data.slice(i * 64, (i + 1) * 64);
            const toNum = (w) => BigInt('0x' + w);

            // 4 dynamic arrays, each starts with an offset
            const off0 = Number(toNum(word(0))); // marketIds offset
            const off1 = Number(toNum(word(1))); // tokenAddresses offset
            const off2 = Number(toNum(word(2))); // pars offset
            const off3 = Number(toNum(word(3))); // weis offset

            const readArrayAt = (byteOffset) => {
                const wordIdx = byteOffset / 32;
                const len = Number(toNum(word(wordIdx)));
                const items = [];
                for (let i = 0; i < len; i++) {
                    items.push(word(wordIdx + 1 + i));
                }
                return items;
            };

            // Read marketIds
            const marketIds = readArrayAt(off0).map(w => Number(toNum(w)));
            const count = marketIds.length;
            if (count === 0) return [];

            // Read token addresses
            const tokenAddrs = readArrayAt(off1).map(w => '0x' + w.slice(24));

            // Read Par structs (sign + value pairs)
            const parsWordIdx = off2 / 32;
            const parsLen = Number(toNum(word(parsWordIdx)));
            const pars = [];
            for (let i = 0; i < parsLen; i++) {
                const sign = toNum(word(parsWordIdx + 1 + i * 2)) !== 0n; // true = positive
                const value = toNum(word(parsWordIdx + 2 + i * 2));
                pars.push({ sign, value });
            }

            // Read Wei structs (sign + value pairs)
            const weisWordIdx = off3 / 32;
            const weisLen = Number(toNum(word(weisWordIdx)));
            const weis = [];
            for (let i = 0; i < weisLen; i++) {
                const sign = toNum(word(weisWordIdx + 1 + i * 2)) !== 0n;
                const value = toNum(word(weisWordIdx + 2 + i * 2));
                weis.push({ sign, value });
            }

            const results = [];
            for (let i = 0; i < count; i++) {
                const parVal = pars[i] ? (pars[i].sign ? pars[i].value : -pars[i].value) : 0n;
                const weiVal = weis[i] ? (weis[i].sign ? weis[i].value : -weis[i].value) : 0n;
                // Only include assets with positive balance (deposits, not borrows)
                if (weiVal > 0n) {
                    results.push({
                        marketId: marketIds[i],
                        tokenAddr: tokenAddrs[i],
                        par: parVal,  // principal (original deposit)
                        wei: weiVal,  // current value (with yield)
                    });
                }
            }
            return results;
        }

        // Known tokens with CoinGecko icon URLs — keyed by "chain:address" (lowercase)
        const KNOWN_TOKENS = {};
        // Helper to register tokens per chain
        function _regToken(chains, addr, symbol, decimals, icon) {
            const a = addr.toLowerCase();
            chains.forEach(c => { KNOWN_TOKENS[c + ':' + a] = { symbol, decimals, icon }; });
        }
        // ---- Berachain tokens ----
        const DOLO_CDN = 'https://app.dolomite.io/static/media/';
        _regToken(['berachain'], '0xfcbd14dc51f0a4d49d5e53c2a0bfa8f1a74c3f8b', 'USDC', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['berachain'], '0x6969696969696969696969696969696969696969', 'WBERA', 18, DOLO_CDN + 'wBERA.4ca51f80e3cd585d5152483f427d0416.svg');
        _regToken(['berachain'], '0x2f6f07cdcf3588944bf4c42ac74ff24bf56e7590', 'WETH', 18, DOLO_CDN + 'WETH.8f785563e47cbf373160.png');
        _regToken(['berachain'], '0x0555e30da8f98308edb960aa94c0db47230d2b9c', 'WBTC', 8, DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png');
        _regToken(['berachain'], '0x549943e04f40284185054145c6e4e9568c1d3241', 'HONEY', 18, DOLO_CDN + 'HONEY.3f0a04d651c47e52fb627fd616a9b92e.svg');
        _regToken(['berachain'], '0xac03caba51e17c86c921e1f6cbfbdc91f8bb2e6b', 'stBERA', 18, DOLO_CDN + 'BERA.a24a9b40b3447dde7ea1d2cab4dd59e9.svg');
        // DOLO appears on multiple chains
        _regToken(['berachain'], '0x0f81001ef0a83ecce5ccebf63eb302c70a39a654', 'DOLO', 18, 'dolo-logo.svg');
        _regToken(['berachain'], '0x05e4e2a79e3bcab250e8706c3fcc4e45c940c1ef', 'USDT', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['berachain'], '0x2577d24a26f8fa19c1058a8b0106e2c7303454a4', 'weETH', 18, DOLO_CDN + 'weETH.ac3fd68b653520508855e997e756d116.svg');
        _regToken(['berachain'], '0x6e1e9896e93f7a71ecb33d4386b49deed67a231a', 'SolvBTC', 18, DOLO_CDN + 'solvBTC.326d594ebd54e4317f078b70f72a58b4.svg');
        // ---- Arbitrum tokens ----
        _regToken(['arbitrum'], '0xff970a61a04b1ca14834a43f5de4533ebddb5cc8', 'USDC.e', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['arbitrum'], '0xaf88d065e77c8cc2239327c5edb3a432268e5831', 'USDC', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['arbitrum'], '0x82af49447d8a07e3bd95bd0d56f35241523fbab1', 'WETH', 18, DOLO_CDN + 'WETH.8f785563e47cbf373160.png');
        _regToken(['arbitrum'], '0x2f2a2543b76a4166549f7aab2e75bef0aefc5b0f', 'WBTC', 8, DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png');
        _regToken(['arbitrum'], '0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9', 'USDT', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['arbitrum'], '0xda10009cbd5d07dd0cecc66161fc93d7c9000da1', 'DAI', 18, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['arbitrum'], '0x912ce59144191c1204e64559fe8253a0e49e6548', 'ARB', 18, DOLO_CDN + 'ARB.f8b26a91d3f23a571be6398aa1a1f119.svg');
        _regToken(['arbitrum'], '0x5979d7b546e38e414f7e9822514be443a4800529', 'wstETH', 18, DOLO_CDN + 'wstETH.2e97640d284bbe78da3776549d27ec47.svg');
        _regToken(['arbitrum'], '0x35751007a407ca6feffe80b3cb397736d2cf4dbe', 'weETH', 18, DOLO_CDN + 'weETH.ac3fd68b653520508855e997e756d116.svg');
        _regToken(['arbitrum'], '0x4186bfc76e2e237523cbc30fd220fe055156b41f', 'rsETH', 18, DOLO_CDN + 'rsETH.2270aa7836bedfa00c1a1d2967df0c33.svg');
        _regToken(['arbitrum'], '0x0c880f6761f1af8d9aa9c466984b80dab9a8c9e8', 'PENDLE', 18, DOLO_CDN + 'PENDLE.e4e3db03c3798bf15a6c384ab5de3fee.svg');
        _regToken(['arbitrum'], '0xfc5a1a6eb076a2c7ad06ed22c90d7e710e35ad0a', 'GMX', 18, DOLO_CDN + 'GMX.b836adc14ee095fd9b7671e718878333.svg');
        _regToken(['arbitrum'], '0x6694340fc020c5e6b96567843da2df01b2ce1eb6', 'STG', 18, 'https://coin-images.coingecko.com/coins/images/24413/small/STG_LOGO.png');
        // ---- Ethereum tokens ----
        _regToken(['ethereum'], '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48', 'USDC', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['ethereum'], '0xdac17f958d2ee523a2206206994597c13d831ec7', 'USDT', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['ethereum'], '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2', 'WETH', 18, DOLO_CDN + 'WETH.8f785563e47cbf373160.png');
        _regToken(['ethereum'], '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599', 'WBTC', 8, DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png');
        _regToken(['ethereum'], '0x6b175474e89094c44da98b954eedeac495271d0f', 'DAI', 18, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['ethereum'], '0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0', 'wstETH', 18, DOLO_CDN + 'wstETH.2e97640d284bbe78da3776549d27ec47.svg');
        _regToken(['ethereum'], '0xcd5fe23c85820f7b72d0926fc9b05b43e359b7ee', 'weETH', 18, DOLO_CDN + 'weETH.ac3fd68b653520508855e997e756d116.svg');
        _regToken(['ethereum'], '0xa35b1b31ce002fbf2058d22f30f95d405200a15b', 'ETHx', 18, DOLO_CDN + 'ETH_plus.58a00bd8aa8caafbc3837b4dcd7a1786.svg');
        _regToken(['ethereum'], '0x9d39a5de30e57443bff2a8307a4256c8797a3497', 'sUSDe', 18, DOLO_CDN + 'sUSDe.60857af2b2de944764d31ffa3711252c.svg');
        _regToken(['ethereum'], '0x8d0d000ee44948fc98c9b98a4fa4921476f08b0d', 'USD1', 18, DOLO_CDN + 'USD1.b88613f468d884c0a044350162ec22c2.svg');
        _regToken(['ethereum'], '0x8382098b64e0dddf7d64fdc416e913ad81e62677', 'wsrUSD', 18, DOLO_CDN + 'srUSD.bef2b101351c2021e25a96dc70122077.svg');
        _regToken(['ethereum'], '0x39a03194a282f9d6c81333d73f910411a91e56b8', 'WLFI', 18, DOLO_CDN + 'WLFI.2c1e57c98e3cad7282c40941b36ee606.svg');
        // ---- Mantle tokens ----
        _regToken(['mantle'], '0x09bc4e0d10e52d0e37747b0c03f35c15e5517002', 'USDC', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['mantle'], '0x201eba5cc46d216ce6dc03f6a759e8e766e956ae', 'USDT', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['mantle'], '0xdeaddeaddeaddeaddeaddeaddeaddeaddead1111', 'WETH', 18, DOLO_CDN + 'WETH.8f785563e47cbf373160.png');
        _regToken(['mantle'], '0x78c1b0c915c4faa5fffa6cabf0219da63d7f4cb8', 'WMNT', 18, DOLO_CDN + 'WMNT.a58988c614392a216cc8937be5ab96db.svg');
        _regToken(['mantle'], '0xcda86a272531e8640cd7f1a92c01839911b90bb0', 'mETH', 18, DOLO_CDN + 'mETH.589d7c134eea64fa2033e80dced1e34d.svg');
        _regToken(['mantle'], '0x3c3a81e81dc49a522a592e7622a7e711c06bf354', 'MNT', 18, DOLO_CDN + 'MNT.7e882ac93f636391a8f7d2e0841cad98.svg');
        _regToken(['mantle'], '0xcAbAE6f6Ea1ecaB08Ad02fE02ce9A44F09aebfA2', 'WBTC', 8, DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png');
        _regToken(['mantle'], '0xe6829d9a7ee3040e1276fa75293bde931859e8fa', 'cmETH', 18, DOLO_CDN + 'cmETH.8cab59dd270fad4e153b008454f9f54e.svg');
        _regToken(['mantle'], '0xc96de26018a54d51c097160568752c4e3bd6c364', 'FBTC', 8, DOLO_CDN + 'FBTC.f29f5d2839b1b765719121f8094c7f11.svg');
        _regToken(['mantle'], '0x5be26527e817998a7206475496fde1e68957c5a6', 'USDY', 18, DOLO_CDN + 'USDY.56cf7a38e78550dd507090fe52a59b41.svg');
        // ---- Polygon zkEVM tokens ----
        _regToken(['polygonzkevm'], '0xa8ce8aee21bc2a48a5ef670afcc9274c7bbbc035', 'USDC', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['polygonzkevm'], '0x1e4a5963abfd975d8c9021ce480b42188849d41d', 'USDT', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['polygonzkevm'], '0x4f9a0e7fd2bf6067db6994cf12e4495df938e6e9', 'WETH', 18, DOLO_CDN + 'WETH.8f785563e47cbf373160.png');
        _regToken(['polygonzkevm'], '0xea034fb02eb1808c2cc3adbc15f447b93cbe08e1', 'WBTC', 8, DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png');
        _regToken(['polygonzkevm'], '0xc5015b9d9161dca7e18e32f6f25c4ad850731fd4', 'DAI', 18, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        // ---- X Layer tokens ----
        _regToken(['xlayer'], '0x74b7f16337b8972027f6196a17a631ac6de26d22', 'USDC', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['xlayer'], '0x1e4a5963abfd975d8c9021ce480b42188849d41d', 'USDT', 6, DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg');
        _regToken(['xlayer'], '0x5a77f1443d16ee5761d310e38b7308aded93506c', 'WETH', 18, DOLO_CDN + 'WETH.8f785563e47cbf373160.png');
        _regToken(['xlayer'], '0xea034fb02eb1808c2cc3adbc15f447b93cbe08e1', 'WBTC', 8, DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png');
        _regToken(['xlayer'], '0xe538905cf8410324e03a5a23c1c177a474d59b2b', 'OKB', 18, DOLO_CDN + 'OKB.dfac9609700af55b3d9ef4e0e5b28f01.svg');
        // ---- DOLO on all chains ----
        _regToken(['arbitrum', 'ethereum', 'mantle', 'polygonzkevm', 'xlayer'], '0x0f81001ef0a83ecce5ccebf63eb302c70a39a654', 'DOLO', 18, 'dolo-logo.svg');
        // ---- Additional Arbitrum tokens ----
        _regToken(['arbitrum'], '0xddb46999f8891663a8f2828d25298f70416d7610', 'sUSDS', 18, DOLO_CDN + 'sUSDs.788070a4e1bbf5ab8c6130d47bdf8108.svg');
        _regToken(['arbitrum'], '0xfa7f8980b0f1e64a2062791cc3b0871572f1f7f0', 'UNI', 18, DOLO_CDN + 'UNI.fbe3002e628fbf39d75525ae192d3665.svg');
        _regToken(['arbitrum'], '0xec70dcb4a1efa46b8f2d97c310c9c4790ba5ffa8', 'rETH', 18, DOLO_CDN + 'rETH.bab59070c249d5b359fa196fed62e60e.svg');
        _regToken(['arbitrum'], '0xf97f4df75117a78c1a5a0dbb814af92458539fb4', 'LINK', 18, DOLO_CDN + 'LINK.e6e8d688b54af33e1f99.png');
        _regToken(['arbitrum'], '0x539bde0d7dbd336b79148aa742883198bbf60342', 'MAGIC', 18, DOLO_CDN + 'MAGIC.e86265b765bebd6be26b2485691ab714.svg');
        _regToken(['arbitrum'], '0xfea7a6a0b346362bf88a9e4a88416b77a57d6c2a', 'MIM', 18, DOLO_CDN + 'MIM.3926602167b2dc6b73725f1cbd641130.svg');
        _regToken(['arbitrum'], '0x3082cc23568ea640225c2467653db90e9250aaa0', 'RDNT', 18, DOLO_CDN + 'RDNT.92d507e82611bb1e4353e8b8cae0a73a.svg');
        _regToken(['arbitrum'], '0x7c8a1a80fdd00c9cccd6ebd573e9ecb49bfa2a59', 'STONE', 18, DOLO_CDN + 'STONE-alt.bf62e30edc6330897c738a4f9f1f5179.svg');
        _regToken(['arbitrum'], '0xaada05bd399372f0b22b3424822f1e4f87432f23', 'AAVE', 18, DOLO_CDN + 'AAVE.a9c152c66f6bed5f3d0865b8d5ea0dba.svg');
        // ---- Additional Berachain tokens ----
        _regToken(['berachain'], '0x09d4214c03d01f49544c0448dbe3a27f768f2b34', 'rUSD', 18, DOLO_CDN + 'rUSD.9b373643ab772af9dab0807b476b9afb.svg');
        _regToken(['berachain'], '0xb5a27c33ba2ade3f64aca7bf5f49a0c0927a59d0', 'BGT', 18, DOLO_CDN + 'BGT.59af0fc7aad30ed3de49e3115ee24d04.svg');


        // Symbol-based fallback icons (when address not in KNOWN_TOKENS)
        const SYMBOL_ICONS = {
            // --- Stablecoins ---
            'USDC': DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg',
            'USDC.e': DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg',
            'USDC.E': DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg',
            'USDT': DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg',
            'USDT0': DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg',
            'DAI': DOLO_CDN + 'USDC.5f67b2404ca2e547fb00b70128d132cd.svg',
            'MIM': DOLO_CDN + 'MIM.3926602167b2dc6b73725f1cbd641130.svg',
            'USDM': DOLO_CDN + 'USDM.6c74738cd3a3499145fda4386f94cb8f.svg',
            'wUSDM': DOLO_CDN + 'wUSDM.91bedb44039233b7c172ff95ea112192.svg',
            'WUSDM': DOLO_CDN + 'wUSDM.91bedb44039233b7c172ff95ea112192.svg',
            'USDe': DOLO_CDN + 'USDe-alt.ce2f05f4bb09aa83c4dd5886a5a2886f.svg',
            'USDE': DOLO_CDN + 'USDe-alt.ce2f05f4bb09aa83c4dd5886a5a2886f.svg',
            'sUSDe': DOLO_CDN + 'sUSDe.60857af2b2de944764d31ffa3711252c.svg',
            'SUSDE': DOLO_CDN + 'sUSDe.60857af2b2de944764d31ffa3711252c.svg',
            'USDs': DOLO_CDN + 'USDs.106fa406e23ae22c8bb6120c2ed861f4.svg',
            'sUSDs': DOLO_CDN + 'sUSDs.788070a4e1bbf5ab8c6130d47bdf8108.svg',
            'USD1': DOLO_CDN + 'USD1.b88613f468d884c0a044350162ec22c2.svg',
            'USDY': DOLO_CDN + 'USDY.56cf7a38e78550dd507090fe52a59b41.svg',
            'USDa': DOLO_CDN + 'USDa.d95d6e9683a87b9007323745861f6b74.svg',
            'USDai': DOLO_CDN + 'USDai.8c41c3dde0d91e5e38e1aafb27cf6e55.svg',
            'sUSDa': DOLO_CDN + 'sUSDa.dc563217493f063b521fe276283e0d51.svg',
            'sUSDai': DOLO_CDN + 'sUSDai.5a9e2565db913d6bbd950993cc04bcde.svg',
            'savUSD': DOLO_CDN + 'savUSD.a2df97177abb3f75f4313a7241aa5fb0.svg',
            'rUSD': DOLO_CDN + 'rUSD.9b373643ab772af9dab0807b476b9afb.svg',
            'srUSD': DOLO_CDN + 'srUSD.bef2b101351c2021e25a96dc70122077.svg',
            'PUSD': DOLO_CDN + 'PUSD.8849484bfe7e45af6fec34f9c12d706e.svg',
            'yPUSD': DOLO_CDN + 'yPUSD.b779e3cd7cc473b13698b1ab365074f6.svg',
            'BYUSD': DOLO_CDN + 'BYUSD.8c0a1d051c4192302d739dbae5928286.svg',
            'NECT': DOLO_CDN + 'NECT.61b2d550cd59933e77667c3d75f73f5a.svg',
            'HONEY': DOLO_CDN + 'HONEY.3f0a04d651c47e52fb627fd616a9b92e.svg',
            'GRAI': DOLO_CDN + 'GRAI.34fe5f7729b8c43b63ff0ab77c7b2b51.svg',
            'FRAX': 'https://coin-images.coingecko.com/coins/images/13422/small/FRAX_icon.png',
            'crvUSD': DOLO_CDN + 'CRV.f927723690ec12fcc8381902a361c75e.svg',
            'LUSD': 'https://coin-images.coingecko.com/coins/images/14666/small/Group_3.png',
            'GHO': 'https://coin-images.coingecko.com/coins/images/30663/small/gho.png',
            'jUSDC': DOLO_CDN + 'jUSDC.b5cfe8b072afdb1484beaeec04bd61e5.svg',
            // --- ETH & derivatives ---
            'ETH': DOLO_CDN + 'ETH.6a879eb637c89695e6c5f5dc65c8c927.svg',
            'WETH': DOLO_CDN + 'WETH.8f785563e47cbf373160.png',
            'wstETH': DOLO_CDN + 'wstETH.2e97640d284bbe78da3776549d27ec47.svg',
            'WSTETH': DOLO_CDN + 'wstETH.2e97640d284bbe78da3776549d27ec47.svg',
            'weETH': DOLO_CDN + 'weETH.ac3fd68b653520508855e997e756d116.svg',
            'WEETH': DOLO_CDN + 'weETH.ac3fd68b653520508855e997e756d116.svg',
            'rETH': DOLO_CDN + 'rETH.bab59070c249d5b359fa196fed62e60e.svg',
            'RETH': DOLO_CDN + 'rETH.bab59070c249d5b359fa196fed62e60e.svg',
            'rsETH': DOLO_CDN + 'rsETH.2270aa7836bedfa00c1a1d2967df0c33.svg',
            'RSETH': DOLO_CDN + 'rsETH.2270aa7836bedfa00c1a1d2967df0c33.svg',
            'ezETH': DOLO_CDN + 'ezETH.23c954d818f85c10660e5c0a476ff398.svg',
            'EZETH': DOLO_CDN + 'ezETH.23c954d818f85c10660e5c0a476ff398.svg',
            'rswETH': DOLO_CDN + 'rswETH.fc4bdb76a764bf110676766fd0185dfe.svg',
            'RSWETH': DOLO_CDN + 'rswETH.fc4bdb76a764bf110676766fd0185dfe.svg',
            'mETH': DOLO_CDN + 'mETH.589d7c134eea64fa2033e80dced1e34d.svg',
            'METH': DOLO_CDN + 'mETH.589d7c134eea64fa2033e80dced1e34d.svg',
            'wsrUSD': DOLO_CDN + 'srUSD.5a3e2df2bbfd4e09f5a6d400f5e2e4df.svg',
            'WSRUSD': DOLO_CDN + 'srUSD.5a3e2df2bbfd4e09f5a6d400f5e2e4df.svg',
            'tETH': DOLO_CDN + 'tETH.77b0839567f787ef80a76c3e83b90293.svg',
            'TETH': DOLO_CDN + 'tETH.77b0839567f787ef80a76c3e83b90293.svg',
            'stETH': DOLO_CDN + 'wstETH.2e97640d284bbe78da3776549d27ec47.svg',
            'ETHx': DOLO_CDN + 'ETH_plus.58a00bd8aa8caafbc3837b4dcd7a1786.svg',
            'sfrxETH': 'https://coin-images.coingecko.com/coins/images/28462/small/sfrxETH.png',
            'SFRXETH': 'https://coin-images.coingecko.com/coins/images/28462/small/sfrxETH.png',
            'cbETH': 'https://coin-images.coingecko.com/coins/images/27008/small/cbeth.png',
            'CBETH': 'https://coin-images.coingecko.com/coins/images/27008/small/cbeth.png',
            'cmETH': DOLO_CDN + 'PT-cmETH.f49c697e967386e0fd082040501e92e0.svg',
            'CMETH': DOLO_CDN + 'PT-cmETH.f49c697e967386e0fd082040501e92e0.svg',
            'xrETH': DOLO_CDN + 'xrETH.d13af2859b5292e6bc623e8a2402a93d.svg',
            'XRETH': DOLO_CDN + 'xrETH.d13af2859b5292e6bc623e8a2402a93d.svg',
            'ylstETH': DOLO_CDN + 'ylstETH.8b2fa7c2cee8860ed6acbc0fa174eba5.svg',
            // --- BTC & derivatives ---
            'BTC': DOLO_CDN + 'BTC.ccaa294316dc68d8ecb092ef90e2c07c.svg',
            'WBTC': DOLO_CDN + 'WBTC.f3c8718835179e7543b5.png',
            'cbBTC': DOLO_CDN + 'CBBTC.fb6f792430a130d980920b6e69857bce.svg',
            'CBBTC': DOLO_CDN + 'CBBTC.fb6f792430a130d980920b6e69857bce.svg',
            'SolvBTC': DOLO_CDN + 'solvBTC.326d594ebd54e4317f078b70f72a58b4.svg',
            'SOLVBTC': DOLO_CDN + 'solvBTC.326d594ebd54e4317f078b70f72a58b4.svg',
            'solvBTCbbn': DOLO_CDN + 'solvBTCbbn.a4ffbb3feb4a22c2ca5564097b70f35c.svg',
            'xSolvBTC': DOLO_CDN + 'xSolvBTC.b2110d70dea973b20c4f1e6a137f2256.svg',
            'tBTC': DOLO_CDN + 'tBTC.2907801a7fa28c6583322ad3c2931333.svg',
            'TBTC': DOLO_CDN + 'tBTC.2907801a7fa28c6583322ad3c2931333.svg',
            'stBTC': DOLO_CDN + 'stBTC.3935aab6a35bd55630f244a1f56631ba.svg',
            'STBTC': DOLO_CDN + 'stBTC.3935aab6a35bd55630f244a1f56631ba.svg',
            'uniBTC': DOLO_CDN + 'uniBTC.bac6fdc858f4d751e79211986782ddd1.svg',
            'UNIBTC': DOLO_CDN + 'uniBTC.bac6fdc858f4d751e79211986782ddd1.svg',
            'LBTC': DOLO_CDN + 'LBTC.095d1662f9a83aea1c899fa1eeb84502.svg',
            'FBTC': DOLO_CDN + 'FBTC.f29f5d2839b1b765719121f8094c7f11.svg',
            'pBTC': DOLO_CDN + 'pBTC-2.33f92d1521de41c2fd041b11c9d77c7a.svg',
            'PBTC': DOLO_CDN + 'pBTC-2.33f92d1521de41c2fd041b11c9d77c7a.svg',
            'PumpBTC': DOLO_CDN + 'PumpBTC.aa48de36289e8439daf0456c4252dd27.svg',
            'PUMPBTC': DOLO_CDN + 'PumpBTC.aa48de36289e8439daf0456c4252dd27.svg',
            'ylPumpBTC': DOLO_CDN + 'ylPumpBTC.4ed846397580cd47e2ac1cc59dba2d56.svg',
            'ylBTCLRT': DOLO_CDN + 'ylBTCLRT.de3276def7f8a795b2215806ce3776d6.svg',
            'SBTC': DOLO_CDN + 'SBTC.42e2a04abe2a5a21904064d886e10804.svg',
            'STONE': DOLO_CDN + 'STONE-alt.bf62e30edc6330897c738a4f9f1f5179.svg',
            'STONEBTC': DOLO_CDN + 'STONEBTC.4ca9c1ebc2fca809154e406e9afa589b.svg',
            // --- Berachain ecosystem ---
            'BERA': DOLO_CDN + 'BERA.a24a9b40b3447dde7ea1d2cab4dd59e9.svg',
            'WBERA': DOLO_CDN + 'wBERA.4ca51f80e3cd585d5152483f427d0416.svg',
            'swBERA': DOLO_CDN + 'sWBERA.e2be8febc13f6552990168c4e232d62a.svg',
            'SWBERA': DOLO_CDN + 'sWBERA.e2be8febc13f6552990168c4e232d62a.svg',
            'wGBERA': DOLO_CDN + 'wgBERA.e10d0909ba87a40264fe74050034b025.svg',
            'WGBERA': DOLO_CDN + 'wgBERA.e10d0909ba87a40264fe74050034b025.svg',
            'stBERA': DOLO_CDN + 'BERA.a24a9b40b3447dde7ea1d2cab4dd59e9.svg',
            'iBERA': DOLO_CDN + 'BERA.a24a9b40b3447dde7ea1d2cab4dd59e9.svg',
            'IBERA': DOLO_CDN + 'BERA.a24a9b40b3447dde7ea1d2cab4dd59e9.svg',
            'BGT': DOLO_CDN + 'BGT.59af0fc7aad30ed3de49e3115ee24d04.svg',
            'iBGT': DOLO_CDN + 'BGT.59af0fc7aad30ed3de49e3115ee24d04.svg',
            'IBGT': DOLO_CDN + 'BGT.59af0fc7aad30ed3de49e3115ee24d04.svg',
            'oriBGT': DOLO_CDN + 'oriBGT.7f3393531bde0f56498780c803133999.svg',
            'ORIBGT': DOLO_CDN + 'oriBGT.7f3393531bde0f56498780c803133999.svg',
            'HENLO': DOLO_CDN + 'HENLO.8d50b084294cb406094f0005d46c2c75.svg',
            'OHM': DOLO_CDN + 'OHM.2df913d6b9413f26311c1df9718d1461.svg',
            'KDK': DOLO_CDN + 'KDK.31acd6ac4abb4a8c30812380c009f685.svg',
            'IR': DOLO_CDN + 'IR.4f115e858cbe4dbe82da00a8443ab1af.svg',
            'CAP': DOLO_CDN + 'CAP.ac9a6abdf976278407624655b95f7a45.svg',
            'PTSI': DOLO_CDN + 'PTSI.75a562a474778031c98d28700fb37f5c.svg',
            // --- Mantle ecosystem ---
            'MNT': DOLO_CDN + 'MNT.7e882ac93f636391a8f7d2e0841cad98.svg',
            'WMNT': DOLO_CDN + 'WMNT.a58988c614392a216cc8937be5ab96db.svg',
            'sMNT': DOLO_CDN + 'sMNT.a9500825100b828039355108399b7c2b.svg',
            'SMNT': DOLO_CDN + 'sMNT.a9500825100b828039355108399b7c2b.svg',
            // --- DeFi governance tokens ---
            'ARB': DOLO_CDN + 'ARB.f8b26a91d3f23a571be6398aa1a1f119.svg',
            'oARB': DOLO_CDN + 'oARB.a2c6c20bd4a19274b88e208e43f7ffa3.svg',
            'PENDLE': DOLO_CDN + 'PENDLE.e4e3db03c3798bf15a6c384ab5de3fee.svg',
            'GMX': DOLO_CDN + 'GMX.b836adc14ee095fd9b7671e718878333.svg',
            'STG': 'https://coin-images.coingecko.com/coins/images/24413/small/STG_LOGO.png',
            'LINK': DOLO_CDN + 'LINK.e6e8d688b54af33e1f99.png',
            'CRV': DOLO_CDN + 'CRV.f927723690ec12fcc8381902a361c75e.svg',
            'AAVE': DOLO_CDN + 'AAVE.a9c152c66f6bed5f3d0865b8d5ea0dba.svg',
            'UNI': DOLO_CDN + 'UNI.fbe3002e628fbf39d75525ae192d3665.svg',
            'GRT': 'https://coin-images.coingecko.com/coins/images/13397/small/Graph_Token.png',
            'GRAIL': DOLO_CDN + 'GRAIL.13f8e457ed0e3d6868b41f28eb431819.svg',
            'MAGIC': DOLO_CDN + 'MAGIC.e86265b765bebd6be26b2485691ab714.svg',
            'JONES': DOLO_CDN + 'JONES.3ce2e6a8fb1444d9d6439e5781e6c2c1.svg',
            'PREMIA': DOLO_CDN + 'PREMIA.6c5c2339f3179353bb163b4e53d8dfa1.svg',
            'DPX': DOLO_CDN + 'DPX.ac054aa02be296979160d68dbb594a39.svg',
            'RDNT': DOLO_CDN + 'RDNT.92d507e82611bb1e4353e8b8cae0a73a.svg',
            'XAI': DOLO_CDN + 'XAI.ed6137b5d4b6078ac5061beb0e9b78f5.svg',
            'OKB': DOLO_CDN + 'OKB.dfac9609700af55b3d9ef4e0e5b28f01.svg',
            'POL': DOLO_CDN + 'MATIC.dfc4843b6db6db48662b1db5f752f9f1.svg',
            'MATIC': DOLO_CDN + 'MATIC.dfc4843b6db6db48662b1db5f752f9f1.svg',
            'WLFI': DOLO_CDN + 'WLFI.2c1e57c98e3cad7282c40941b36ee606.svg',
            'DOLO': DOLO_CDN + 'DOLO.07c75614d106533c9773769f7c0049b2.svg',
            'WOO': 'https://coin-images.coingecko.com/coins/images/12921/small/WOO_Logos_2023_Profile_Pic_WOO.png',
            'LODE': 'https://coin-images.coingecko.com/coins/images/24861/small/lode.png',
            'WINR': 'https://coin-images.coingecko.com/coins/images/29244/small/winr.png',
            'YEET': 'https://coin-images.coingecko.com/coins/images/54002/small/yeet.jpg',
            // --- GLP / GM tokens ---
            'GLP': DOLO_CDN + 'GLP.96b12aa556614dd5791f.png',
            'sGLP': DOLO_CDN + 'GLP.96b12aa556614dd5791f.png',
            'plvGLP': DOLO_CDN + 'plvGLP.24551c9e68ef10245cc45fb0b96cfdff.svg',
            'PLVGLP': DOLO_CDN + 'plvGLP.24551c9e68ef10245cc45fb0b96cfdff.svg',
            'GM': DOLO_CDN + 'GMX.b836adc14ee095fd9b7671e718878333.svg',
            // --- Pendle PT tokens ---
            'PT-GLP': DOLO_CDN + 'PT-GLP.10ed789425b588fe57650640de551bed.svg',
            'PT-rETH': DOLO_CDN + 'PT-rETH.e2b8a22fc3817c3a51225d7ffb5e616b.svg',
            'PT-wstETH': DOLO_CDN + 'PT-wstETH.09d3f15856b64c9b4f64c8de1264db37.svg',
            'PT-weETH': DOLO_CDN + 'PT-weETH.24d74aa18d08440b7f662eba78dcc52c.svg',
            'PT-ezETH': DOLO_CDN + 'PT-ezETH.d1ed194653ea88e9f3fe8c029064d654.svg',
            'PT-rsETH': DOLO_CDN + 'PT-rsETH.857e86584fe78053a1044b78df689b4d.svg',
            'PT-mETH': DOLO_CDN + 'PT-mETH.793642f12d4c303ecf771107c77ecfbb.svg',
            'PT-cmETH': DOLO_CDN + 'PT-cmETH.f49c697e967386e0fd082040501e92e0.svg',
            'PT-USDe': DOLO_CDN + 'PT-USDe.b5a8d24289b509fe4e6b4c702a790828.svg',
            'PT-MNT': DOLO_CDN + 'PT-MNT.19aa4a53e3aa4337407a1502ae89fc31.svg',
            'PT-iBGT': DOLO_CDN + 'PT-iBGT.45a4b4c47be320270ac8d1ce32439d2a.svg',
            // --- GMX V2 GM market tokens ---
            'GM:ETH': DOLO_CDN + 'ETH-GM.0b7d447f3c11298af07411c926352c71.svg',
            'GM:ARB': DOLO_CDN + 'ARB-GM.50df3ed4a1a52b938992cb5e08efbc36.svg',
            'GM:WBTC': DOLO_CDN + 'WBTC-GM.6e7f69538bb02b42b881b86aea5c6d6e.svg',
            'GM:LINK': DOLO_CDN + 'LINK-GM.7d4b33346ec9822f9dc7c22a393f7698.svg',
            'GM:UNI': DOLO_CDN + 'UNI-GM.8a4dfd0dc79f5b60138039338d28a6c7.svg',
            // --- GLV tokens ---
            'GLV:BTC': DOLO_CDN + 'GLV-BTC.c576682a1343bbfde84710a572b5a68e.svg',
            'GLV:ETH': DOLO_CDN + 'GLV-ETH.092b4c8a9412efd58d3542d26bc5a522.svg',
        };

        async function earn_getTokenInfo(addr) {
            const chainId = document.getElementById('earn-chain').value;
            const key = chainId + ':' + addr.toLowerCase();
            if (earn_tokenCache[key]) return earn_tokenCache[key];

            // Check known tokens first (already lowercase keyed)
            if (KNOWN_TOKENS[key]) {
                const kt = { ...KNOWN_TOKENS[key] };
                // Fallback icon from SYMBOL_ICONS if KNOWN_TOKENS has no icon
                if (!kt.icon && kt.symbol) kt.icon = SYMBOL_ICONS[kt.symbol] || SYMBOL_ICONS[kt.symbol.toUpperCase()] || null;
                earn_tokenCache[key] = kt;
                return kt;
            }

            // Fetch symbol + decimals via RPC
            try {
                const [symHex, decHex] = await Promise.all([
                    earn_rpcCall(addr, '0x95d89b41'), // symbol()
                    earn_rpcCall(addr, '0x313ce567'), // decimals()
                ]);

                let symbol = 'UNK';
                if (symHex && symHex.length > 2) {
                    try {
                        const d = symHex.replace('0x', '');
                        if (d.length === 64) {
                            // bytes32 format — extract non-zero bytes
                            const bytes = [];
                            for (let j = 0; j < 64; j += 2) {
                                const byte = parseInt(d.substr(j, 2), 16);
                                if (byte > 0) bytes.push(byte);
                            }
                            symbol = String.fromCharCode(...bytes);
                        } else if (d.length >= 128) {
                            // Dynamic string: offset + length + data
                            const len = Number(BigInt('0x' + d.slice(64, 128)));
                            const bytes = d.slice(128, 128 + len * 2);
                            symbol = '';
                            for (let i = 0; i < bytes.length; i += 2) {
                                const c = parseInt(bytes.slice(i, i + 2), 16);
                                if (c > 0) symbol += String.fromCharCode(c);
                            }
                        }
                    } catch (e) { /* fallback */ }
                }

                const decimals = decHex ? Number(BigInt('0x' + decHex.replace('0x', ''))) : 18;

                // Try symbol-based icon fallback
                let icon = SYMBOL_ICONS[symbol] || null;

                // If still no icon, try Trust Wallet assets CDN
                if (!icon) {
                    const chain = EARN_CHAINS[chainId];
                    if (chain && chain.twChain) {
                        // Checksum address for TW CDN (use original addr casing)
                        const twUrl = `https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/${chain.twChain}/assets/${addr}/logo.png`;
                        try {
                            const probe = await fetch(twUrl, { method: 'HEAD' });
                            if (probe.ok) icon = twUrl;
                        } catch (_) { /* ignore */ }
                    }
                }

                const info = { symbol, decimals, icon };
                earn_tokenCache[key] = info;
                return info;
            } catch (e) {
                const info = { symbol: key.slice(0, 6) + '…', decimals: 18, icon: null };
                earn_tokenCache[key] = info;
                return info;
            }
        }

        // Fallback USD price estimates (used when CoinGecko is unavailable)
        const TOKEN_USD_FALLBACK = {
            'WBTC': 95000, 'BTC': 95000,
            'WETH': 2700, 'ETH': 2700, 'wstETH': 3100, 'weETH': 2800, 'rsETH': 2800, 'rETH': 3000, 'cbETH': 2800, 'sfrxETH': 2900,
            'WBERA': 7, 'iBERA': 7, 'BERA': 7,
            'USDC': 1, 'USDT': 1, 'DAI': 1, 'USDC.e': 1, 'USDe': 1, 'BYUSD': 1, 'NECT': 1, 'HONEY': 1, 'sUSDe': 1.05,
            'ARB': 0.5, 'GMX': 25, 'PENDLE': 4, 'LINK': 15, 'UNI': 8,
            'DOLO': 0.01, 'HENLO': 0.00001, 'YEET': 0.001,
        };

        // Fetch USD prices from CoinGecko for token addresses
        let earn_priceCache = {}; // { 'chainId:addr' : usdPrice }
        async function earn_fetchCoinGeckoPrices(tokenAddrs) {
            const chain = earn_getChain();
            const chainId = document.getElementById('earn-chain').value;
            if (!chain.cgPlatform) return; // no CoinGecko support for this chain
            try {
                const addrs = tokenAddrs.map(a => a.toLowerCase()).join(',');
                const url = `https://api.coingecko.com/api/v3/simple/token_price/${chain.cgPlatform}?contract_addresses=${addrs}&vs_currencies=usd`;
                const ctrl = new AbortController();
                const timer = setTimeout(() => ctrl.abort(), 3000); // 3s timeout
                const resp = await fetch(url, { signal: ctrl.signal });
                clearTimeout(timer);
                if (!resp.ok) return;
                const data = await resp.json();
                for (const [addr, priceObj] of Object.entries(data)) {
                    if (priceObj && priceObj.usd) {
                        earn_priceCache[chainId + ':' + addr.toLowerCase()] = priceObj.usd;
                    }
                }
                console.log('CoinGecko prices loaded:', Object.keys(data).length, 'tokens');
            } catch (e) {
                console.warn('CoinGecko price fetch failed, using fallback:', e.message);
            }
        }

        function earn_formatAmount(value, decimals) {
            if (typeof value !== 'bigint') value = BigInt(value);
            const isNeg = value < 0n;
            const abs = isNeg ? -value : value;
            const whole = abs / (10n ** BigInt(decimals));
            const frac = abs % (10n ** BigInt(decimals));
            const fracStr = frac.toString().padStart(decimals, '0');

            // Show all token decimals (trim trailing zeros for clean display)
            let fracDisplay = fracStr.replace(/0+$/, '');

            const wholeStr = whole.toLocaleString('en-US');
            const result = fracDisplay ? `${wholeStr}.${fracDisplay}` : wholeStr;
            return isNeg ? '-' + result : result;
        }

        function earn_showError(msg) {
            const el = document.getElementById('earn-error');
            document.getElementById('earn-error-msg').textContent = msg;
            el.classList.add('visible');
        }

        // Period state
        let earn_currentPeriod = '1';
        let earn_cachedAssets = null;
        let earn_sortKey = 'balance'; // 'balance' or 'yield'
        let earn_sortDesc = true; // true = descending (largest first)
        let earn_marketRates = {}; // { marketId: { supplyRatePerSec: number } }

        // Compute yield BigInt for a single asset (used for sort comparison)
        function earn_getYieldForAsset(a) {
            const mid = String(a.marketId);
            // Method 1: NetFlow-based (exact)
            const hasNetflow = earn_netflowData && earn_netflowData[mid] !== undefined;
            if (hasNetflow) {
                const flowData = earn_netflowData[mid];
                const netFlow = typeof flowData === 'string' ? BigInt(flowData) : BigInt(flowData.t || '0');
                return a.wei - netFlow;
            }
            // Method 2: Snapshot-based
            const hist = earn_totalYieldData && earn_totalYieldData[mid];
            if (hist && hist.cumulativeYield !== undefined) {
                let totalYield = BigInt(hist.cumulativeYield);
                const lastPar = BigInt(hist.lastPar);
                const lastWei = BigInt(hist.lastWei);
                if (a.par !== 0n && lastPar !== 0n) {
                    totalYield += (lastPar * a.wei - lastWei * a.par) / a.par;
                }
                return totalYield;
            }
            return 0n;
        }

        // Sort assets and re-render
        function earn_sortAssets(key) {
            if (!earn_cachedAssets || earn_cachedAssets.length === 0) return;
            if (earn_sortKey === key) {
                earn_sortDesc = !earn_sortDesc; // toggle direction
            } else {
                earn_sortKey = key;
                earn_sortDesc = true; // default descending for new column
            }

            // Update header UI
            document.querySelectorAll('.earn-asset-table thead th[data-sort]').forEach(th => {
                th.classList.toggle('sort-active', th.dataset.sort === earn_sortKey);
                const arrow = th.querySelector('.earn-sort-arrow');
                if (arrow) arrow.textContent = (th.dataset.sort === earn_sortKey && !earn_sortDesc) ? '\u25b2' : '\u25bc';
            });

            // Sort
            if (key === 'balance') {
                earn_cachedAssets.sort((a, b) => {
                    const diff = a.usdValue - b.usdValue;
                    return earn_sortDesc ? -diff : diff;
                });
            } else if (key === 'yield') {
                earn_cachedAssets.sort((a, b) => {
                    const ya = earn_getYieldForAsset(a);
                    const yb = earn_getYieldForAsset(b);
                    // Compare yield in USD: yield * price
                    const cgKeyA = document.getElementById('earn-chain').value + ':' + a.tokenAddr.toLowerCase();
                    const cgKeyB = document.getElementById('earn-chain').value + ':' + b.tokenAddr.toLowerCase();
                    const priceA = earn_priceCache[cgKeyA] || TOKEN_USD_FALLBACK[a.symbol] || 0.01;
                    const priceB = earn_priceCache[cgKeyB] || TOKEN_USD_FALLBACK[b.symbol] || 0.01;
                    const yieldUsdA = Number(ya) / Math.pow(10, a.decimals) * priceA;
                    const yieldUsdB = Number(yb) / Math.pow(10, b.decimals) * priceB;
                    const diff = yieldUsdA - yieldUsdB;
                    return earn_sortDesc ? -diff : diff;
                });
            }

            earn_renderResults(earn_cachedAssets);
        }

        // Historical snapshot cache: { '2026-02-11': { snapshots: { arbitrum: { ... } } } }
        const earn_snapshotCache = {};
        let earn_historicalData = null; // current period's historical data for the looked-up address
        let earn_totalYieldData = null; // oldest snapshot data for total yield (never changes after initial load)
        let earn_totalYieldDays = 0; // number of days the total yield spans

        const SNAPSHOT_BASE = 'https://twojekrypto.github.io/vedolo-dashboard/data/earn-snapshots';
        const NETFLOW_BASE = 'https://twojekrypto.github.io/vedolo-dashboard/data/earn-netflow';
        let earn_netflowData = null; // { marketId: netFlowWei (string) } for current address+chain

        // Snapshot manifest: { dates: [...], chains: { date: [chains] } }
        let earn_snapshotManifest = null;
        let earn_customSnapshotDate = null; // date string for custom selection

        async function earn_loadManifest() {
            try {
                const resp = await fetch(`${SNAPSHOT_BASE}/manifest.json`);
                if (!resp.ok) return;
                earn_snapshotManifest = await resp.json();
                earn_buildPeriodButtons();
                console.log('Snapshot manifest loaded:', earn_snapshotManifest.dates.length, 'dates');
            } catch (e) {
                console.warn('Failed to load snapshot manifest:', e);
            }
        }

        // Build period buttons dynamically from manifest (no-op if period bar removed)
        function earn_buildPeriodButtons() {
            if (!earn_snapshotManifest) return;
            const bar = document.getElementById('earn-period-bar');
            if (!bar) return;

            // Remove any previously generated dynamic buttons
            bar.querySelectorAll('.earn-period-btn[data-generated]').forEach(b => b.remove());

            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);

            // Smart period shortcuts — find closest available snapshot for each target
            const targets = [1, 3, 7, 14, 21, 28];
            const availDates = earn_snapshotManifest.dates
                .filter(d => d !== today.toISOString().slice(0, 10))
                .sort();

            targets.forEach(targetDays => {
                const targetDate = new Date(today);
                targetDate.setUTCDate(targetDate.getUTCDate() - targetDays);
                const targetStr = targetDate.toISOString().slice(0, 10);

                // Find closest available snapshot (prefer exact, then ±1 day)
                let bestDate = null;
                let bestDiff = Infinity;
                availDates.forEach(d => {
                    const diff = Math.abs(Math.round((new Date(d + 'T00:00:00Z') - targetDate) / 86400000));
                    if (diff < bestDiff && diff <= 1) {
                        bestDiff = diff;
                        bestDate = d;
                    }
                });

                if (!bestDate) return;

                const snapshotDate = new Date(bestDate + 'T00:00:00Z');
                const actualDays = Math.round((today - snapshotDate) / 86400000);
                if (actualDays < 1) return;

                const btn = document.createElement('button');
                btn.className = 'earn-period-btn';
                // Mark 1D as active by default
                if (targetDays === 1) btn.classList.add('active');
                btn.dataset.period = String(actualDays);
                btn.dataset.snapshotDate = bestDate;
                btn.dataset.generated = 'true';
                btn.textContent = targetDays + 'D';
                btn.onclick = () => earn_setPeriod(String(actualDays), bestDate);

                bar.appendChild(btn);
            });
        }


        async function earn_fetchSnapshot(dateStr) {
            if (earn_snapshotCache[dateStr]) return earn_snapshotCache[dateStr];
            try {
                const resp = await fetch(`${SNAPSHOT_BASE}/${dateStr}.json`);
                if (!resp.ok) return null;
                const data = await resp.json();
                earn_snapshotCache[dateStr] = data;
                return data;
            } catch (e) {
                console.warn('Snapshot fetch failed for', dateStr, e);
                return null;
            }
        }

        // Get historical market data for a specific address from a snapshot
        function earn_getHistoricalMarkets(snapshot, chainId, address) {
            if (!snapshot || !snapshot.snapshots) return null;
            const chainData = snapshot.snapshots[chainId];
            if (!chainData) return null;
            // Try exact match (lowercase)
            const addrLower = address.toLowerCase();
            return chainData[addrLower] ? chainData[addrLower].markets : null;
        }

        // Compute cumulative yield using index-based pairwise method
        // For consecutive snapshots: yield = (par_prev × wei_curr - wei_prev × par_curr) / par_curr
        // This correctly isolates yield from swaps/trades/deposits/withdrawals
        async function earn_fetchTotalYield() {
            earn_totalYieldData = {};
            earn_totalYieldDays = 0;
            if (!earn_snapshotManifest) return;

            const chainId = document.getElementById('earn-chain').value;
            const addr = document.getElementById('earn-address').value.trim();
            const sortedDates = [...earn_snapshotManifest.dates].sort(); // oldest first
            const chainDates = sortedDates.filter(d => {
                const chains = earn_snapshotManifest.chains[d] || [];
                return !chainId || chains.includes(chainId);
            });

            const yieldHeader = document.getElementById('earn-total-yield-header');
            if (yieldHeader) yieldHeader.textContent = 'Loading...';

            const today = new Date();
            today.setUTCHours(0, 0, 0, 0);

            // Get all market IDs from current assets
            const neededMarkets = new Set(
                (earn_cachedAssets || []).map(a => String(a.marketId))
            );

            // Collect ALL snapshots with user data per market
            const marketHistory = {};
            for (const mid of neededMarkets) marketHistory[mid] = [];

            for (let i = 0; i < chainDates.length; i++) {
                const dateStr = chainDates[i];
                const snapshot = await earn_fetchSnapshot(dateStr);
                if (!snapshot) continue;
                const markets = earn_getHistoricalMarkets(snapshot, chainId, addr);
                if (!markets) continue;

                for (const mid of neededMarkets) {
                    if (markets[mid]) {
                        marketHistory[mid].push({
                            date: dateStr,
                            par: BigInt(markets[mid].par),
                            wei: BigInt(markets[mid].wei),
                        });
                    }
                }
            }

            // Compute pairwise index-based yield per market
            let marketsWithData = 0;
            for (const mid of neededMarkets) {
                const history = marketHistory[mid];
                if (history.length < 1) continue;

                let cumulativeYield = 0n;
                for (let i = 1; i < history.length; i++) {
                    const prev = history[i - 1];
                    const curr = history[i];
                    // Skip if par is zero (edge case)
                    if (curr.par === 0n || prev.par === 0n) continue;
                    // yield = (par_prev * wei_curr - wei_prev * par_curr) / par_curr
                    const dailyYield = (prev.par * curr.wei - prev.wei * curr.par) / curr.par;
                    cumulativeYield += dailyYield;
                }

                const first = history[0];
                const last = history[history.length - 1];
                const sd = new Date(first.date + 'T00:00:00Z');
                const days = Math.max(1, Math.round((today - sd) / 86400000));

                earn_totalYieldData[mid] = {
                    cumulativeYield: cumulativeYield.toString(),
                    days: days,
                    firstDate: first.date,
                    lastPar: last.par.toString(),
                    lastWei: last.wei.toString(),
                };
                marketsWithData++;
            }

            if (marketsWithData > 0) {
                if (yieldHeader) yieldHeader.textContent = 'Total Yield ✓';
                console.log('Total yield: computed index-based yield for', marketsWithData, 'markets');
            } else {
                if (yieldHeader) yieldHeader.textContent = 'Total Yield';
            }
        }

        // Fetch netflow data (net deposits/withdrawals from on-chain events)
        // yield = currentWei - netFlow → 100% accurate from first deposit
        async function earn_fetchNetflow() {
            earn_netflowData = null;
            const chainId = document.getElementById('earn-chain').value;
            const addr = document.getElementById('earn-address').value.trim().toLowerCase();
            if (!chainId || !addr) return;

            try {
                const resp = await fetch(`${NETFLOW_BASE}/${chainId}.json`);
                if (!resp.ok) return;
                const data = await resp.json();
                const addrFlows = data.netflows && data.netflows[addr];
                if (addrFlows) {
                    // New format: { "2": {"t":"...","d":"...","w":"...",...} }
                    // Old format: { "2": "12345" }
                    earn_netflowData = addrFlows;
                    console.log('NetFlow data loaded for', addr, 'on', chainId, '—', Object.keys(addrFlows).length, 'markets');
                } else {
                    console.log('No netflow data found for', addr, 'on', chainId);
                }
            } catch (e) {
                console.warn('NetFlow fetch failed:', e.message);
            }
        }

        async function earn_setPeriod(p, snapshotDateOverride) {
            earn_currentPeriod = p;
            // Update active button
            document.querySelectorAll('.earn-period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === p);
            });

            // Reset custom date when switching to a non-custom period
            if (p !== 'custom') {
                earn_customSnapshotDate = snapshotDateOverride || null;
            }

            // Try to fetch historical snapshot for periods with real data
            earn_historicalData = null;
            let hasRealData = false;
            let periodDays = Number(p);

            // Determine which snapshot date to fetch
            let dateStr = null;
            if (p === 'custom' && earn_customSnapshotDate) {
                dateStr = earn_customSnapshotDate;
                const today = new Date();
                today.setUTCHours(0, 0, 0, 0);
                const sd = new Date(earn_customSnapshotDate + 'T00:00:00Z');
                periodDays = Math.round((today - sd) / 86400000);
            } else if (p !== 'all' && snapshotDateOverride) {
                dateStr = snapshotDateOverride;
            } else if (p !== 'all' && periodDays > 0) {
                // Find the matching snapshot date from manifest
                const today = new Date();
                today.setUTCHours(0, 0, 0, 0);
                const target = new Date(today);
                target.setUTCDate(target.getUTCDate() - periodDays);
                dateStr = target.toISOString().slice(0, 10);
            }

            if (dateStr && earn_cachedAssets) {
                const chainId = document.getElementById('earn-chain').value;
                const addr = document.getElementById('earn-address').value.trim();

                // Show loading state on header
                const yh = document.getElementById('earn-yield-header');
                if (yh) yh.textContent = 'Loading...';

                const snapshot = await earn_fetchSnapshot(dateStr);
                if (snapshot) {
                    const markets = earn_getHistoricalMarkets(snapshot, chainId, addr);
                    if (markets) {
                        earn_historicalData = markets;
                        hasRealData = true;
                    }
                }
            }

            // Update header label
            const yh2 = document.getElementById('earn-yield-header');
            if (hasRealData) {
                if (yh2) yh2.textContent = periodDays + 'D Yield ✓';
            } else {
                if (yh2) yh2.textContent = periodDays + 'D Yield';
            }

            // Re-render if we have cached data
            if (earn_cachedAssets) earn_renderResults(earn_cachedAssets);
        }

        // Calendar state
        let earn_calMonth = new Date().getUTCMonth();
        let earn_calYear = new Date().getUTCFullYear();

        function earn_openCustomDate() {
            // Start calendar on current month
            const now = new Date();
            earn_calMonth = now.getUTCMonth();
            earn_calYear = now.getUTCFullYear();
            earn_calRender();
            document.getElementById('earn-custom-date-overlay').classList.add('visible');
        }

        function earn_closeCustomDate() {
            document.getElementById('earn-custom-date-overlay').classList.remove('visible');
        }

        function earn_calNavigate(dir) {
            earn_calMonth += dir;
            if (earn_calMonth < 0) { earn_calMonth = 11; earn_calYear--; }
            if (earn_calMonth > 11) { earn_calMonth = 0; earn_calYear++; }
            earn_calRender();
        }

        function earn_calRender() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('earn-cal-month-label').textContent =
                monthNames[earn_calMonth] + ' ' + earn_calYear;

            const grid = document.getElementById('earn-cal-grid');
            grid.innerHTML = '';

            const chainId = document.getElementById('earn-chain') ?
                document.getElementById('earn-chain').value : '';

            // Build set of available dates for this chain
            const availableDates = new Set();
            if (earn_snapshotManifest) {
                earn_snapshotManifest.dates.forEach(d => {
                    const chains = earn_snapshotManifest.chains[d] || [];
                    if (!chainId || chains.includes(chainId)) {
                        availableDates.add(d);
                    }
                });
            }

            // Today (UTC)
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);

            // First day of month (Monday-based: 0=Mon, 6=Sun)
            const firstDay = new Date(Date.UTC(earn_calYear, earn_calMonth, 1));
            let startDay = firstDay.getUTCDay() - 1; // JS: 0=Sun → we want Mon=0
            if (startDay < 0) startDay = 6;

            const daysInMonth = new Date(Date.UTC(earn_calYear, earn_calMonth + 1, 0)).getUTCDate();

            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'earn-cal-day empty';
                grid.appendChild(cell);
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${earn_calYear}-${String(earn_calMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'earn-cal-day';
                cell.textContent = day;

                const isToday = dateStr === todayStr;
                const isFuture = dateStr > todayStr;
                const isAvailable = availableDates.has(dateStr) && !isFuture && !isToday;
                const isSelected = dateStr === earn_customSnapshotDate;

                if (isToday) cell.classList.add('today');
                if (isFuture) cell.classList.add('future');
                if (isAvailable) {
                    cell.classList.add('available');
                    if (isSelected) cell.classList.add('selected');
                    cell.onclick = () => earn_calSelectDate(dateStr);
                }

                grid.appendChild(cell);
            }
        }

        function earn_calSelectDate(dateStr) {
            earn_customSnapshotDate = dateStr;
            earn_closeCustomDate();

            // Set custom period with this date
            earn_currentPeriod = 'custom';
            document.querySelectorAll('.earn-period-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.period === 'custom');
            });
            earn_setPeriod('custom');
        }


        // Load manifest on DOM ready
        earn_loadManifest();

        function earn_hideAll() {
            document.getElementById('earn-error').classList.remove('visible');
            document.getElementById('earn-empty').classList.remove('visible');
            document.getElementById('earn-results').classList.remove('visible');
        }

        async function earn_lookup() {
            const addr = document.getElementById('earn-address').value.trim();
            const accountNum = document.getElementById('earn-account-num').value;
            const btn = document.getElementById('earn-search-btn');

            // Validate address
            if (!addr || !/^0x[a-fA-F0-9]{40}$/.test(addr)) {
                earn_hideAll();
                earn_showError('Please enter a valid Ethereum/Berachain address (0x...)');
                return;
            }

            earn_hideAll();
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                const chain = earn_getChain();
                if (chain.pending) {
                    earn_showError(chain.name + ' is not yet live on Dolomite. Check back soon!');
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    return;
                }
                const selector = '0x6a8194e7';
                const calldata = selector + earn_padAddr(addr) + earn_padUint(accountNum);

                const result = await earn_rpcCall(chain.margin, calldata);
                const resultLen = result ? result.length : 0;

                let balances;
                try {
                    balances = earn_decodeBalances(result);
                } catch (decodeErr) {
                    earn_showError('Decode error: ' + decodeErr.message + ' | RPC returned ' + resultLen + ' chars');
                    return;
                }

                if (balances.length === 0) {
                    const emptyMsg = document.getElementById('earn-empty-msg');
                    if (resultLen <= 2) {
                        emptyMsg.textContent = 'RPC returned empty — this address has no deposits on Dolomite';
                    } else {
                        emptyMsg.textContent = 'This address has no active deposits on Dolomite';
                    }
                    document.getElementById('earn-empty').classList.add('visible');
                    return;
                }

                // Start parallel fetches: netflow, CoinGecko prices, total yield
                const netflowPromise = earn_fetchNetflow();
                const pricesPromise = earn_fetchCoinGeckoPrices(balances.map(b => b.tokenAddr));
                const chainId = document.getElementById('earn-chain').value;
                const batchCalls = [];
                const batchMap = []; // tracks what each call is for

                balances.forEach((b, i) => {
                    const key = chainId + ':' + b.tokenAddr.toLowerCase();
                    const cached = earn_tokenCache[key] || KNOWN_TOKENS[key];
                    if (!cached) {
                        // Need symbol + decimals
                        batchCalls.push({ to: b.tokenAddr, data: '0x95d89b41' }); // symbol()
                        batchMap.push({ type: 'symbol', idx: i });
                        batchCalls.push({ to: b.tokenAddr, data: '0x313ce567' }); // decimals()
                        batchMap.push({ type: 'decimals', idx: i });
                    }
                });

                // Single batch RPC call for all token info
                const batchResults = batchCalls.length > 0 ? await earn_rpcBatch(batchCalls) : [];

                // Parse batch results
                const tokenRaw = balances.map(() => ({ symHex: null, decHex: null }));
                batchMap.forEach((m, i) => {
                    const r = batchResults[i];
                    if (m.type === 'symbol') tokenRaw[m.idx].symHex = r;
                    else if (m.type === 'decimals') tokenRaw[m.idx].decHex = r;
                });

                // No DeFiLlama APY fetch — we only show real historical data
                earn_marketRates = {};

                // Enrich with token info + USD value (use fallback prices for instant render)
                const enriched = balances.map((b, i) => {
                    const key = chainId + ':' + b.tokenAddr.toLowerCase();
                    let info = earn_tokenCache[key];
                    if (!info && KNOWN_TOKENS[key]) {
                        info = { ...KNOWN_TOKENS[key] };
                        if (!info.icon && info.symbol) info.icon = SYMBOL_ICONS[info.symbol] || SYMBOL_ICONS[info.symbol.toUpperCase()] || null;
                        earn_tokenCache[key] = info;
                    }
                    if (!info) {
                        // Parse from batch results
                        let symbol = 'UNK';
                        const symHex = tokenRaw[i].symHex;
                        if (symHex && symHex.length > 2) {
                            try {
                                const raw = symHex.replace('0x', '');
                                if (raw.length === 64 * 1) {
                                    const bytes = [];
                                    for (let j = 0; j < 64; j += 2) {
                                        const byte = parseInt(raw.substr(j, 2), 16);
                                        if (byte > 0) bytes.push(byte);
                                    }
                                    symbol = String.fromCharCode(...bytes);
                                } else {
                                    const offsetIdx = parseInt(raw.slice(0, 64), 16) * 2;
                                    const len = parseInt(raw.slice(64, 128), 16);
                                    const hex = raw.slice(128, 128 + len * 2);
                                    const bytes = [];
                                    for (let j = 0; j < hex.length; j += 2) {
                                        bytes.push(parseInt(hex.substr(j, 2), 16));
                                    }
                                    symbol = String.fromCharCode(...bytes);
                                }
                            } catch (e) { /* fallback */ }
                        }
                        const decHex = tokenRaw[i].decHex;
                        const decimals = decHex ? Number(BigInt('0x' + decHex.replace('0x', ''))) : 18;
                        // Icon: direct lookup, PT-/GM- prefix match, or generate SVG fallback
                        let icon = SYMBOL_ICONS[symbol] || SYMBOL_ICONS[symbol.toUpperCase()];
                        if (!icon && symbol.startsWith('PT-')) icon = SYMBOL_ICONS['PENDLE'];
                        if (!icon && symbol.startsWith('GM:')) icon = SYMBOL_ICONS['GM'];
                        if (!icon) {
                            // Generate colored circle SVG with first letter
                            const ch = (symbol[0] || '?').toUpperCase();
                            const hue = [...symbol].reduce((h, c) => (h + c.charCodeAt(0) * 37) % 360, 0);
                            icon = `data:image/svg+xml,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='hsl(${hue},50%,35%)'/><text x='16' y='22' text-anchor='middle' font-size='16' font-weight='bold' fill='white'>${ch}</text></svg>`)}`;
                        }
                        info = { symbol, decimals, icon };
                        earn_tokenCache[key] = info;
                    }

                    // USD value: use fallback prices for now (CoinGecko may still be loading)
                    const cgKey = chainId + ':' + b.tokenAddr.toLowerCase();
                    const priceUsd = earn_priceCache[cgKey] || TOKEN_USD_FALLBACK[info.symbol] || 0.01;
                    const humanAmt = Number(b.wei) / Math.pow(10, info.decimals);
                    const usdValue = humanAmt * priceUsd;
                    return {
                        ...b,
                        symbol: info.symbol,
                        decimals: info.decimals,
                        icon: info.icon,
                        usdValue,
                    };
                });

                earn_cachedAssets = enriched;

                // Await netflow + prices so yield data is visible on first render
                await Promise.all([pricesPromise, netflowPromise]);

                // Re-compute USD values with CoinGecko real prices
                enriched.forEach(a => {
                    const cgKey = chainId + ':' + a.tokenAddr.toLowerCase();
                    const realPrice = earn_priceCache[cgKey];
                    if (realPrice) {
                        const humanAmt = Number(a.wei) / Math.pow(10, a.decimals);
                        a.usdValue = humanAmt * realPrice;
                    }
                });

                // Sort by USD value and render with real yield + prices
                enriched.sort((a, b) => b.usdValue - a.usdValue);
                earn_renderResults(enriched);

                // Background: fetch snapshot-based total yield (slower fallback) → re-render
                earn_fetchTotalYield().then(() => {
                    earn_renderResults(enriched);
                }).catch(e => console.warn('Total yield background load:', e));
            } catch (e) {
                console.error('EARN lookup error:', e, e.stack);
                earn_showError('Failed to fetch data from RPC. Please try again.');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // ---- Detail row helpers ----
        function earn_toggleDetail(idx) {
            const detail = document.getElementById('earn-detail-' + idx);
            const dataRow = document.getElementById('earn-row-' + idx);
            if (!detail || !dataRow) return;
            const isOpen = detail.classList.toggle('open');
            dataRow.classList.toggle('expanded', isOpen);
        }

        function earn_copyAddr(addr, el) {
            navigator.clipboard.writeText(addr);
            const t = document.getElementById('copy-toast');
            if (t) { t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1500); }
            if (el) { el.classList.add('copied'); setTimeout(() => el.classList.remove('copied'), 1500); }
        }

        // Build source breakdown HTML for the detail row
        const FLOW_TYPES = [
            { key: 'd', label: 'Deposits', cls: 'earn-seg-d' },
            { key: 'w', label: 'Withdrawals', cls: 'earn-seg-w' },
            { key: 's', label: 'Swaps', cls: 'earn-seg-s' },
            { key: 'x', label: 'Transfers', cls: 'earn-seg-x' },
            { key: 'l', label: 'Liquidations', cls: 'earn-seg-l' },
        ];

        function earn_buildBreakdown(mid, decimals, symbol) {
            if (!earn_netflowData || !earn_netflowData[mid]) return '';
            const fd = earn_netflowData[mid];
            if (typeof fd === 'string') return ''; // old format, no breakdown

            // Collect absolute values for bar proportions
            const entries = [];
            let absSum = 0n;
            for (const ft of FLOW_TYPES) {
                const raw = fd[ft.key];
                if (!raw || raw === '0') continue;
                const val = BigInt(raw);
                const abs = val < 0n ? -val : val;
                entries.push({ ...ft, val, abs });
                absSum += abs;
            }
            if (entries.length === 0) return '';

            // Bar segments
            let barHtml = '';
            for (const e of entries) {
                const pct = absSum > 0n ? Number(e.abs * 10000n / absSum) / 100 : 0;
                barHtml += `<div class="earn-breakdown-seg ${e.cls}" style="width:${pct}%"></div>`;
            }

            // Label items
            let itemsHtml = '';
            for (const e of entries) {
                const sign = e.val > 0n ? '+' : '';
                const fmt = earn_formatAmount(e.val, decimals);
                itemsHtml += `<div class="earn-breakdown-item">
                    <span class="earn-breakdown-dot ${e.cls}"></span>
                    <span class="earn-breakdown-label">${e.label}</span>
                    <span class="earn-breakdown-val">${sign}${fmt}</span>
                </div>`;
            }

            return `<div class="earn-breakdown">
                <div class="earn-breakdown-title">Asset sources</div>
                <div class="earn-breakdown-bar">${barHtml}</div>
                <div class="earn-breakdown-items">${itemsHtml}</div>
            </div>`;
        }

        function earn_renderResults(assets) {
            // Get current chain explorer
            const chain = earn_getChain();
            const explorerBase = chain.explorer || 'https://etherscan.io';

            // Build table rows
            const tbody = document.getElementById('earn-table-body');
            let html = '';

            assets.forEach((a, idx) => {
                // Total yield calculation — prefer netflow (exact) over snapshot-based
                const mid = String(a.marketId);
                let yieldCellHtml;

                // Method 1: NetFlow-based (exact: yield = currentWei - netFlow)
                const hasNetflow = earn_netflowData && earn_netflowData[mid] !== undefined;
                // Method 2: Snapshot-based (pairwise index-based)
                const hist = earn_totalYieldData && earn_totalYieldData[mid];
                const hasSnapshotData = hist && hist.cumulativeYield !== undefined;

                if (hasNetflow) {
                    const flowData = earn_netflowData[mid];
                    const netFlow = typeof flowData === 'string' ? BigInt(flowData) : BigInt(flowData.t || '0');
                    const totalYield = a.wei - netFlow;
                    const yieldPositive = totalYield >= 0n;
                    const yieldSign = yieldPositive && totalYield > 0n ? '+' : '';
                    const yieldColor = yieldPositive ? 'earn-yield-positive' : 'earn-yield-negative';
                    const yieldFmt = earn_formatAmount(totalYield, a.decimals);
                    yieldCellHtml = `<span class="earn-amount ${yieldColor}">${yieldSign + yieldFmt}<span class="earn-amount-sym">${a.symbol}</span></span>`;
                } else if (hasSnapshotData) {
                    let totalYield = BigInt(hist.cumulativeYield);

                    // Add live yield from last snapshot → current RPC data
                    const lastPar = BigInt(hist.lastPar);
                    const lastWei = BigInt(hist.lastWei);
                    if (a.par !== 0n && lastPar !== 0n) {
                        const liveYield = (lastPar * a.wei - lastWei * a.par) / a.par;
                        totalYield += liveYield;
                    }

                    const yieldPositive = totalYield >= 0n;
                    const yieldSign = yieldPositive && totalYield > 0n ? '+' : '';
                    const yieldColor = yieldPositive ? 'earn-yield-positive' : 'earn-yield-negative';
                    const yieldFmt = earn_formatAmount(totalYield, a.decimals);
                    yieldCellHtml = `<span class="earn-amount ${yieldColor}">${yieldSign + yieldFmt}<span class="earn-amount-sym">${a.symbol}</span></span>`;
                } else {
                    yieldCellHtml = `<span class="earn-amount" style="color:var(--text-muted)">—</span>`;
                }

                const weiFmt = earn_formatAmount(a.wei, a.decimals);

                // Icon
                let iconHtml;
                if (a.icon) {
                    iconHtml = `<div class="earn-token-icon"><img src="${a.icon}" alt="${a.symbol}" onerror="this.parentElement.textContent='${a.symbol.slice(0, 2)}'"></div>`;
                } else {
                    iconHtml = `<div class="earn-token-icon">${a.symbol.slice(0, 2)}</div>`;
                }

                // Chevron SVG
                const chevron = `<svg class="earn-row-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>`;

                // Staggered animation delay
                const delay = idx * 0.08;

                // Explorer link
                const explorerUrl = `${explorerBase}/address/${a.tokenAddr}`;

                // Main data row
                html += `<tr class="earn-data-row" id="earn-row-${idx}" style="animation-delay:${delay}s" onclick="earn_toggleDetail(${idx})">
                    <td>
                        <div class="earn-token-cell">
                            <div class="earn-token-left">
                                ${iconHtml}
                                <div class="earn-token-info">
                                    <div class="earn-token-name">${a.symbol} ${chevron}</div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td><span class="earn-amount earn-amount-primary">${weiFmt}<span class="earn-amount-sym">${a.symbol}</span></span></td>
                    <td>
                        ${yieldCellHtml}
                    </td>
                </tr>`;

                // Expandable detail row — simple inline CA
                const breakdownHtml = earn_buildBreakdown(mid, a.decimals, a.symbol);
                html += `<tr class="earn-detail-row" id="earn-detail-${idx}">
                    <td colspan="3">
                        <div class="earn-ca-line">
                            <span class="earn-ca-addr" onclick="event.stopPropagation(); earn_copyAddr('${a.tokenAddr}', this)" title="Click to copy">${a.tokenAddr}</span>
                            <span class="copy-addr-icon" onclick="event.stopPropagation(); earn_copyAddr('${a.tokenAddr}', this)" title="Copy address"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></span>
                            <a class="earn-ca-explorer" href="${explorerUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="View on explorer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>
                        </div>
                        ${breakdownHtml}
                    </td>
                </tr>`;
            });

            tbody.innerHTML = html;

            // Show results
            document.getElementById('earn-results').classList.add('visible');
        }

        // Enter key to search
        document.getElementById('earn-address').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') earn_lookup();
        });

        // Eagerly preload ALL tab data in parallel for instant tab switching
        loadData();      // veDOLO holders
        dolo_init();     // DOLO price + TVL (now only 67KB!)
        odolo_init();    // oDOLO contract data (static JSON first)
        doloLoaded = true;
        odoloLoaded = true;
    </script>
    <div class="expiry-tooltip" id="expiry-tooltip"></div>
</body>

</html>